!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("SNLibrary",[],t):"object"==typeof exports?exports.SNLibrary=t():e.SNLibrary=t()}(window,(function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/dist/",n(n.s=195)}([function(e,t,n){"use strict";e.exports=n(81)},function(e,t,n){"use strict";(function(e){n.d(t,"m",(function(){return S})),n.d(t,"i",(function(){return x})),n.d(t,"t",(function(){return O})),n.d(t,"r",(function(){return P})),n.d(t,"l",(function(){return j})),n.d(t,"D",(function(){return D})),n.d(t,"f",(function(){return C})),n.d(t,"q",(function(){return I})),n.d(t,"o",(function(){return _})),n.d(t,"p",(function(){return R})),n.d(t,"s",(function(){return E})),n.d(t,"n",(function(){return A})),n.d(t,"J",(function(){return M})),n.d(t,"K",(function(){return T})),n.d(t,"w",(function(){return K})),n.d(t,"j",(function(){return F})),n.d(t,"G",(function(){return L})),n.d(t,"B",(function(){return V})),n.d(t,"b",(function(){return N})),n.d(t,"k",(function(){return U})),n.d(t,"c",(function(){return W})),n.d(t,"e",(function(){return B})),n.d(t,"C",(function(){return H})),n.d(t,"d",(function(){return z})),n.d(t,"x",(function(){return q})),n.d(t,"F",(function(){return J})),n.d(t,"H",(function(){return G})),n.d(t,"v",(function(){return $})),n.d(t,"z",(function(){return Q})),n.d(t,"y",(function(){return Y})),n.d(t,"u",(function(){return X})),n.d(t,"a",(function(){return Z})),n.d(t,"h",(function(){return ee})),n.d(t,"A",(function(){return te})),n.d(t,"g",(function(){return ne})),n.d(t,"I",(function(){return re})),n.d(t,"E",(function(){return ae}));var r=n(0),a=n.n(r),o=n(20),i=n.n(o),s=n(18),c=n.n(s),u=n(16),l=n.n(u),f=n(79),p=n.n(f),y=n(80),h=n.n(y),d=n(23),v=n.n(d);function m(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function b(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){m(o,r,a,i,s,"next",e)}function s(e){m(o,r,a,i,s,"throw",e)}i(void 0)}))}}function g(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return w(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return w(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function k(e){return(k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function S(){return"undefined"!=typeof window?window:void 0!==e?e:null}function x(e){return Object.keys(e).map((function(t){return e[t]}))}function O(){return null!==S()&&!P()&&!(document&&document.documentMode)||/Edge/.test(navigator.userAgent)&&window.crypto&&!!window.crypto.subtle}function P(){return"undefined"!=typeof navigator&&"ReactNative"===navigator.product}function j(e,t,n){return e.find((function(e){return e[t]===n}))}function D(e,t){return c()(e,t)}function C(){for(var e=[],t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(var a=0,o=n;a<o.length;a++){var i=o[a];e=e.concat(i)}return e}function I(e){return null!==e&&("function"==typeof e||"object"===k(e))}function _(e){return null!==e&&"function"==typeof e}function R(e){return null==e}function E(e){return"string"==typeof e||e instanceof String}function A(e,t){return e>t?e:t}function M(e,t,n){return h()(e.concat(t),(function(e,t){var r,a=g(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;if(e[o]!==t[o])return!1}}catch(e){a.e(e)}finally{a.f()}return!0}))}function T(e){return v()(e)}function K(e){return e[e.length-1]}function F(e,t){var n,r=g(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;e.push(a)}}catch(e){r.e(e)}finally{r.f()}}function L(e,t){var n,r=g(t);try{for(r.s();!(n=r.n()).done;){V(e,n.value)}}catch(e){r.e(e)}finally{r.f()}}function V(e,t){var n=e.indexOf(t);-1!==n&&e.splice(n,1)}function N(e,t){return!e.includes(t)&&(e.push(t),!0)}function U(e,t){i()(e,t)}function W(e,t){return e.filter((function(e){return!t.includes(e)})).concat(t.filter((function(t){return!e.includes(t)})))}function B(e,t){return!(e&&!t||!e&&t)&&(e instanceof Date&&t instanceof Date?e.getTime()===t.getTime():e instanceof String&&t instanceof String?e===t:G(e,t))}function H(e,t){e.splice(t,1)}function z(e,t){var n=e.slice();return H(n,t),n}function q(e){for(var t=[],n=0,r=Object.keys(e);n<r.length;n++){var a=r[n];t.push(e[a])}return t}function J(e){var t,n={},r=g(Object.keys(e).sort());try{for(r.s();!(t=r.n()).done;){var a=t.value;n[a]=e[a]}}catch(e){r.e(e)}finally{r.f()}return Z(n)}function G(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var a=0,o=n;a<o.length;a++){var i=o[a];if(e[i]!==t[i])return!1}return!0}function $(e){for(var t={},n=0,r=Object.keys(e);n<r.length;n++){var a=r[n],o=void 0;try{o=JSON.parse(e[a])}catch(t){o=e[a]}t[a]=o}return t}function Q(e,t){if(e){var n,r=g(t);try{for(r.s();!(n=r.n()).done;){delete e[n.value]}}catch(e){r.e(e)}finally{r.f()}}}function Y(e,t){var n,r=Object.assign({},e),a=g(t);try{for(a.s();!(n=a.n()).done;){delete r[n.value]}}catch(e){a.e(e)}finally{a.f()}return r}function X(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map((function(e,t){return 0===t?e.trim().replace(/[\/]*$/g,""):e.trim().replace(/(^[\/]*|[\/]*$)/g,"")})).filter((function(e){return e.length})).join("/")}function Z(e){return e instanceof Date?new Date(e):I(e)?JSON.parse(JSON.stringify(e)):e}function ee(e,t){if(!e||!t)throw"Attempting to deepMerge with null values";return p()(e,t,(function(e,t){if(l()(e))return t})),e}function te(e,t){var n,r={},a=g(t);try{for(a.s();!(n=a.n()).done;){var o=n.value;r[o]=e[o]}}catch(e){a.e(e)}finally{a.f()}return Z(r)}function ne(e){var t,n=g(Object.getOwnPropertyNames(e));try{for(n.s();!(t=n.n()).done;){var r=t.value,a=e[r];a&&"object"===k(a)&&!Object.isFrozen(a)?e[r]=ne(a):e[r]=a}}catch(e){n.e(e)}finally{n.f()}return Object.freeze(e)}function re(e,t){var n=t/4;return e.substring(0,n)}function ae(e){return oe.apply(this,arguments)}function oe(){return(oe=b(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.warn("Sleeping for",t),e.abrupt("return",new Promise((function(e,n){setTimeout((function(){e()}),t)})));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this,n(30))},function(e,t,n){"use strict";n.d(t,"e",(function(){return g})),n.d(t,"g",(function(){return w})),n.d(t,"d",(function(){return k})),n.d(t,"f",(function(){return S})),n.d(t,"b",(function(){return x})),n.d(t,"c",(function(){return P})),n.d(t,"a",(function(){return j}));var r=n(28),a=n(3),o=n(9),i=n(1),s=n(5);function c(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return u(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var l=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash,s.a.Legacy003AuthParams,s.a.Dirty,s.a.DirtiedDate,s.a.ErrorDecrypting,s.a.ErrorDecryptingChanged,s.a.WaitingForKey,s.a.LastSyncBegan,s.a.LastSyncEnd],f=[s.a.Uuid,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.Legacy003AuthHash,s.a.ErrorDecrypting,s.a.ErrorDecryptingChanged,s.a.WaitingForKey],p=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Legacy003AuthHash],y=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash,s.a.Legacy003AuthParams,s.a.Dirty,s.a.DirtiedDate,s.a.ErrorDecrypting,s.a.WaitingForKey],h=[s.a.Uuid,s.a.ContentType,s.a.ItemsKeyId,s.a.EncItemKey,s.a.Content,s.a.CreatedAt,s.a.UpdatedAt,s.a.Deleted,s.a.Legacy003AuthHash],d=[s.a.Uuid,s.a.ContentType,s.a.Content,s.a.UpdatedAt],v=[s.a.Uuid,s.a.Content,s.a.CreatedAt],m=[s.a.Uuid,s.a.Content,s.a.ContentType,s.a.CreatedAt],b=[s.a.Uuid,s.a.ContentType,s.a.UpdatedAt,s.a.Deleted,s.a.Dirty,s.a.LastSyncEnd];function g(e,t){return O(e,l.slice(),void 0,t)}function w(e,t,n,r){var a,o={},i=c(n||t.fields);try{for(i.s();!(a=i.n()).done;){var s=a.value;o[s]=t[s]}}catch(e){i.e(e)}finally{i.f()}if(r)for(var u=0,l=Object.keys(r);u<l.length;u++){var f=l[u];o[f]=r[f]}return x(e,o)}function k(e,t,n){return O(e,function(e){if(e===o.a.FileEncrypted||e===o.a.FileDecrypted||e===o.a.FilePreferEncrypted)return p.slice();if(e===o.a.LocalStoragePreferEncrypted||e===o.a.LocalStorageDecrypted||e===o.a.LocalStorageEncrypted)return y.slice();if(e===o.a.Sync||e===o.a.SyncDecrypted)return h.slice();throw"No payload fields found for intent ".concat(e)}(t),a.a.Constructor,n)}function S(e,t,n){return O(e,function(e){if(e===a.a.FileImport)return p.slice();if(e===a.a.SessionHistory)return d.slice();if(e===a.a.ComponentRetrieved)return v.slice();if(e===a.a.ComponentCreated)return m.slice();if(e===a.a.LocalRetrieved||e===a.a.LocalChanged)return y.slice();if(e===a.a.RemoteRetrieved||e===a.a.ConflictData||e===a.a.ConflictUuid)return h.slice();if(e===a.a.LocalSaved||e===a.a.RemoteSaved)return b.slice();throw"No payload fields found for source ".concat(e)}(t),t,n)}function x(e,t){return O(e,e.fields,e.source,t)}function O(e,t,n,o){var s,u=Object(i.A)(e,t),l=o instanceof r.a?o.fields.slice():Object.keys(o||[]),f=c(l);try{for(f.s();!(s=f.n()).done;){var p=s.value,y=o[p];u[p]=y?Object(i.a)(y):y}}catch(e){f.e(e)}finally{f.f()}var h=Object(i.K)(t.concat(l));return new r.a(u,h,n||a.a.Constructor)}function P(e){return O(e,Object.keys(e))}function j(e,t){return O(e,f.slice(),void 0,t)}},function(e,t,n){"use strict";var r;function a(e){return[r.RemoteRetrieved,r.ComponentRetrieved,r.RemoteActionRetrieved].includes(e)}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),function(e){e[e.RemoteRetrieved=1]="RemoteRetrieved",e[e.RemoteSaved=2]="RemoteSaved",e[e.LocalSaved=3]="LocalSaved",e[e.LocalRetrieved=4]="LocalRetrieved",e[e.LocalChanged=5]="LocalChanged",e[e.ComponentRetrieved=6]="ComponentRetrieved",e[e.DesktopInstalled=7]="DesktopInstalled",e[e.RemoteActionRetrieved=8]="RemoteActionRetrieved",e[e.FileImport=9]="FileImport",e[e.RemoteConflict=10]="RemoteConflict",e[e.ImportConflict=11]="ImportConflict",e[e.SavedOrSaving=12]="SavedOrSaving",e[e.DecryptedTransient=13]="DecryptedTransient",e[e.ConflictUuid=14]="ConflictUuid",e[e.ConflictData=15]="ConflictData",e[e.SessionHistory=16]="SessionHistory",e[e.Constructor=17]="Constructor",e[e.ComponentCreated=18]="ComponentCreated",e[e.PreSyncSave=19]="PreSyncSave"}(r||(r={}))},function(e,t,n){"use strict";function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"b",(function(){return o})),n.d(t,"a",(function(){return a})),n.d(t,"c",(function(){return i}));var a,o="org.standardnotes.sn";function i(e){var t;return(r(t={},a.Note,"note"),r(t,a.Tag,"tag"),r(t,a.SmartTag,"smart tag"),r(t,a.ActionsExtension,"action-based extension"),r(t,a.Component,"component"),r(t,a.Editor,"editor"),r(t,a.Theme,"theme"),r(t,a.ServerExtension,"server extension"),r(t,a.Mfa,"two-factor authentication setting"),r(t,a.FilesafeCredentials,"FileSafe credential"),r(t,a.FilesafeFileMetadata,"FileSafe file"),r(t,a.FilesafeIntegration,"FileSafe integration"),t)[e]}!function(e){e.Any="*",e.Item="SF|Item",e.RootKey="SN|RootKey|NoSync",e.ItemsKey="SN|ItemsKey",e.EncryptedStorage="SN|EncryptedStorage",e.Note="Note",e.Tag="Tag",e.SmartTag="SN|SmartTag",e.Component="SN|Component",e.Editor="SN|Editor",e.ActionsExtension="Extension",e.UserPrefs="SN|UserPreferences",e.Privileges="SN|Privileges",e.HistorySession="SN|HistorySession",e.Theme="SN|Theme",e.Mfa="SF|MFA",e.ServerExtension="SF|Extension",e.FilesafeCredentials="SN|FileSafe|Credentials",e.FilesafeFileMetadata="SN|FileSafe|FileMetadata",e.FilesafeIntegration="SN|FileSafe|Integration",e.ExtensionRepo="SN|ExtensionRepo"}(a||(a={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.Uuid="uuid",e.ContentType="content_type",e.ItemsKeyId="items_key_id",e.EncItemKey="enc_item_key",e.Content="content",e.CreatedAt="created_at",e.UpdatedAt="updated_at",e.Deleted="deleted",e.Legacy003AuthHash="auth_hash",e.Legacy003AuthParams="auth_params",e.Dirty="dirty",e.DirtiedDate="dirtiedDate",e.WaitingForKey="waitingForKey",e.ErrorDecrypting="errorDecrypting",e.ErrorDecryptingChanged="errorDecryptingValueChanged",e.LastSyncBegan="lastSyncBegan",e.LastSyncEnd="lastSyncEnd"}(r||(r={}))},function(e,t,n){"use strict";(function(e){n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){return a})),n.d(t,"e",(function(){return o})),n.d(t,"d",(function(){return v})),n.d(t,"b",(function(){return m}));var r,a,o,i=n(10),s=n(14),c=n(2),u=n(1),l=n(15),f=n(4),p=n(3);function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function d(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),e}!function(e){e[e.UserInteraction=1]="UserInteraction",e[e.Internal=2]="Internal",e[e.NonDirtying=3]="NonDirtying"}(r||(r={})),function(e){e.Pinned="pinned",e.Archived="archived",e.Locked="locked",e.UserModifiedDate="client_updated_at",e.DefaultEditor="defaultEditor",e.MobileRules="mobileRules",e.NotAvailableOnMobile="notAvailableOnMobile",e.MobileActive="mobileActive",e.LastSize="lastSize",e.PrefersPlainEditor="prefersPlainEditor",e.ComponentInstallError="installError"}(a||(a={})),function(e){e[e.KeepEarliest=1]="KeepEarliest"}(o||(o={}));var v=function(){function t(n){var r=this;if(y(this,t),this.protected=!1,this.trashed=!1,this.pinned=!1,this.archived=!1,this.locked=!1,!n.uuid||!n.content_type)throw Error("Cannot create item without both uuid and content_type");if(n.format===i.a.DecryptedBareObject&&(n.enc_item_key||n.items_key_id||n.auth_hash))throw Error("Creating an item from a decrypted payload should not contain enc params");this.payload=n,this.conflictOf=n.safeContent.conflict_of,this.createdAtString=this.created_at&&this.dateToLocalizedString(this.created_at),n.format===i.a.DecryptedBareObject?(this.userModifiedDate=new Date(this.getAppDomainValue(a.UserModifiedDate)||this.updated_at),this.updatedAtString=this.dateToLocalizedString(this.userModifiedDate),this.protected=this.payload.safeContent.protected,this.trashed=this.payload.safeContent.trashed,this.pinned=this.getAppDomainValue(a.Pinned),this.archived=this.getAppDomainValue(a.Archived),this.locked=this.getAppDomainValue(a.Locked)):this.userModifiedDate=this.updated_at,e((function(){Object(u.g)(r)}))}return d(t,[{key:"payloadRepresentation",value:function(e){return Object(c.b)(this.payload,e)}},{key:"hasRelationshipWithItem",value:function(e){var t;return!!(null===(t=this.payload.safeContent.references)||void 0===t?void 0:t.find((function(t){return t.uuid===e.uuid})))}},{key:"getDomainData",value:function(e){var t=this.payload.safeContent.appData;if(t)return t[e]}},{key:"getAppDomainValue",value:function(e){return this.getDomainData(t.DefaultAppDomain())[e]}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["conflict_of"]}},{key:"appDataContentKeysToIgnoreWhenCheckingEquality",value:function(){return[a.UserModifiedDate]}},{key:"getContentCopy",value:function(){return JSON.parse(JSON.stringify(this.content))}},{key:"strategyWhenConflictingWithItem",value:function(e){if(this.errorDecrypting)return s.a.KeepLeftDuplicateRight;if(this.isSingleton)return s.a.KeepLeft;if(this.deleted)return s.a.KeepRight;if(e.deleted)return this.payload.source===p.a.FileImport?s.a.KeepLeft:s.a.KeepRight;if(!b(this,e))return s.a.KeepRight;if(b(this,e,["references"])){return e.payload.source===p.a.FileImport||Date.now()-this.userModifiedDate.getTime()<2e4?s.a.KeepLeftDuplicateRight:s.a.DuplicateLeftKeepRight}return s.a.KeepLeftMergeRefs}},{key:"isItemContentEqualWith",value:function(e){return g(this.payload.contentObject,e.payload.contentObject,this.contentKeysToIgnoreWhenCheckingEquality(),this.appDataContentKeysToIgnoreWhenCheckingEquality())}},{key:"satisfiesPredicate",value:function(e){return l.a.ItemSatisfiesPredicate(this,e)}},{key:"updatedAtTimestamp",value:function(){var e;return null===(e=this.updated_at)||void 0===e?void 0:e.getTime()}},{key:"dateToLocalizedString",value:function(e){if("undefined"!=typeof Intl&&Intl.DateTimeFormat){if(!t.sharedDateFormatter){var n=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language;t.sharedDateFormatter=new Intl.DateTimeFormat(n,{year:"numeric",month:"short",day:"2-digit",weekday:"long",hour:"2-digit",minute:"2-digit"})}return t.sharedDateFormatter.format(e)}return e.toDateString()+" "+e.toLocaleTimeString()}},{key:"uuid",get:function(){return this.payload.uuid}},{key:"content",get:function(){return this.payload.content}},{key:"safeContent",get:function(){return this.payload.safeContent}},{key:"references",get:function(){return this.payload.safeContent.references||[]}},{key:"deleted",get:function(){return this.payload.deleted}},{key:"content_type",get:function(){return this.payload.content_type}},{key:"created_at",get:function(){return this.payload.created_at}},{key:"updated_at",get:function(){return this.payload.updated_at}},{key:"dirtiedDate",get:function(){return this.payload.dirtiedDate}},{key:"dirty",get:function(){return this.payload.dirty}},{key:"errorDecrypting",get:function(){return this.payload.errorDecrypting}},{key:"waitingForKey",get:function(){return this.payload.waitingForKey}},{key:"errorDecryptingValueChanged",get:function(){return this.payload.errorDecryptingValueChanged}},{key:"lastSyncBegan",get:function(){return this.payload.lastSyncBegan}},{key:"lastSyncEnd",get:function(){return this.payload.lastSyncEnd}},{key:"auth_hash",get:function(){return this.payload.auth_hash}},{key:"auth_params",get:function(){return this.payload.auth_params}},{key:"neverSynced",get:function(){return!this.updated_at||0===this.updated_at.getTime()}},{key:"isSingleton",get:function(){return!1}},{key:"singletonPredicate",get:function(){throw"Must override SNItem.singletonPredicate"}},{key:"singletonStrategy",get:function(){return o.KeepEarliest}}],[{key:"DefaultAppDomain",value:function(){return f.b}}]),t}(),m=function(){function e(t,n){y(this,e),this.item=t,this.type=n,this.payload=t.payload,this.payload.content&&(this.content=Object(u.a)(this.payload.content))}return d(e,[{key:"getUuid",value:function(){return this.payload.uuid}},{key:"getItem",value:function(){return this.item}},{key:"getResult",value:function(){if(this.type===r.NonDirtying)return Object(c.b)(this.payload,{content:this.content});this.payload.deleted||(this.type===r.UserInteraction?this.userModifiedDate=new Date:this.item.userModifiedDate||(this.userModifiedDate=new Date(this.item.updated_at)));return Object(c.b)(this.payload,{content:this.content,dirty:!0,dirtiedDate:new Date})}},{key:"mergePayload",value:function(e){this.payload=Object(c.g)(this.payload,e),this.payload.content?this.content=Object(u.a)(this.payload.safeContent):this.content=void 0}},{key:"setContent",value:function(e){this.content=Object(u.a)(e)}},{key:"setDeleted",value:function(){this.content=void 0,this.payload=Object(c.b)(this.payload,{content:this.content,deleted:!0})}},{key:"setDomainData",value:function(e,t){this.payload.errorDecrypting||(this.content.appData||(this.content.appData={}),this.content.appData[t]=e)}},{key:"setDomainDataKey",value:function(e,t,n){if(!this.payload.errorDecrypting){this.content.appData||(this.content.appData={});var r=this.content.appData;r[n]||(r[n]={}),r[n][e]=t}}},{key:"setAppDataItem",value:function(e,t){this.setDomainDataKey(e,t,v.DefaultAppDomain())}},{key:"addItemAsRelationship",value:function(e){var t=this.content.references||[];t.find((function(t){return t.uuid===e.uuid}))||t.push({uuid:e.uuid,content_type:e.content_type}),this.content.references=t}},{key:"removeItemAsRelationship",value:function(e){var t=this.content.references||[];t=t.filter((function(t){return t.uuid!==e.uuid})),this.content.references=t}},{key:"lastSyncBegan",set:function(e){this.payload=Object(c.b)(this.payload,{content:this.content,lastSyncBegan:e})}},{key:"errorDecrypting",set:function(e){this.payload=Object(c.b)(this.payload,{content:this.content,errorDecrypting:e})}},{key:"updated_at",set:function(e){this.payload=Object(c.b)(this.payload,{updated_at:e})}},{key:"userModifiedDate",set:function(e){this.setAppDataItem(a.UserModifiedDate,e)}},{key:"conflictOf",set:function(e){this.content.conflict_of=e}},{key:"protected",set:function(e){this.content.protected=e}},{key:"trashed",set:function(e){this.content.trashed=e}},{key:"pinned",set:function(e){this.setAppDataItem(a.Pinned,e)}},{key:"archived",set:function(e){this.setAppDataItem(a.Archived,e)}},{key:"locked",set:function(e){this.setAppDataItem(a.Locked,e)}}]),e}();function b(e,t,n){return n||(n=[]),!g(e.content,t.content,e.contentKeysToIgnoreWhenCheckingEquality().concat(n),e.appDataContentKeysToIgnoreWhenCheckingEquality())}function g(e,t,n,r){if((e=Object(u.F)(e)).appData){var a=e.appData[f.b];Object(u.z)(a,r),a?0===Object.keys(a).length&&delete e.appData:delete e.appData}if(Object(u.z)(e,n),(t=Object(u.F)(t)).appData){var o=t.appData[f.b];Object(u.z)(o,r),o?0===Object.keys(o).length&&delete t.appData:delete t.appData}return Object(u.z)(t,n),JSON.stringify(e)===JSON.stringify(t)}}).call(this,n(77).setImmediate)},function(e,t,n){"use strict";var r;function a(e,t){return Number(e)-Number(t)}n.d(t,"a",(function(){return r})),n.d(t,"b",(function(){return a})),function(e){e.V000Base64Decrypted="000",e.V001="001",e.V002="002",e.V003="003",e.V004="004",e[e.VersionLength=3]="VersionLength"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.FullSyncCompleted="sync =full-completed",e.SingleSyncCompleted="sync =single-completed",e.SyncWillBegin="sync =will-begin",e.DownloadFirstSyncCompleted="sync =download-first-completed",e.SyncTakingTooLong="sync =taking-too-long",e.SyncError="sync =error",e.InvalidSession="sync =invalid-session",e.MajorDataChange="major-data-change",e.LocalDataIncrementalLoad="local-data-incremental-load",e.LocalDataLoaded="local-data-loaded",e.EnterOutOfSync="enter-out-of-sync",e.ExitOutOfSync="exit-out-of-sync",e.StatusChanged="status-changed",e.DatabaseWriteError="database-write-error",e.DatabaseReadError="database-read-error"}(r||(r={}))},function(e,t,n){"use strict";var r;function a(e){return e===r.LocalStorageEncrypted||e===r.LocalStorageDecrypted||e===r.LocalStoragePreferEncrypted}function o(e){return e===r.FileEncrypted||e===r.FileDecrypted||e===r.FilePreferEncrypted}function i(e){return e===r.SyncDecrypted||e===r.LocalStorageDecrypted||e===r.FileDecrypted}function s(e){return e===r.Sync||e===r.LocalStorageEncrypted||e===r.FileEncrypted}n.d(t,"a",(function(){return r})),n.d(t,"e",(function(){return a})),n.d(t,"d",(function(){return o})),n.d(t,"c",(function(){return i})),n.d(t,"b",(function(){return s})),function(e){e[e.Sync=0]="Sync",e[e.SyncDecrypted=1]="SyncDecrypted",e[e.LocalStorageEncrypted=2]="LocalStorageEncrypted",e[e.LocalStorageDecrypted=3]="LocalStorageDecrypted",e[e.LocalStoragePreferEncrypted=4]="LocalStoragePreferEncrypted",e[e.FileEncrypted=5]="FileEncrypted",e[e.FileDecrypted=6]="FileDecrypted",e[e.FilePreferEncrypted=7]="FilePreferEncrypted"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e[e.EncryptedString=0]="EncryptedString",e[e.DecryptedBareObject=1]="DecryptedBareObject",e[e.DecryptedBase64String=2]="DecryptedBase64String",e[e.Deleted=3]="Deleted"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return o}));var r=n(4);function a(e){return e.map((function(e){return e.uuid}))}function o(e){return e.references||(e.references=[]),e.appData||(e.appData={}),e.appData[r.b]||(e.appData[r.b]={}),e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return y}));var r=n(0),a=n.n(r),o=n(1);function i(e){return function(e){if(Array.isArray(e))return u(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||c(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=c(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function c(e,t){if(e){if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function l(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function f(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){l(o,r,a,i,s,"next",e)}function s(e){l(o,r,a,i,s,"throw",e)}i(void 0)}))}}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var y=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.eventObservers=[],this.loggingEnabled=!1,this.criticalPromises=[]}var t,n,r,c,u,l,y;return t=e,(n=[{key:"addEventObserver",value:function(e){var t=this;return this.eventObservers.push(e),function(){Object(o.B)(t.eventObservers,e)}}},{key:"notifyEvent",value:(y=f(a.a.mark((function e(t,n){var r,o,i;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=s(this.eventObservers),e.prev=1,r.s();case 3:if((o=r.n()).done){e.next=9;break}return i=o.value,e.next=7,i(t,n||{});case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),r.e(e.t0);case 14:return e.prev=14,r.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e,t){return y.apply(this,arguments)})},{key:"blockDeinit",value:(l=f(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(this.criticalPromises);case 2:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"deinit",value:function(){this.eventObservers.length=0,this.deviceInterface=void 0}},{key:"executeCriticalFunction",value:(u=f(a.a.mark((function e(t){var n;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t(),this.criticalPromises.push(n),e.abrupt("return",n);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"handleApplicationStage",value:(c=f(a.a.mark((function e(t){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e){return c.apply(this,arguments)})},{key:"log",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(this.loggingEnabled){var a,o=new Date,s=o.toLocaleTimeString().replace(" PM","").replace(" AM",""),c="".concat(s,".").concat(o.getMilliseconds());n?(n=n.map((function(e){return Array.isArray(e)?e.slice():e})),(a=console).log.apply(a,[c,e].concat(i(n)))):console.log(c,e)}}}])&&p(t.prototype,n),r&&p(t,r),e}()},function(e,t,n){"use strict";n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return i}));var r,a=n(8);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e){var t;return(t={},o(t,a.a.FullSyncCompleted,r.CompletedFullSync),o(t,a.a.SingleSyncCompleted,r.CompletedIncrementalSync),o(t,a.a.SyncError,r.FailedSync),o(t,a.a.SyncTakingTooLong,r.HighLatencySync),o(t,a.a.EnterOutOfSync,r.EnteredOutOfSync),o(t,a.a.ExitOutOfSync,r.ExitedOutOfSync),o(t,a.a.LocalDataLoaded,r.LocalDataLoaded),o(t,a.a.MajorDataChange,r.MajorDataChange),o(t,a.a.LocalDataIncrementalLoad,r.LocalDataIncrementalLoad),o(t,a.a.StatusChanged,r.SyncStatusChanged),o(t,a.a.SyncWillBegin,r.WillSync),o(t,a.a.InvalidSession,r.InvalidSyncSession),o(t,a.a.DatabaseReadError,r.LocalDatabaseReadError),o(t,a.a.DatabaseWriteError,r.LocalDatabaseWriteError),t)[e]}n.d(t,"b",(function(){return a.a})),function(e){e[e.SignedIn=2]="SignedIn",e[e.SignedOut=3]="SignedOut",e[e.CompletedFullSync=5]="CompletedFullSync",e[e.FailedSync=6]="FailedSync",e[e.HighLatencySync=7]="HighLatencySync",e[e.EnteredOutOfSync=8]="EnteredOutOfSync",e[e.ExitedOutOfSync=9]="ExitedOutOfSync",e[e.Started=10]="Started",e[e.Launched=11]="Launched",e[e.LocalDataLoaded=12]="LocalDataLoaded",e[e.KeyStatusChanged=13]="KeyStatusChanged",e[e.MajorDataChange=14]="MajorDataChange",e[e.CompletedRestart=15]="CompletedRestart",e[e.LocalDataIncrementalLoad=16]="LocalDataIncrementalLoad",e[e.SyncStatusChanged=17]="SyncStatusChanged",e[e.WillSync=18]="WillSync",e[e.InvalidSyncSession=19]="InvalidSyncSession",e[e.LocalDatabaseReadError=20]="LocalDatabaseReadError",e[e.LocalDatabaseWriteError=21]="LocalDatabaseWriteError",e[e.CompletedIncrementalSync=22]="CompletedIncrementalSync"}(r||(r={}))},function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e[e.KeepLeft=1]="KeepLeft",e[e.KeepRight=2]="KeepRight",e[e.KeepLeftDuplicateRight=3]="KeepLeftDuplicateRight",e[e.DuplicateLeftKeepRight=4]="DuplicateLeftKeepRight",e[e.KeepLeftMergeRefs=5]="KeepLeftMergeRefs"}(r||(r={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var r=n(1);function a(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return o(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,c=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return s=e.done,e},e:function(e){c=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw i}}}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var s=function(){function e(t,n,r){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.keypath=t,this.operator=n,this.value=r,this.isRecursive()){var a=this.value;this.value=a.map((function(t){return Array.isArray(t)?e.FromArray(t):t}))}else"true"!==this.value&&"false"!==this.value||(this.value=JSON.parse(this.value))}var t,n,o;return t=e,o=[{key:"FromJson",value:function(t){return new e(t.keypath,t.operator,t.value)}},{key:"FromArray",value:function(t){return new e(t[0],t[1],t[2])}},{key:"CompoundPredicate",value:function(t){return new e("ignored","and",t)}},{key:"ObjectSatisfiesPredicate",value:function(e,t){if(Array.isArray(t)&&(t=this.FromArray(t)),t.isRecursive()){if("and"===t.operator){var n,r=a(t.valueAsArray());try{for(r.s();!(n=r.n()).done;){var o=n.value;if(!this.ObjectSatisfiesPredicate(e,o))return!1}}catch(e){r.e(e)}finally{r.f()}return!0}if("or"===t.operator){var i,s=a(t.valueAsArray());try{for(s.s();!(i=s.n()).done;){var c=i.value;if(this.ObjectSatisfiesPredicate(e,c))return!0}}catch(e){s.e(e)}finally{s.f()}return!1}}var u=t.value;if("string"==typeof u&&u.includes(".ago")&&(u=this.DateFromString(u)),"not"===t.operator)return!this.ObjectSatisfiesPredicate(e,u);var l=t.keypath.split(".").reduce((function(e,t){return e&&e[t]}),e),f=[!1,"",null,void 0,NaN];return void 0===l?"!="===t.operator?!f.includes(t.value):f.includes(t.value):"="===t.operator?Array.isArray(l)?JSON.stringify(l)===JSON.stringify(u):l===u:"!="===t.operator?Array.isArray(l)?JSON.stringify(l)!==JSON.stringify(u):l!==u:"<"===t.operator?l<u:">"===t.operator?l>u:"<="===t.operator?l<=u:">="===t.operator?l>=u:"startsWith"===t.operator?l.startsWith(u):"in"===t.operator?-1!==u.indexOf(l):"includes"===t.operator?this.resolveIncludesPredicate(l,u):"matches"===t.operator&&new RegExp(u).test(l)}},{key:"resolveIncludesPredicate",value:function(t,n){if(Object(r.s)(n))return t.includes(n);var o;o=Array.isArray(n)?e.FromArray(n):n;var i,s=a(t);try{for(s.s();!(i=s.n()).done;){var c=i.value;if(this.ObjectSatisfiesPredicate(c,o))return!0}}catch(e){s.e(e)}finally{s.f()}return!1}},{key:"ItemSatisfiesPredicate",value:function(t,n){return Array.isArray(n)&&(n=e.FromArray(n)),this.ObjectSatisfiesPredicate(t,n)}},{key:"ItemSatisfiesPredicates",value:function(e,t){var n,r=a(t);try{for(r.s();!(n=r.n()).done;){var o=n.value;if(!this.ItemSatisfiesPredicate(e,o))return!1}}catch(e){r.e(e)}finally{r.f()}return!0}},{key:"DateFromString",value:function(e){var t=e.split("."),n=t[1],r=new Date,a=parseInt(t[0]);return"days"===n?r.setDate(r.getDate()-a):"hours"===n&&r.setHours(r.getHours()-a),r}}],(n=[{key:"isRecursive",value:function(){return["and","or"].includes(this.operator)}},{key:"arrayRepresentation",value:function(){return[this.keypath,this.operator,this.value]}},{key:"valueAsArray",value:function(){return this.value}}])&&i(t.prototype,n),o&&i(t,o),e}()},function(e,t,n){"use strict";var r=Array.isArray;e.exports=r},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(56),o="object"==("undefined"==typeof self?"undefined":r(self))&&self&&self.Object===Object&&self,i=a||o||Function("return this")();e.exports=i},function(e,t,n){"use strict";var r=n(157)(n(158));e.exports=r},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=r(e);return null!=e&&("object"==t||"function"==t)}},function(e,t,n){"use strict";var r=n(39),a=n(152);e.exports=function(e,t){var n=[];if(!e||!e.length)return n;var o=-1,i=[],s=e.length;for(t=r(t,3);++o<s;){var c=e[o];t(c,o,e)&&(n.push(c),i.push(o))}return a(e,i),n}},function(e,t,n){"use strict";var r=n(94),a=n(99);e.exports=function(e,t){var n=a(e,t);return r(n)?n:void 0}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){return null!=e&&"object"==r(e)}},function(e,t,n){"use strict";var r=n(76);e.exports=function(e){return e&&e.length?r(e):[]}},function(e,t,n){"use strict";var r=n(33),a=n(95),o=n(96),i=r?r.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?a(e):o(e)}},function(e,t,n){"use strict";e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,n){"use strict";var r=n(42),a=n(49);e.exports=function(e){return null!=e&&a(e.length)&&!r(e)}},function(e,t,n){"use strict";var r=n(37);e.exports=function(e){if("string"==typeof e||r(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(e,t,n){"use strict";n.d(t,"a",(function(){return p}));var r=n(11),a=n(5),o=n(3),i=n(7),s=n(1),c=n(10);function u(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return l(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return l(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var p=function(){function e(t,n,u){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.fields=n||Object.keys(t),this.source=u||o.a.Constructor,this.uuid=t.uuid,!this.uuid&&this.fields.includes(a.a.Uuid))throw Error("uuid is null, yet this payloads fields indicate it shouldnt be.");this.content_type=t.content_type,t.content&&(Object(s.q)(t.content)?this.content=Object(r.a)(t.content):this.content=t.content),this.deleted=t.deleted,this.items_key_id=t.items_key_id,this.enc_item_key=t.enc_item_key,this.created_at=new Date(t.created_at||new Date),this.updated_at=new Date(t.updated_at||new Date(0)),this.dirtiedDate=new Date(t.dirtiedDate),this.dirty=t.dirty,this.errorDecrypting=t.errorDecrypting,this.waitingForKey=t.waitingForKey,this.errorDecryptingValueChanged=t.errorDecryptingValueChanged,this.lastSyncBegan=t.lastSyncBegan?new Date(t.lastSyncBegan):void 0,this.lastSyncEnd=t.lastSyncEnd?new Date(t.lastSyncEnd):void 0,this.auth_hash=t.auth_hash,this.auth_params=t.auth_params,Object(s.s)(this.content)?this.content.startsWith(i.a.V000Base64Decrypted)?this.format=c.a.DecryptedBase64String:this.format=c.a.EncryptedString:Object(s.q)(this.content)?this.format=c.a.DecryptedBareObject:this.format=c.a.Deleted,Object(s.s)(this.content)?this.version=this.content.substring(0,i.a.VersionLength):this.content&&(this.version=this.content.version),Object(s.g)(this)}var t,n,l;return t=e,(n=[{key:"ejected",value:function(){var e,t=[a.a.Legacy003AuthHash,a.a.Deleted],n=[a.a.DirtiedDate,a.a.ErrorDecrypting,a.a.ErrorDecryptingChanged,a.a.WaitingForKey,a.a.LastSyncBegan,a.a.LastSyncEnd],r={},o=u(this.fields);try{for(o.s();!(e=o.n()).done;){var i=e.value;if(!n.includes(i)){var c=this[i];Object(s.p)(c)&&t.includes(i)||(r[i]=c)}}}catch(e){o.e(e)}finally{o.f()}return r}},{key:"safeContent",get:function(){return this.format===c.a.DecryptedBareObject?this.content:{}}},{key:"references",get:function(){return this.safeReferences}},{key:"safeReferences",get:function(){return this.safeContent.references||[]}},{key:"contentObject",get:function(){if(this.format!==c.a.DecryptedBareObject)throw Error("Attempting to access non-object content as object");return this.content}},{key:"contentString",get:function(){if(this.format===c.a.DecryptedBareObject)throw Error("Attempting to access non-string content as string");return this.content}},{key:"discardable",get:function(){return this.deleted&&!this.dirty}}])&&f(t.prototype,n),l&&f(t,l),e}()},function(e,t,n){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a;a=function(){return this}();try{a=a||new Function("return this")()}catch(e){"object"===("undefined"==typeof window?"undefined":r(window))&&(a=window)}e.exports=a},function(e,t,n){"use strict";var r=n(84),a=n(85),o=n(86),i=n(87),s=n(88);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,n){"use strict";var r=n(25);e.exports=function(e,t){for(var n=e.length;n--;)if(r(e[n][0],t))return n;return-1}},function(e,t,n){"use strict";var r=n(17).Symbol;e.exports=r},function(e,t,n){"use strict";var r=n(21)(Object,"create");e.exports=r},function(e,t,n){"use strict";var r=n(108);e.exports=function(e,t){var n=e.__data__;return r(t)?n["string"==typeof t?"string":"hash"]:n.map}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var n=r(e);return!!(t=null==t?9007199254740991:t)&&("number"==n||"symbol"!=n&&a.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(24),o=n(22);e.exports=function(e){return"symbol"==r(e)||o(e)&&"[object Symbol]"==a(e)}},function(e,t,n){"use strict";var r=n(69),a=n(75)((function(e,t,n){r(e,t,n)}));e.exports=a},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(82),o=n(138),i=n(54),s=n(16),c=n(149);e.exports=function(e){return"function"==typeof e?e:null==e?i:"object"==r(e)?s(e)?o(e[0],e[1]):a(e):c(e)}},function(e,t,n){"use strict";var r=n(31),a=n(89),o=n(90),i=n(91),s=n(92),c=n(93);function u(e){var t=this.__data__=new r(e);this.size=t.size}u.prototype.clear=a,u.prototype.delete=o,u.prototype.get=i,u.prototype.has=s,u.prototype.set=c,e.exports=u},function(e,t,n){"use strict";var r=n(21)(n(17),"Map");e.exports=r},function(e,t,n){"use strict";var r=n(24),a=n(19);e.exports=function(e){if(!a(e))return!1;var t=r(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},function(e,t,n){"use strict";var r=n(100),a=n(107),o=n(109),i=n(110),s=n(111);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,n){"use strict";e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}},function(e,t,n){"use strict";var r=n(63),a=n(131),o=n(26);e.exports=function(e){return o(e)?r(e):a(e)}},function(e,t,n){"use strict";var r=n(126),a=n(22),o=Object.prototype,i=o.hasOwnProperty,s=o.propertyIsEnumerable,c=r(function(){return arguments}())?r:function(e){return a(e)&&i.call(e,"callee")&&!s.call(e,"callee")};e.exports=c},function(e,t,n){"use strict";(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(17),o=n(127),i="object"==r(t)&&t&&!t.nodeType&&t,s=i&&"object"==r(e)&&e&&!e.nodeType&&e,c=s&&s.exports===i?a.Buffer:void 0,u=(c?c.isBuffer:void 0)||o;e.exports=u}).call(this,n(29)(e))},function(e,t,n){"use strict";var r=n(128),a=n(129),o=n(130),i=o&&o.isTypedArray,s=i?a(i):r;e.exports=s},function(e,t,n){"use strict";e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},function(e,t,n){"use strict";var r=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||r)}},function(e,t,n){"use strict";var r=n(52),a=n(27);e.exports=function(e,t){for(var n=0,o=(t=r(t,e)).length;null!=e&&n<o;)e=e[a(t[n++])];return n&&n==o?e:void 0}},function(e,t,n){"use strict";var r=n(16),a=n(53),o=n(140),i=n(143);e.exports=function(e,t){return r(e)?e:a(e,t)?[e]:o(i(e))}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(16),o=n(37),i=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,s=/^\w*$/;e.exports=function(e,t){if(a(e))return!1;var n=r(e);return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!o(e))||(s.test(e)||!i.test(e)||null!=t&&e in Object(t))}},function(e,t,n){"use strict";e.exports=function(e){return e}},function(e,t,n){"use strict";var r=n(71);e.exports=function(e,t,n){"__proto__"==t&&r?r(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}},function(e,t,n){"use strict";(function(t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var r="object"==(void 0===t?"undefined":n(t))&&t&&t.Object===Object&&t;e.exports=r}).call(this,n(30))},function(e,t,n){"use strict";var r=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return r.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,n){"use strict";var r=n(112),a=n(22);e.exports=function e(t,n,o,i,s){return t===n||(null==t||null==n||!a(t)&&!a(n)?t!=t&&n!=n:r(t,n,o,i,e,s))}},function(e,t,n){"use strict";var r=n(60),a=n(115),o=n(61);e.exports=function(e,t,n,i,s,c){var u=1&n,l=e.length,f=t.length;if(l!=f&&!(u&&f>l))return!1;var p=c.get(e);if(p&&c.get(t))return p==t;var y=-1,h=!0,d=2&n?new r:void 0;for(c.set(e,t),c.set(t,e);++y<l;){var v=e[y],m=t[y];if(i)var b=u?i(m,v,y,t,e,c):i(v,m,y,e,t,c);if(void 0!==b){if(b)continue;h=!1;break}if(d){if(!a(t,(function(e,t){if(!o(d,t)&&(v===e||s(v,e,n,i,c)))return d.push(t)}))){h=!1;break}}else if(v!==m&&!s(v,m,n,i,c)){h=!1;break}}return c.delete(e),c.delete(t),h}},function(e,t,n){"use strict";var r=n(43),a=n(113),o=n(114);function i(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new r;++t<n;)this.add(e[t])}i.prototype.add=i.prototype.push=a,i.prototype.has=o,e.exports=i},function(e,t,n){"use strict";e.exports=function(e,t){return e.has(t)}},function(e,t,n){"use strict";var r=n(17).Uint8Array;e.exports=r},function(e,t,n){"use strict";var r=n(125),a=n(46),o=n(16),i=n(47),s=n(36),c=n(48),u=Object.prototype.hasOwnProperty;e.exports=function(e,t){var n=o(e),l=!n&&a(e),f=!n&&!l&&i(e),p=!n&&!l&&!f&&c(e),y=n||l||f||p,h=y?r(e.length,String):[],d=h.length;for(var v in e)!t&&!u.call(e,v)||y&&("length"==v||f&&("offset"==v||"parent"==v)||p&&("buffer"==v||"byteLength"==v||"byteOffset"==v)||s(v,d))||h.push(v);return h}},function(e,t,n){"use strict";e.exports=function(e,t){return function(n){return e(t(n))}}},function(e,t,n){"use strict";var r=n(21)(n(17),"Set");e.exports=r},function(e,t,n){"use strict";var r=n(19);e.exports=function(e){return e==e&&!r(e)}},function(e,t,n){"use strict";e.exports=function(e,t){return function(n){return null!=n&&(n[e]===t&&(void 0!==t||e in Object(n)))}}},function(e,t,n){"use strict";e.exports=function(e,t,n,r){for(var a=e.length,o=n+(r?1:-1);r?o--:++o<a;)if(t(e[o],o,e))return o;return-1}},function(e,t,n){"use strict";var r=n(40),a=n(70),o=n(162),i=n(164),s=n(19),c=n(74),u=n(73);e.exports=function e(t,n,l,f,p){t!==n&&o(n,(function(o,c){if(p||(p=new r),s(o))i(t,n,c,l,e,f,p);else{var y=f?f(u(t,c),o,c+"",t,n,p):void 0;void 0===y&&(y=o),a(t,c,y)}}),c)}},function(e,t,n){"use strict";var r=n(55),a=n(25);e.exports=function(e,t,n){(void 0===n||a(e[t],n))&&(void 0!==n||t in e)||r(e,t,n)}},function(e,t,n){"use strict";var r=n(21),a=function(){try{var e=r(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=a},function(e,t,n){"use strict";var r=n(64)(Object.getPrototypeOf,Object);e.exports=r},function(e,t,n){"use strict";e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},function(e,t,n){"use strict";var r=n(63),a=n(176),o=n(26);e.exports=function(e){return o(e)?r(e,!0):a(e)}},function(e,t,n){"use strict";var r=n(178),a=n(185);e.exports=function(e){return r((function(t,n){var r=-1,o=n.length,i=o>1?n[o-1]:void 0,s=o>2?n[2]:void 0;for(i=e.length>3&&"function"==typeof i?(o--,i):void 0,s&&a(n[0],n[1],s)&&(i=o<3?void 0:i,o=1),t=Object(t);++r<o;){var c=n[r];c&&e(t,c,r,i)}return t}))}},function(e,t,n){"use strict";var r=n(60),a=n(186),o=n(190),i=n(61),s=n(191),c=n(44);e.exports=function(e,t,n){var u=-1,l=a,f=e.length,p=!0,y=[],h=y;if(n)p=!1,l=o;else if(f>=200){var d=t?null:s(e);if(d)return c(d);p=!1,l=i,h=new r}else h=t?[]:y;e:for(;++u<f;){var v=e[u],m=t?t(v):v;if(v=n||0!==v?v:0,p&&m==m){for(var b=h.length;b--;)if(h[b]===m)continue e;t&&h.push(m),y.push(v)}else l(h,m,n)||(h!==y&&h.push(m),y.push(v))}return y}},function(e,t,n){"use strict";(function(e){var r=void 0!==e&&e||"undefined"!=typeof self&&self||window,a=Function.prototype.apply;function o(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new o(a.call(setTimeout,r,arguments),clearTimeout)},t.setInterval=function(){return new o(a.call(setInterval,r,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},o.prototype.unref=o.prototype.ref=function(){},o.prototype.close=function(){this._clearFn.call(r,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(193),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(30))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return v}));var r=n(0),a=n.n(r),o=n(12),i=n(13);function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function u(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){c(o,r,a,i,s,"next",e)}function s(e){c(o,r,a,i,s,"throw",e)}i(void 0)}))}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function f(e,t,n){return(f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=d(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=d(e);if(t){var a=d(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return h(this,n)}}function h(e,t){return!t||"object"!==s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function d(e){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var v=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(m,t);var n,r,o,s,c,h,v=y(m);function m(t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),(n=v.call(this)).application=t,e((function(){n.addAppEventObserver()})),n}return n=m,(r=[{key:"deinit",value:function(){this.application=void 0,this.unsubApp(),this.unsubApp=void 0,f(d(m.prototype),"deinit",this).call(this)}},{key:"addAppEventObserver",value:function(){var e=this;this.application.isStarted()&&this.onAppStart(),this.application.isLaunched()&&this.onAppLaunch(),this.unsubApp=this.application.addEventObserver(function(){var t=u(a.a.mark((function t(n){return a.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.onAppEvent(n),n!==i.a.Started){t.next=6;break}return t.next=4,e.onAppStart();case 4:t.next=12;break;case 6:if(n!==i.a.Launched){t.next=11;break}return t.next=9,e.onAppLaunch();case 9:t.next=12;break;case 11:n===i.a.CompletedFullSync?e.onAppFullSync():n===i.a.CompletedIncrementalSync?e.onAppIncrementalSync():n===i.a.KeyStatusChanged&&e.onAppKeyChange();case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"onAppEvent",value:function(e){}},{key:"onAppStart",value:(h=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return h.apply(this,arguments)})},{key:"onAppLaunch",value:(c=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return c.apply(this,arguments)})},{key:"onAppKeyChange",value:(s=u(a.a.mark((function e(){return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(){return s.apply(this,arguments)})},{key:"onAppIncrementalSync",value:function(){}},{key:"onAppFullSync",value:function(){}}])&&l(n.prototype,r),o&&l(n,o),m}(o.a)}).call(this,n(77).setImmediate)},function(e,t,n){"use strict";var r=n(69),a=n(75)((function(e,t,n,a){r(e,t,n,a)}));e.exports=a},function(e,t,n){"use strict";var r=n(76);e.exports=function(e,t){return t="function"==typeof t?t:void 0,e&&e.length?r(e,void 0,t):[]}},function(e,t,n){"use strict";(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=function(e){var n=Object.prototype,r=n.hasOwnProperty,a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",s=a.toStringTag||"@@toStringTag";function c(e,t,n,r){var a=t&&t.prototype instanceof f?t:f,o=Object.create(a.prototype),i=new x(r||[]);return o._invoke=function(e,t,n){var r="suspendedStart";return function(a,o){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw o;return P()}for(n.method=a,n.arg=o;;){var i=n.delegate;if(i){var s=w(i,n);if(s){if(s===l)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var c=u(e,t,n);if("normal"===c.type){if(r=n.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r="completed",n.method="throw",n.arg=c.arg)}}}(e,n,i),o}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var l={};function f(){}function p(){}function y(){}var h={};h[o]=function(){return this};var d=Object.getPrototypeOf,v=d&&d(d(O([])));v&&v!==n&&r.call(v,o)&&(h=v);var m=y.prototype=f.prototype=Object.create(h);function b(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function g(e,n){var a;this._invoke=function(o,i){function s(){return new n((function(a,s){!function a(o,i,s,c){var l=u(e[o],e,i);if("throw"!==l.type){var f=l.arg,p=f.value;return p&&"object"===t(p)&&r.call(p,"__await")?n.resolve(p.__await).then((function(e){a("next",e,s,c)}),(function(e){a("throw",e,s,c)})):n.resolve(p).then((function(e){f.value=e,s(f)}),(function(e){return a("throw",e,s,c)}))}c(l.arg)}(o,i,a,s)}))}return a=a?a.then(s,s):s()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var r=u(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,l;var a=r.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:P}}function P(){return{value:void 0,done:!0}}return p.prototype=m.constructor=y,y.constructor=p,y[s]=p.displayName="GeneratorFunction",e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,s in e||(e[s]="GeneratorFunction")),e.prototype=Object.create(m),e},e.awrap=function(e){return{__await:e}},b(g.prototype),g.prototype[i]=function(){return this},e.AsyncIterator=g,e.async=function(t,n,r,a,o){void 0===o&&(o=Promise);var i=new g(c(t,n,r,a),o);return e.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},b(m),m[s]="Generator",m[o]=function(){return this},m.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=O,x.prototype={constructor:x,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(S),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return i.type="throw",i.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&r.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,l):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),S(n),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;S(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:O(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),l}},e}("object"===t(e)?e.exports:{});try{regeneratorRuntime=n}catch(e){Function("r","regeneratorRuntime = r")(n)}}).call(this,n(29)(e))},function(e,t,n){"use strict";var r=n(83),a=n(137),o=n(67);e.exports=function(e){var t=a(e);return 1==t.length&&t[0][2]?o(t[0][0],t[0][1]):function(n){return n===e||r(n,e,t)}}},function(e,t,n){"use strict";var r=n(40),a=n(58);e.exports=function(e,t,n,o){var i=n.length,s=i,c=!o;if(null==e)return!s;for(e=Object(e);i--;){var u=n[i];if(c&&u[2]?u[1]!==e[u[0]]:!(u[0]in e))return!1}for(;++i<s;){var l=(u=n[i])[0],f=e[l],p=u[1];if(c&&u[2]){if(void 0===f&&!(l in e))return!1}else{var y=new r;if(o)var h=o(f,p,l,e,t,y);if(!(void 0===h?a(p,f,3,o,y):h))return!1}}return!0}},function(e,t,n){"use strict";e.exports=function(){this.__data__=[],this.size=0}},function(e,t,n){"use strict";var r=n(32),a=Array.prototype.splice;e.exports=function(e){var t=this.__data__,n=r(t,e);return!(n<0)&&(n==t.length-1?t.pop():a.call(t,n,1),--this.size,!0)}},function(e,t,n){"use strict";var r=n(32);e.exports=function(e){var t=this.__data__,n=r(t,e);return n<0?void 0:t[n][1]}},function(e,t,n){"use strict";var r=n(32);e.exports=function(e){return r(this.__data__,e)>-1}},function(e,t,n){"use strict";var r=n(32);e.exports=function(e,t){var n=this.__data__,a=r(n,e);return a<0?(++this.size,n.push([e,t])):n[a][1]=t,this}},function(e,t,n){"use strict";var r=n(31);e.exports=function(){this.__data__=new r,this.size=0}},function(e,t,n){"use strict";e.exports=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.get(e)}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){"use strict";var r=n(31),a=n(41),o=n(43);e.exports=function(e,t){var n=this.__data__;if(n instanceof r){var i=n.__data__;if(!a||i.length<199)return i.push([e,t]),this.size=++n.size,this;n=this.__data__=new o(i)}return n.set(e,t),this.size=n.size,this}},function(e,t,n){"use strict";var r=n(42),a=n(97),o=n(19),i=n(57),s=/^\[object .+?Constructor\]$/,c=Function.prototype,u=Object.prototype,l=c.toString,f=u.hasOwnProperty,p=RegExp("^"+l.call(f).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!o(e)||a(e))&&(r(e)?p:s).test(i(e))}},function(e,t,n){"use strict";var r=n(33),a=Object.prototype,o=a.hasOwnProperty,i=a.toString,s=r?r.toStringTag:void 0;e.exports=function(e){var t=o.call(e,s),n=e[s];try{e[s]=void 0;var r=!0}catch(e){}var a=i.call(e);return r&&(t?e[s]=n:delete e[s]),a}},function(e,t,n){"use strict";var r=Object.prototype.toString;e.exports=function(e){return r.call(e)}},function(e,t,n){"use strict";var r,a=n(98),o=(r=/[^.]+$/.exec(a&&a.keys&&a.keys.IE_PROTO||""))?"Symbol(src)_1."+r:"";e.exports=function(e){return!!o&&o in e}},function(e,t,n){"use strict";var r=n(17)["__core-js_shared__"];e.exports=r},function(e,t,n){"use strict";e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,n){"use strict";var r=n(101),a=n(31),o=n(41);e.exports=function(){this.size=0,this.__data__={hash:new r,map:new(o||a),string:new r}}},function(e,t,n){"use strict";var r=n(102),a=n(103),o=n(104),i=n(105),s=n(106);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var r=e[t];this.set(r[0],r[1])}}c.prototype.clear=r,c.prototype.delete=a,c.prototype.get=o,c.prototype.has=i,c.prototype.set=s,e.exports=c},function(e,t,n){"use strict";var r=n(34);e.exports=function(){this.__data__=r?r(null):{},this.size=0}},function(e,t,n){"use strict";e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,n){"use strict";var r=n(34),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(r){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return a.call(t,e)?t[e]:void 0}},function(e,t,n){"use strict";var r=n(34),a=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return r?void 0!==t[e]:a.call(t,e)}},function(e,t,n){"use strict";var r=n(34);e.exports=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=r&&void 0===t?"__lodash_hash_undefined__":t,this}},function(e,t,n){"use strict";var r=n(35);e.exports=function(e){var t=r(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}e.exports=function(e){var t=r(e);return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,n){"use strict";var r=n(35);e.exports=function(e){return r(this,e).get(e)}},function(e,t,n){"use strict";var r=n(35);e.exports=function(e){return r(this,e).has(e)}},function(e,t,n){"use strict";var r=n(35);e.exports=function(e,t){var n=r(this,e),a=n.size;return n.set(e,t),this.size+=n.size==a?0:1,this}},function(e,t,n){"use strict";var r=n(40),a=n(59),o=n(116),i=n(118),s=n(133),c=n(16),u=n(47),l=n(48),f="[object Object]",p=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,y,h,d){var v=c(e),m=c(t),b=v?"[object Array]":s(e),g=m?"[object Array]":s(t),w=(b="[object Arguments]"==b?f:b)==f,k=(g="[object Arguments]"==g?f:g)==f,S=b==g;if(S&&u(e)){if(!u(t))return!1;v=!0,w=!1}if(S&&!w)return d||(d=new r),v||l(e)?a(e,t,n,y,h,d):o(e,t,b,n,y,h,d);if(!(1&n)){var x=w&&p.call(e,"__wrapped__"),O=k&&p.call(t,"__wrapped__");if(x||O){var P=x?e.value():e,j=O?t.value():t;return d||(d=new r),h(P,j,n,y,d)}}return!!S&&(d||(d=new r),i(e,t,n,y,h,d))}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1}},function(e,t,n){"use strict";var r=n(33),a=n(62),o=n(25),i=n(59),s=n(117),c=n(44),u=r?r.prototype:void 0,l=u?u.valueOf:void 0;e.exports=function(e,t,n,r,u,f,p){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!f(new a(e),new a(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return o(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var y=s;case"[object Set]":var h=1&r;if(y||(y=c),e.size!=t.size&&!h)return!1;var d=p.get(e);if(d)return d==t;r|=2,p.set(e,t);var v=i(y(e),y(t),r,u,f,p);return p.delete(e),v;case"[object Symbol]":if(l)return l.call(e)==l.call(t)}return!1}},function(e,t,n){"use strict";e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n}},function(e,t,n){"use strict";var r=n(119),a=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,o,i,s){var c=1&n,u=r(e),l=u.length;if(l!=r(t).length&&!c)return!1;for(var f=l;f--;){var p=u[f];if(!(c?p in t:a.call(t,p)))return!1}var y=s.get(e);if(y&&s.get(t))return y==t;var h=!0;s.set(e,t),s.set(t,e);for(var d=c;++f<l;){var v=e[p=u[f]],m=t[p];if(o)var b=c?o(m,v,p,t,e,s):o(v,m,p,e,t,s);if(!(void 0===b?v===m||i(v,m,n,o,s):b)){h=!1;break}d||(d="constructor"==p)}if(h&&!d){var g=e.constructor,w=t.constructor;g!=w&&"constructor"in e&&"constructor"in t&&!("function"==typeof g&&g instanceof g&&"function"==typeof w&&w instanceof w)&&(h=!1)}return s.delete(e),s.delete(t),h}},function(e,t,n){"use strict";var r=n(120),a=n(122),o=n(45);e.exports=function(e){return r(e,o,a)}},function(e,t,n){"use strict";var r=n(121),a=n(16);e.exports=function(e,t,n){var o=t(e);return a(e)?o:r(o,n(e))}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=t.length,a=e.length;++n<r;)e[a+n]=t[n];return e}},function(e,t,n){"use strict";var r=n(123),a=n(124),o=Object.prototype.propertyIsEnumerable,i=Object.getOwnPropertySymbols,s=i?function(e){return null==e?[]:(e=Object(e),r(i(e),(function(t){return o.call(e,t)})))}:a;e.exports=s},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length,a=0,o=[];++n<r;){var i=e[n];t(i,n,e)&&(o[a++]=i)}return o}},function(e,t,n){"use strict";e.exports=function(){return[]}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=Array(e);++n<e;)r[n]=t(n);return r}},function(e,t,n){"use strict";var r=n(24),a=n(22);e.exports=function(e){return a(e)&&"[object Arguments]"==r(e)}},function(e,t,n){"use strict";e.exports=function(){return!1}},function(e,t,n){"use strict";var r=n(24),a=n(49),o=n(22),i={};i["[object Float32Array]"]=i["[object Float64Array]"]=i["[object Int8Array]"]=i["[object Int16Array]"]=i["[object Int32Array]"]=i["[object Uint8Array]"]=i["[object Uint8ClampedArray]"]=i["[object Uint16Array]"]=i["[object Uint32Array]"]=!0,i["[object Arguments]"]=i["[object Array]"]=i["[object ArrayBuffer]"]=i["[object Boolean]"]=i["[object DataView]"]=i["[object Date]"]=i["[object Error]"]=i["[object Function]"]=i["[object Map]"]=i["[object Number]"]=i["[object Object]"]=i["[object RegExp]"]=i["[object Set]"]=i["[object String]"]=i["[object WeakMap]"]=!1,e.exports=function(e){return o(e)&&a(e.length)&&!!i[r(e)]}},function(e,t,n){"use strict";e.exports=function(e){return function(t){return e(t)}}},function(e,t,n){"use strict";(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(56),o="object"==r(t)&&t&&!t.nodeType&&t,i=o&&"object"==r(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o&&a.process,c=function(){try{var e=i&&i.require&&i.require("util").types;return e||s&&s.binding&&s.binding("util")}catch(e){}}();e.exports=c}).call(this,n(29)(e))},function(e,t,n){"use strict";var r=n(50),a=n(132),o=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return a(e);var t=[];for(var n in Object(e))o.call(e,n)&&"constructor"!=n&&t.push(n);return t}},function(e,t,n){"use strict";var r=n(64)(Object.keys,Object);e.exports=r},function(e,t,n){"use strict";var r=n(134),a=n(41),o=n(135),i=n(65),s=n(136),c=n(24),u=n(57),l=u(r),f=u(a),p=u(o),y=u(i),h=u(s),d=c;(r&&"[object DataView]"!=d(new r(new ArrayBuffer(1)))||a&&"[object Map]"!=d(new a)||o&&"[object Promise]"!=d(o.resolve())||i&&"[object Set]"!=d(new i)||s&&"[object WeakMap]"!=d(new s))&&(d=function(e){var t=c(e),n="[object Object]"==t?e.constructor:void 0,r=n?u(n):"";if(r)switch(r){case l:return"[object DataView]";case f:return"[object Map]";case p:return"[object Promise]";case y:return"[object Set]";case h:return"[object WeakMap]"}return t}),e.exports=d},function(e,t,n){"use strict";var r=n(21)(n(17),"DataView");e.exports=r},function(e,t,n){"use strict";var r=n(21)(n(17),"Promise");e.exports=r},function(e,t,n){"use strict";var r=n(21)(n(17),"WeakMap");e.exports=r},function(e,t,n){"use strict";var r=n(66),a=n(45);e.exports=function(e){for(var t=a(e),n=t.length;n--;){var o=t[n],i=e[o];t[n]=[o,i,r(i)]}return t}},function(e,t,n){"use strict";var r=n(58),a=n(139),o=n(146),i=n(53),s=n(66),c=n(67),u=n(27);e.exports=function(e,t){return i(e)&&s(t)?c(u(e),t):function(n){var i=a(n,e);return void 0===i&&i===t?o(n,e):r(t,i,3)}}},function(e,t,n){"use strict";var r=n(51);e.exports=function(e,t,n){var a=null==e?void 0:r(e,t);return void 0===a?n:a}},function(e,t,n){"use strict";var r=n(141),a=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,o=/\\(\\)?/g,i=r((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(a,(function(e,n,r,a){t.push(r?a.replace(o,"$1"):n||e)})),t}));e.exports=i},function(e,t,n){"use strict";var r=n(142);e.exports=function(e){var t=r(e,(function(e){return 500===n.size&&n.clear(),e})),n=t.cache;return t}},function(e,t,n){"use strict";var r=n(43);function a(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function n(){var r=arguments,a=t?t.apply(this,r):r[0],o=n.cache;if(o.has(a))return o.get(a);var i=e.apply(this,r);return n.cache=o.set(a,i)||o,i};return n.cache=new(a.Cache||r),n}a.Cache=r,e.exports=a},function(e,t,n){"use strict";var r=n(144);e.exports=function(e){return null==e?"":r(e)}},function(e,t,n){"use strict";var r=n(33),a=n(145),o=n(16),i=n(37),s=r?r.prototype:void 0,c=s?s.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(o(t))return a(t,e)+"";if(i(t))return c?c.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,r=null==e?0:e.length,a=Array(r);++n<r;)a[n]=t(e[n],n,e);return a}},function(e,t,n){"use strict";var r=n(147),a=n(148);e.exports=function(e,t){return null!=e&&a(e,t,r)}},function(e,t,n){"use strict";e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,n){"use strict";var r=n(52),a=n(46),o=n(16),i=n(36),s=n(49),c=n(27);e.exports=function(e,t,n){for(var u=-1,l=(t=r(t,e)).length,f=!1;++u<l;){var p=c(t[u]);if(!(f=null!=e&&n(e,p)))break;e=e[p]}return f||++u!=l?f:!!(l=null==e?0:e.length)&&s(l)&&i(p,l)&&(o(e)||a(e))}},function(e,t,n){"use strict";var r=n(150),a=n(151),o=n(53),i=n(27);e.exports=function(e){return o(e)?r(i(e)):a(e)}},function(e,t,n){"use strict";e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,n){"use strict";var r=n(51);e.exports=function(e){return function(t){return r(t,e)}}},function(e,t,n){"use strict";var r=n(153),a=n(36),o=Array.prototype.splice;e.exports=function(e,t){for(var n=e?t.length:0,i=n-1;n--;){var s=t[n];if(n==i||s!==c){var c=s;a(s)?o.call(e,s,1):r(e,s)}}return e}},function(e,t,n){"use strict";var r=n(52),a=n(154),o=n(155),i=n(27);e.exports=function(e,t){return t=r(t,e),null==(e=o(e,t))||delete e[i(a(t))]}},function(e,t,n){"use strict";e.exports=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}},function(e,t,n){"use strict";var r=n(51),a=n(156);e.exports=function(e,t){return t.length<2?e:r(e,a(t,0,-1))}},function(e,t,n){"use strict";e.exports=function(e,t,n){var r=-1,a=e.length;t<0&&(t=-t>a?0:a+t),(n=n>a?a:n)<0&&(n+=a),a=t>n?0:n-t>>>0,t>>>=0;for(var o=Array(a);++r<a;)o[r]=e[r+t];return o}},function(e,t,n){"use strict";var r=n(39),a=n(26),o=n(45);e.exports=function(e){return function(t,n,i){var s=Object(t);if(!a(t)){var c=r(n,3);t=o(t),n=function(e){return c(s[e],e,s)}}var u=e(t,n,i);return u>-1?s[c?t[u]:u]:void 0}}},function(e,t,n){"use strict";var r=n(68),a=n(39),o=n(159),i=Math.max;e.exports=function(e,t,n){var s=null==e?0:e.length;if(!s)return-1;var c=null==n?0:o(n);return c<0&&(c=i(s+c,0)),r(e,a(t,3),c)}},function(e,t,n){"use strict";var r=n(160);e.exports=function(e){var t=r(e),n=t%1;return t==t?n?t-n:t:0}},function(e,t,n){"use strict";var r=n(161);e.exports=function(e){return e?(e=r(e))===1/0||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},function(e,t,n){"use strict";var r=n(19),a=n(37),o=/^\s+|\s+$/g,i=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,u=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(a(e))return NaN;if(r(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=r(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(o,"");var n=s.test(e);return n||c.test(e)?u(e.slice(2),n?2:8):i.test(e)?NaN:+e}},function(e,t,n){"use strict";var r=n(163)();e.exports=r},function(e,t,n){"use strict";e.exports=function(e){return function(t,n,r){for(var a=-1,o=Object(t),i=r(t),s=i.length;s--;){var c=i[e?s:++a];if(!1===n(o[c],c,o))break}return t}}},function(e,t,n){"use strict";var r=n(70),a=n(165),o=n(166),i=n(168),s=n(169),c=n(46),u=n(16),l=n(171),f=n(47),p=n(42),y=n(19),h=n(172),d=n(48),v=n(73),m=n(173);e.exports=function(e,t,n,b,g,w,k){var S=v(e,n),x=v(t,n),O=k.get(x);if(O)r(e,n,O);else{var P=w?w(S,x,n+"",e,t,k):void 0,j=void 0===P;if(j){var D=u(x),C=!D&&f(x),I=!D&&!C&&d(x);P=x,D||C||I?u(S)?P=S:l(S)?P=i(S):C?(j=!1,P=a(x,!0)):I?(j=!1,P=o(x,!0)):P=[]:h(x)||c(x)?(P=S,c(S)?P=m(S):y(S)&&!p(S)||(P=s(x))):j=!1}j&&(k.set(x,P),g(P,x,b,w,k),k.delete(x)),r(e,n,P)}}},function(e,t,n){"use strict";(function(e){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(17),o="object"==r(t)&&t&&!t.nodeType&&t,i=o&&"object"==r(e)&&e&&!e.nodeType&&e,s=i&&i.exports===o?a.Buffer:void 0,c=s?s.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,r=c?c(n):new e.constructor(n);return e.copy(r),r}}).call(this,n(29)(e))},function(e,t,n){"use strict";var r=n(167);e.exports=function(e,t){var n=t?r(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}},function(e,t,n){"use strict";var r=n(62);e.exports=function(e){var t=new e.constructor(e.byteLength);return new r(t).set(new r(e)),t}},function(e,t,n){"use strict";e.exports=function(e,t){var n=-1,r=e.length;for(t||(t=Array(r));++n<r;)t[n]=e[n];return t}},function(e,t,n){"use strict";var r=n(170),a=n(72),o=n(50);e.exports=function(e){return"function"!=typeof e.constructor||o(e)?{}:r(a(e))}},function(e,t,n){"use strict";var r=n(19),a=Object.create,o=function(){function e(){}return function(t){if(!r(t))return{};if(a)return a(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();e.exports=o},function(e,t,n){"use strict";var r=n(26),a=n(22);e.exports=function(e){return a(e)&&r(e)}},function(e,t,n){"use strict";var r=n(24),a=n(72),o=n(22),i=Function.prototype,s=Object.prototype,c=i.toString,u=s.hasOwnProperty,l=c.call(Object);e.exports=function(e){if(!o(e)||"[object Object]"!=r(e))return!1;var t=a(e);if(null===t)return!0;var n=u.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&c.call(n)==l}},function(e,t,n){"use strict";var r=n(174),a=n(74);e.exports=function(e){return r(e,a(e))}},function(e,t,n){"use strict";var r=n(175),a=n(55);e.exports=function(e,t,n,o){var i=!n;n||(n={});for(var s=-1,c=t.length;++s<c;){var u=t[s],l=o?o(n[u],e[u],u,n,e):void 0;void 0===l&&(l=e[u]),i?a(n,u,l):r(n,u,l)}return n}},function(e,t,n){"use strict";var r=n(55),a=n(25),o=Object.prototype.hasOwnProperty;e.exports=function(e,t,n){var i=e[t];o.call(e,t)&&a(i,n)&&(void 0!==n||t in e)||r(e,t,n)}},function(e,t,n){"use strict";var r=n(19),a=n(50),o=n(177),i=Object.prototype.hasOwnProperty;e.exports=function(e){if(!r(e))return o(e);var t=a(e),n=[];for(var s in e)("constructor"!=s||!t&&i.call(e,s))&&n.push(s);return n}},function(e,t,n){"use strict";e.exports=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t}},function(e,t,n){"use strict";var r=n(54),a=n(179),o=n(181);e.exports=function(e,t){return o(a(e,t,r),e+"")}},function(e,t,n){"use strict";var r=n(180),a=Math.max;e.exports=function(e,t,n){return t=a(void 0===t?e.length-1:t,0),function(){for(var o=arguments,i=-1,s=a(o.length-t,0),c=Array(s);++i<s;)c[i]=o[t+i];i=-1;for(var u=Array(t+1);++i<t;)u[i]=o[i];return u[t]=n(c),r(e,this,u)}}},function(e,t,n){"use strict";e.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}},function(e,t,n){"use strict";var r=n(182),a=n(184)(r);e.exports=a},function(e,t,n){"use strict";var r=n(183),a=n(71),o=n(54),i=a?function(e,t){return a(e,"toString",{configurable:!0,enumerable:!1,value:r(t),writable:!0})}:o;e.exports=i},function(e,t,n){"use strict";e.exports=function(e){return function(){return e}}},function(e,t,n){"use strict";var r=Date.now;e.exports=function(e){var t=0,n=0;return function(){var a=r(),o=16-(a-n);if(n=a,o>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,n){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var a=n(25),o=n(26),i=n(36),s=n(19);e.exports=function(e,t,n){if(!s(n))return!1;var c=r(t);return!!("number"==c?o(n)&&i(t,n.length):"string"==c&&t in n)&&a(n[t],e)}},function(e,t,n){"use strict";var r=n(187);e.exports=function(e,t){return!!(null==e?0:e.length)&&r(e,t,0)>-1}},function(e,t,n){"use strict";var r=n(68),a=n(188),o=n(189);e.exports=function(e,t,n){return t==t?o(e,t,n):r(e,a,n)}},function(e,t,n){"use strict";e.exports=function(e){return e!=e}},function(e,t,n){"use strict";e.exports=function(e,t,n){for(var r=n-1,a=e.length;++r<a;)if(e[r]===t)return r;return-1}},function(e,t,n){"use strict";e.exports=function(e,t,n){for(var r=-1,a=null==e?0:e.length;++r<a;)if(n(t,e[r]))return!0;return!1}},function(e,t,n){"use strict";var r=n(65),a=n(192),o=n(44),i=r&&1/o(new r([,-0]))[1]==1/0?function(e){return new r(e)}:a;e.exports=i},function(e,t,n){"use strict";e.exports=function(){}},function(e,t,n){"use strict";(function(e,t){!function(e,n){if(!e.setImmediate){var r,a,o,i,s,c=1,u={},l=!1,f=e.document,p=Object.getPrototypeOf&&Object.getPrototypeOf(e);p=p&&p.setTimeout?p:e,"[object process]"==={}.toString.call(e.process)?r=function(e){t.nextTick((function(){h(e)}))}:!function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?e.MessageChannel?((o=new MessageChannel).port1.onmessage=function(e){h(e.data)},r=function(e){o.port2.postMessage(e)}):f&&"onreadystatechange"in f.createElement("script")?(a=f.documentElement,r=function(e){var t=f.createElement("script");t.onreadystatechange=function(){h(e),t.onreadystatechange=null,a.removeChild(t),t=null},a.appendChild(t)}):r=function(e){setTimeout(h,0,e)}:(i="setImmediate$"+Math.random()+"$",s=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(i)&&h(+t.data.slice(i.length))},e.addEventListener?e.addEventListener("message",s,!1):e.attachEvent("onmessage",s),r=function(t){e.postMessage(i+t,"*")}),p.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var a={callback:e,args:t};return u[c]=a,r(c),c++},p.clearImmediate=y}function y(e){delete u[e]}function h(e){if(l)setTimeout(h,0,e);else{var t=u[e];if(t){l=!0;try{!function(e){var t=e.callback,n=e.args;switch(n.length){case 0:t();break;case 1:t(n[0]);break;case 2:t(n[0],n[1]);break;case 3:t(n[0],n[1],n[2]);break;default:t.apply(void 0,n)}}(t)}finally{y(e),l=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(30),n(194))},function(e,t,n){"use strict";var r,a,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function c(e){if(r===setTimeout)return setTimeout(e,0);if((r===i||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:i}catch(e){r=i}try{a="function"==typeof clearTimeout?clearTimeout:s}catch(e){a=s}}();var u,l=[],f=!1,p=-1;function y(){f&&u&&(f=!1,u.length?l=u.concat(l):p=-1,l.length&&h())}function h(){if(!f){var e=c(y);f=!0;for(var t=l.length;t;){for(u=l,l=[];++p<t;)u&&u[p].run();p=-1,t=l.length}u=null,f=!1,function(e){if(a===clearTimeout)return clearTimeout(e);if((a===s||!a)&&clearTimeout)return a=clearTimeout,clearTimeout(e);try{a(e)}catch(t){try{return a.call(null,e)}catch(t){return a.call(this,e)}}}(e)}}function d(e,t){this.fun=e,this.array=t}function v(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new d(e,t)),1!==l.length||f||c(h)},d.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=v,o.addListener=v,o.once=v,o.off=v,o.removeListener=v,o.removeAllListeners=v,o.emit=v,o.prependListener=v,o.prependOnceListener=v,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t,n){"use strict";n.r(t),n.d(t,"SNApplication",(function(){return Xl})),n.d(t,"SNProtocolService",(function(){return Ds})),n.d(t,"KeyMode",(function(){return us})),n.d(t,"SNProtocolOperator001",(function(){return Ri})),n.d(t,"SNProtocolOperator002",(function(){return Wi})),n.d(t,"SNProtocolOperator003",(function(){return Xi})),n.d(t,"SNProtocolOperator004",(function(){return ls})),n.d(t,"DeviceInterface",(function(){return tf})),n.d(t,"SNItem",(function(){return d.d})),n.d(t,"ItemMutator",(function(){return d.b})),n.d(t,"AppDataField",(function(){return d.a})),n.d(t,"SNItemsKey",(function(){return Tt})),n.d(t,"SNPredicate",(function(){return C.a})),n.d(t,"SNNote",(function(){return kt})),n.d(t,"NoteMutator",(function(){return St})),n.d(t,"SNTag",(function(){return rt})),n.d(t,"TagMutator",(function(){return at})),n.d(t,"SNSmartTag",(function(){return lt})),n.d(t,"SNActionsExtension",(function(){return qe})),n.d(t,"Action",(function(){return Ke})),n.d(t,"SNTheme",(function(){return Pe})),n.d(t,"SNComponent",(function(){return ye})),n.d(t,"ComponentAction",(function(){return Z})),n.d(t,"ComponentMutator",(function(){return he})),n.d(t,"SNEditor",(function(){return Ae})),n.d(t,"SNUserPrefs",(function(){return N})),n.d(t,"UserPrefsMutator",(function(){return U})),n.d(t,"WebPrefKey",(function(){return x})),n.d(t,"MutationType",(function(){return d.c})),n.d(t,"ComponentArea",(function(){return X})),n.d(t,"LiveItem",(function(){return af})),n.d(t,"SNComponentManager",(function(){return jr})),n.d(t,"HistorySession",(function(){return Hs})),n.d(t,"ItemHistory",(function(){return Ws})),n.d(t,"ItemHistoryEntry",(function(){return Is})),n.d(t,"SNPrivileges",(function(){return ee})),n.d(t,"ProtectedAction",(function(){return L})),n.d(t,"PrivilegeCredential",(function(){return V})),n.d(t,"PayloadManager",(function(){return Na})),n.d(t,"ItemManager",(function(){return Hc})),n.d(t,"SNHttpService",(function(){return Un})),n.d(t,"ChallengeService",(function(){return Ul})),n.d(t,"PureService",(function(){return Gt.a})),n.d(t,"ApplicationService",(function(){return of.a})),n.d(t,"SNStorageService",(function(){return un})),n.d(t,"StoragePersistencePolicies",(function(){return Bt})),n.d(t,"StorageEncryptionPolicies",(function(){return Ht})),n.d(t,"StorageValueModes",(function(){return zt})),n.d(t,"ValueModesKeys",(function(){return qt})),n.d(t,"Challenge",(function(){return g})),n.d(t,"ChallengeReason",(function(){return y})),n.d(t,"ChallengeResponse",(function(){return k})),n.d(t,"ChallengeType",(function(){return p})),n.d(t,"challengeTypeToString",(function(){return S})),n.d(t,"ChallengeValue",(function(){return w})),n.d(t,"SNSyncService",(function(){return Dl})),n.d(t,"SyncSources",(function(){return jl})),n.d(t,"SyncModes",(function(){return Pl})),n.d(t,"SyncQueueStrategy",(function(){return Ol})),n.d(t,"SortPayloadsByRecentAndContentPriority",(function(){return zc})),n.d(t,"SNSessionManager",(function(){return _n})),n.d(t,"SNMigrationService",(function(){return ui})),n.d(t,"ButtonType",(function(){return cn})),n.d(t,"SNHistoryManager",(function(){return oc})),n.d(t,"SNPrivilegesService",(function(){return kc})),n.d(t,"SNSingletonManager",(function(){return Za})),n.d(t,"SNApiService",(function(){return nr})),n.d(t,"Copy",(function(){return u.a})),n.d(t,"findInArray",(function(){return u.l})),n.d(t,"isNullOrUndefined",(function(){return u.p})),n.d(t,"deepMerge",(function(){return u.h})),n.d(t,"extendArray",(function(){return u.j})),n.d(t,"removeFromIndex",(function(){return u.C})),n.d(t,"subtractFromArray",(function(){return u.G})),n.d(t,"arrayByDifference",(function(){return u.c})),n.d(t,"uniqCombineObjArrays",(function(){return u.J})),n.d(t,"greaterOfTwoDates",(function(){return u.n})),n.d(t,"getGlobalScope",(function(){return u.m})),n.d(t,"removeFromArray",(function(){return u.B})),n.d(t,"addIfUnique",(function(){return u.b})),n.d(t,"dictToArray",(function(){return u.i})),n.d(t,"truncateHexString",(function(){return u.I})),n.d(t,"jsonParseEmbeddedKeys",(function(){return u.v})),n.d(t,"topLevelCompare",(function(){return u.H})),n.d(t,"Uuid",(function(){return h})),n.d(t,"EncryptionIntent",(function(){return Jt.a})),n.d(t,"isLocalStorageIntent",(function(){return Jt.e})),n.d(t,"isFileIntent",(function(){return Jt.d})),n.d(t,"isDecryptedIntent",(function(){return Jt.c})),n.d(t,"intentRequiresEncryption",(function(){return Jt.b})),n.d(t,"ContentType",(function(){return P.a})),n.d(t,"CreateItemFromPayload",(function(){return Ut})),n.d(t,"Uuids",(function(){return s.b})),n.d(t,"FillItemContent",(function(){return s.a})),n.d(t,"ApplicationEvent",(function(){return c.a})),n.d(t,"Environment",(function(){return er})),n.d(t,"Platform",(function(){return tr})),n.d(t,"isEnvironmentWebOrDesktop",(function(){return fr})),n.d(t,"isEnvironmentMobile",(function(){return pr})),n.d(t,"platformFromString",(function(){return lr})),n.d(t,"SyncEvent",(function(){return Ua.a})),n.d(t,"MutableCollection",(function(){return Vr})),n.d(t,"ImmutablePayloadCollection",(function(){return Jr})),n.d(t,"ItemCollection",(function(){return Ec})),n.d(t,"CollectionSort",(function(){return bc})),n.d(t,"CreateMaxPayloadFromAnyObject",(function(){return j.e})),n.d(t,"CreateSourcedPayloadFromObject",(function(){return j.f})),n.d(t,"CreateIntentPayloadFromObject",(function(){return j.d})),n.d(t,"CreateEncryptionParameters",(function(){return j.c})),n.d(t,"PayloadByMerging",(function(){return j.g})),n.d(t,"CopyPayload",(function(){return j.b})),n.d(t,"PayloadSource",(function(){return D.a})),n.d(t,"isPayloadSourceRetrieved",(function(){return D.b})),n.d(t,"ProtocolVersion",(function(){return xt.a})),n.d(t,"PayloadFormat",(function(){return ft.a})),n.d(t,"PurePayload",(function(){return sf.a})),n.d(t,"PayloadField",(function(){return ua.a})),n.d(t,"StorageKey",(function(){return Vt})),n.d(t,"BaseMigration",(function(){return Yo})),n.d(t,"PrivilegeSessionLength",(function(){return ac}));var r={};n.r(r),n.d(r,"Migration20200115",(function(){return Uo}));var a,o=n(0),i=n.n(o),s=n(11);!function(e){e[e.PreparingForLaunch_0=0]="PreparingForLaunch_0",e[e.ReadyForLaunch_05=.5]="ReadyForLaunch_05",e[e.StorageDecrypted_09=.9]="StorageDecrypted_09",e[e.Launched_10=1]="Launched_10",e[e.LoadingDatabase_11=1.1]="LoadingDatabase_11",e[e.LoadedDatabase_12=1.2]="LoadedDatabase_12",e[e.FullSyncCompleted_13=1.3]="FullSyncCompleted_13",e[e.SignedIn_30=3]="SignedIn_30"}(a||(a={}));var c=n(13),u=n(1);function l(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var p,y,h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n,r,a,o;return t=e,n=null,r=[{key:"SetGenerators",value:function(e,t){this.syncUuidFunc=t,this.asyncUuidFunc=e}},{key:"canGenSync",value:function(){return!Object(u.p)(this.syncUuidFunc)}},{key:"GenerateUuid",value:(a=i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.syncUuidFunc){e.next=4;break}return e.abrupt("return",this.syncUuidFunc());case 4:return e.abrupt("return",this.asyncUuidFunc());case 5:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){l(o,n,r,i,s,"next",e)}function s(e){l(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})},{key:"GenerateUuidSynchronously",value:function(){return this.syncUuidFunc()}}],n&&f(t.prototype,n),r&&f(t,r),e}(),d=n(6);function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function b(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}!function(e){e[e.LocalPasscode=1]="LocalPasscode",e[e.AccountPassword=2]="AccountPassword",e[e.Biometric=3]="Biometric"}(p||(p={})),function(e){e[e.ApplicationUnlock=1]="ApplicationUnlock",e[e.ResaveRootKey=2]="ResaveRootKey",e[e.ProtocolUpgrade=3]="ProtocolUpgrade",e[e.Migration=4]="Migration"}(y||(y={}));var g=function e(t,n){b(this,e),this.types=t,this.reason=n,this.id=(new Date).getTime(),Object.freeze(this)},w=function e(t,n){b(this,e),this.type=t,this.value=n,Object.freeze(this)},k=function(){function e(t,n,r){b(this,e),this.challenge=t,this.values=n,this.artifacts=r,Object.freeze(this)}var t,n,r;return t=e,(n=[{key:"getValueForType",value:function(e){return this.values.find((function(t){return t.type===e}))}}])&&m(t.prototype,n),r&&m(t,r),e}();function S(e){var t;return(v(t={},p.LocalPasscode,"application passcode"),v(t,p.AccountPassword,"account password"),v(t,p.Biometric,"biometrics"),t)[e]}var x,O,P=n(4),j=n(2),D=n(3),C=n(15);function I(e){return(I="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function E(e,t,n){return t&&R(e.prototype,t),n&&R(e,n),e}function A(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&M(e,t)}function M(e,t){return(M=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=F(e);if(t){var a=F(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return K(this,n)}}function K(e,t){return!t||"object"!==I(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function F(e){return(F=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.TagsPanelWidth="tagsPanelWidth",e.NotesPanelWidth="notesPanelWidth",e.EditorWidth="editorWidth",e.EditorLeft="editorLeft",e.EditorMonospaceEnabled="monospaceFont",e.EditorSpellcheck="spellcheck",e.EditorResizersEnabled="marginResizersEnabled",e.SortNotesBy="sortBy",e.SortNotesReverse="sortReverse",e.NotesShowArchived="showArchived",e.NotesHidePinned="hidePinned",e.NotesHideNotePreview="hideNotePreview",e.NotesHideDate="hideDate"}(x||(x={})),function(e){e.SortNotesBy="sortBy",e.SortNotesReverse="sortReverse",e.NotesShowArchived="showArchived",e.NotesHidePinned="hidePinned",e.NotesHideNotePreview="hideNotePreview",e.NotesHideDate="hideDate",e.ThemeData="themePreferences",e.LastExportDate="lastExportDate",e.DoNotWarnUnsupportedEditors="doNotShowAgainUnsupportedEditors"}(O||(O={}));var L,V,N=function(e){A(n,e);var t=T(n);function n(){return _(this,n),t.apply(this,arguments)}return E(n,[{key:"getPref",value:function(e){return this.getAppDomainValue(e)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new C.a("content_type","=",this.content_type)}}]),n}(d.d),U=function(e){A(n,e);var t=T(n);function n(){return _(this,n),t.apply(this,arguments)}return E(n,[{key:"setWebPref",value:function(e,t){this.setAppDataItem(e,t)}},{key:"setMobilePref",value:function(e,t){this.setAppDataItem(e,t)}}]),n}(d.b);function W(e){return(W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function B(e,t,n){return(B="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Y(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function H(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function z(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function q(e,t,n){return t&&z(e.prototype,t),n&&z(e,n),e}function J(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&G(e,t)}function G(e,t){return(G=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function $(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Y(e);if(t){var a=Y(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Q(this,n)}}function Q(e,t){return!t||"object"!==W(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Y(e){return(Y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.ManageExtensions="ActionManageExtensions",e.ManageBackups="ActionManageBackups",e.ViewProtectedNotes="ActionViewProtectedNotes",e.ManagePrivileges="ActionManagePrivileges",e.ManagePasscode="ActionManagePasscode",e.DeleteNote="ActionDeleteNote"}(L||(L={})),function(e){e.AccountPassword="CredentialAccountPassword",e.LocalPasscode="CredentialLocalPasscode"}(V||(V={}));var X,Z,ee=function(e){J(n,e);var t=$(n);function n(e){var r;return H(this,n),(r=t.call(this,e)).privilegeMap={},r.privilegeMap=e.safeContent.desktopPrivileges||{},r}return q(n,[{key:"getCredentialsForAction",value:function(e){return this.privilegeMap[e]||[]}},{key:"isCredentialRequiredForAction",value:function(e,t){return this.getCredentialsForAction(e).includes(t)}},{key:"isSingleton",get:function(){return!0}},{key:"singletonPredicate",get:function(){return new C.a("content_type","=",this.content_type)}}]),n}(d.d),te=function(e){J(n,e);var t=$(n);function n(e,r){var a;return H(this,n),(a=t.call(this,e,r)).privilegeMap={},a.privileges=e,a.privilegeMap=Object(u.a)(a.payload.safeContent.desktopPrivileges||{}),a}return q(n,[{key:"getResult",value:function(){return this.content&&(this.content.desktopPrivileges=this.privilegeMap),B(Y(n.prototype),"getResult",this).call(this)}},{key:"setCredentialsForAction",value:function(e,t){this.privilegeMap[e]=t}},{key:"toggleCredentialForAction",value:function(e,t){this.privileges.isCredentialRequiredForAction(e,t)?this.removeCredentialForAction(e,t):this.addCredentialForAction(e,t)}},{key:"removeCredentialForAction",value:function(e,t){Object(u.B)(this.privilegeMap[e],t)}},{key:"addCredentialForAction",value:function(e,t){var n=this.privileges.getCredentialsForAction(e).slice();n.push(t),this.setCredentialsForAction(e,n)}}]),n}(d.b),ne=n(14);function re(e){return(re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ae(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function oe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ie(e,t,n){return t&&oe(e.prototype,t),n&&oe(e,n),e}function se(e,t,n){return(se="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=pe(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ce(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ue(e,t)}function ue(e,t){return(ue=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function le(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=pe(e);if(t){var a=pe(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return fe(this,n)}}function fe(e,t){return!t||"object"!==re(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function pe(e){return(pe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.Editor="editor-editor",e.Themes="themes",e.TagsList="tags-list",e.EditorStack="editor-stack",e.NoteTags="note-tags",e.Rooms="rooms",e.Modal="modal",e.Any="*"}(X||(X={})),function(e){e.SetSize="set-size",e.StreamItems="stream-items",e.StreamContextItem="stream-context-item",e.SaveItems="save-items",e.SelectItem="select-item",e.AssociateItem="associate-item",e.DeassociateItem="deassociate-item",e.ClearSelection="clear-selection",e.CreateItem="create-item",e.CreateItems="create-items",e.DeleteItems="delete-items",e.SetComponentData="set-component-data",e.InstallLocalComponent="install-local-component",e.ToggleActivateComponent="toggle-activate-component",e.RequestPermissions="request-permissions",e.PresentConflictResolution="present-conflict-resolution",e.DuplicateItem="duplicate-item",e.ComponentRegistered="component-registered",e.ActivateThemes="themes",e.Reply="reply",e.SaveSuccess="save-success",e.SaveError="save-error"}(Z||(Z={}));var ye=function(e){ce(n,e);var t=le(n);function n(e){var r;return ae(this,n),(r=t.call(this,e)).permissions=[],r.componentData=r.payload.safeContent.componentData||{},r.legacy_url=r.payload.safeContent.legacy_url,r.hosted_url=r.payload.safeContent.hosted_url||r.payload.safeContent.url,r.local_url=r.payload.safeContent.local_url,r.valid_until=new Date(r.payload.safeContent.valid_until),r.offlineOnly=r.payload.safeContent.offlineOnly,r.name=r.payload.safeContent.name,r.area=r.payload.safeContent.area,r.package_info=r.payload.safeContent.package_info,r.permissions=r.payload.safeContent.permissions||[],r.active=r.payload.safeContent.active,r.autoupdateDisabled=r.payload.safeContent.autoupdateDisabled,r.disassociatedItemIds=r.payload.safeContent.disassociatedItemIds||[],r.associatedItemIds=r.payload.safeContent.associatedItemIds||[],r.isMobileDefault=r.payload.safeContent.isMobileDefault,r.legacy_url=r.payload.safeContent.hosted_url?void 0:r.payload.safeContent.url,r}return ie(n,[{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?se(pe(n.prototype),"strategyWhenConflictingWithItem",this).call(this,e):ne.a.KeepLeft}},{key:"isEditor",value:function(){return this.area===X.Editor}},{key:"isTheme",value:function(){return this.content_type===P.a.Theme||this.area===X.Themes}},{key:"isDefaultEditor",value:function(){return!0===this.getAppDomainValue(d.a.DefaultEditor)}},{key:"getLastSize",value:function(){return this.getAppDomainValue(d.a.LastSize)}},{key:"acceptsThemes",value:function(){var e;return null===(e=this.payload.safeContent.package_info)||void 0===e?void 0:e.acceptsThemes}},{key:"getClientDataKey",value:function(){return this.legacy_url?this.legacy_url:this.uuid}},{key:"hasValidHostedUrl",value:function(){return this.hosted_url||this.legacy_url}},{key:"contentKeysToIgnoreWhenCheckingEquality",value:function(){return["active","disassociatedItemIds","associatedItemIds"].concat(se(pe(n.prototype),"contentKeysToIgnoreWhenCheckingEquality",this).call(this))}},{key:"isAssociative",value:function(){return n.associativeAreas().includes(this.area)}},{key:"isExplicitlyEnabledForItem",value:function(e){return-1!==this.associatedItemIds.indexOf(e)}},{key:"isExplicitlyDisabledForItem",value:function(e){return-1!==this.disassociatedItemIds.indexOf(e)}}],[{key:"associativeAreas",value:function(){return[X.Editor]}}]),n}(d.d),he=function(e){ce(n,e);var t=le(n);function n(){return ae(this,n),t.apply(this,arguments)}return ie(n,[{key:"associateWithItem",value:function(e){var t=this.typedContent.associatedItemIds||[];Object(u.b)(t,e),this.typedContent.associatedItemIds=t}},{key:"disassociateWithItem",value:function(e){var t=this.typedContent.disassociatedItemIds||[];Object(u.b)(t,e),this.typedContent.disassociatedItemIds=t}},{key:"removeAssociatedItemId",value:function(e){Object(u.B)(this.typedContent.associatedItemIds||[],e)}},{key:"removeDisassociatedItemId",value:function(e){Object(u.B)(this.typedContent.disassociatedItemIds||[],e)}},{key:"setLastSize",value:function(e){this.setAppDataItem(d.a.LastSize,e)}},{key:"typedContent",get:function(){return this.content}},{key:"active",set:function(e){this.typedContent.active=e}},{key:"isMobileDefault",set:function(e){this.typedContent.isMobileDefault=e}},{key:"defaultEditor",set:function(e){this.setAppDataItem(d.a.DefaultEditor,e)}},{key:"componentData",set:function(e){this.typedContent.componentData=e}},{key:"package_info",set:function(e){this.typedContent.package_info=e}},{key:"local_url",set:function(e){this.typedContent.local_url=e}},{key:"hosted_url",set:function(e){this.typedContent.hosted_url=e}},{key:"permissions",set:function(e){this.typedContent.permissions=e}}]),n}(d.b);function de(e){return(de="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ve(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function me(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function be(e,t,n){return t&&me(e.prototype,t),n&&me(e,n),e}function ge(e,t,n){return(ge="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Oe(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function we(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ke(e,t)}function ke(e,t){return(ke=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Se(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Oe(e);if(t){var a=Oe(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return xe(this,n)}}function xe(e,t){return!t||"object"!==de(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Oe(e){return(Oe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Pe=function(e){we(n,e);var t=Se(n);function n(){var e;return ve(this,n),(e=t.apply(this,arguments)).area=X.Themes,e}return be(n,[{key:"isLayerable",value:function(){return this.package_info&&this.package_info.layerable}},{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?ge(Oe(n.prototype),"strategyWhenConflictingWithItem",this).call(this,e):ne.a.KeepLeft}},{key:"getMobileRules",value:function(){return this.getAppDomainValue(d.a.MobileRules)||{constants:{},rules:{}}}},{key:"hasMobileRules",value:function(){return this.getAppDomainValue(d.a.MobileRules)}},{key:"getNotAvailOnMobile",value:function(){return this.getAppDomainValue(d.a.NotAvailableOnMobile)}},{key:"isMobileActive",value:function(){return this.getAppDomainValue(d.a.MobileActive)}}]),n}(ye);d.b;function je(e){return(je="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function De(e,t){return(De=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ce(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=_e(e);if(t){var a=_e(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ie(this,n)}}function Ie(e,t){return!t||"object"!==je(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _e(e){return(_e=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Re,Ee,Ae=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&De(e,t)}(n,e);var t=Ce(n);function n(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),(r=t.call(this,e)).notes=[],r.data={},r.url=e.safeContent.url,r.name=e.safeContent.name,r.data=e.safeContent.data||{},r.isDefault=e.safeContent.default,r.systemEditor=e.safeContent.systemEditor,r}return n}(d.d),Me=n(38),Te=n.n(Me);!function(e){e.Encrypted="encrypted",e.Decrypted="decrypted"}(Re||(Re={})),function(e){e.Get="get",e.Render="render",e.Show="show",e.Post="post",e.Nested="nested"}(Ee||(Ee={}));var Ke=function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Te()(this,t),this.running=t.running||!1,this.error=t.error||!1,this.lastExecuted&&(this.lastExecuted=new Date(this.lastExecuted))};function Fe(e){return(Fe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Le(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ve(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ne(e,t,n){return t&&Ve(e.prototype,t),n&&Ve(e,n),e}function Ue(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&We(e,t)}function We(e,t){return(We=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Be(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ze(e);if(t){var a=ze(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return He(this,n)}}function He(e,t){return!t||"object"!==Fe(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ze(e){return(ze=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var qe=function(e){Ue(n,e);var t=Be(n);function n(e){var r;return Le(this,n),(r=t.call(this,e)).actions=[],r.description=e.safeContent.description,r.url=e.safeContent.url,r.name=e.safeContent.name,r.package_info=e.safeContent.package_info,r.supported_types=e.safeContent.supported_types,r.hidden=e.safeContent.hidden,e.safeContent.actions&&(r.actions=e.safeContent.actions.map((function(e){return new Ke(e)}))),r}return Ne(n,[{key:"actionsWithContextForItem",value:function(e){return this.actions.filter((function(t){return t.context===e.content_type||"Item"===t.context}))}}]),n}(d.d),Je=function(e){Ue(n,e);var t=Be(n);function n(){return Le(this,n),t.apply(this,arguments)}return Ne(n,[{key:"description",set:function(e){this.content.description=e}},{key:"supported_types",set:function(e){this.content.supported_types=e}},{key:"actions",set:function(e){this.content.actions=e}},{key:"hidden",set:function(e){this.content.hidden=e}}]),n}(d.b);function Ge(e){return(Ge="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function $e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Qe(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ye(e,t,n){return t&&Qe(e.prototype,t),n&&Qe(e,n),e}function Xe(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ze(e,t)}function Ze(e,t){return(Ze=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function et(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=nt(e);if(t){var a=nt(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return tt(this,n)}}function tt(e,t){return!t||"object"!==Ge(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function nt(e){return(nt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var rt=function(e){Xe(n,e);var t=et(n);function n(e){var r;return $e(this,n),(r=t.call(this,e)).title=r.payload.safeContent.title,r}return Ye(n,[{key:"isSmartTag",value:function(){return this.content_type===P.a.SmartTag}},{key:"noteCount",get:function(){return this.payload.safeReferences.length}},{key:"isAllTag",get:function(){return this.payload.safeContent.isAllTag}},{key:"isTrashTag",get:function(){return this.payload.safeContent.isTrashTag}},{key:"isArchiveTag",get:function(){return this.payload.safeContent.isArchiveTag}}],[{key:"arrayToDisplayString",value:function(e){return e.sort((function(e,t){return e.title>t.title?1:-1})).map((function(e){return"#"+e.title})).join(" ")}}]),n}(d.d),at=function(e){Xe(n,e);var t=et(n);function n(){return $e(this,n),t.apply(this,arguments)}return Ye(n,[{key:"title",set:function(e){this.content.title=e}}]),n}(d.b);function ot(e){return(ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function it(e,t){return(it=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function st(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ut(e);if(t){var a=ut(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ct(this,n)}}function ct(e,t){return!t||"object"!==ot(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ut(e){return(ut=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var lt=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&it(e,t)}(n,e);var t=st(n);function n(e){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),r=t.call(this,e),e.safeContent.predicate&&(r.predicate=C.a.FromJson(e.safeContent.predicate)),r}return n}(rt),ft=n(10);function pt(e){return(pt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function yt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ht(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function dt(e,t,n){return t&&ht(e.prototype,t),n&&ht(e,n),e}function vt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&mt(e,t)}function mt(e,t){return(mt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function bt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=wt(e);if(t){var a=wt(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return gt(this,n)}}function gt(e,t){return!t||"object"!==pt(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function wt(e){return(wt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var kt=function(e){vt(n,e);var t=bt(n);function n(e){var r;return yt(this,n),(r=t.call(this,e)).text="",r.hidePreview=!1,r.title=r.payload.safeContent.title,r.text=r.payload.safeContent.text,r.preview_plain=r.payload.safeContent.preview_plain,r.preview_html=r.payload.safeContent.preview_html,r.hidePreview=r.payload.safeContent.hidePreview,e.format===ft.a.DecryptedBareObject&&(r.prefersPlainEditor=r.getAppDomainValue(d.a.PrefersPlainEditor)),Object(u.p)(r.payload.safeContent.mobilePrefersPlainEditor)||(r.mobilePrefersPlainEditor=r.payload.safeContent.mobilePrefersPlainEditor),r}return dt(n,[{key:"safeText",value:function(){return this.text||""}},{key:"safeTitle",value:function(){return this.title||""}}]),n}(d.d),St=function(e){vt(n,e);var t=bt(n);function n(){return yt(this,n),t.apply(this,arguments)}return dt(n,[{key:"typedContent",get:function(){return this.content}},{key:"title",set:function(e){this.typedContent.title=e}},{key:"text",set:function(e){this.typedContent.text=e}},{key:"hidePreview",set:function(e){this.typedContent.hidePreview=e}},{key:"preview_plain",set:function(e){this.typedContent.preview_plain=e}},{key:"preview_html",set:function(e){this.typedContent.preview_html=e}},{key:"prefersPlainEditor",set:function(e){this.setAppDataItem(d.a.PrefersPlainEditor,e)}}]),n}(d.b),xt=n(7);function Ot(e){return(Ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Pt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function jt(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Dt(e,t,n){return t&&jt(e.prototype,t),n&&jt(e,n),e}function Ct(e,t,n){return(Ct="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=At(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function It(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_t(e,t)}function _t(e,t){return(_t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Rt(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=At(e);if(t){var a=At(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Et(this,n)}}function Et(e,t){return!t||"object"!==Ot(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function At(e){return(At=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Mt,Tt=function(e){It(n,e);var t=Rt(n);function n(){return Pt(this,n),t.apply(this,arguments)}return Dt(n,[{key:"strategyWhenConflictingWithItem",value:function(e){return this.errorDecrypting?Ct(At(n.prototype),"strategyWhenConflictingWithItem",this).call(this,e):ne.a.KeepLeft}},{key:"version",get:function(){return this.payload.safeContent.version}},{key:"isItemsKey",get:function(){return!0}},{key:"isDefault",get:function(){return this.payload.safeContent.isDefault}},{key:"itemsKey",get:function(){return this.payload.safeContent.itemsKey}},{key:"dataAuthenticationKey",get:function(){if(this.version===xt.a.V004)throw"Attempting to access legacy data authentication key.";return this.payload.safeContent.dataAuthenticationKey}}]),n}(d.d),Kt=function(e){It(n,e);var t=Rt(n);function n(){return Pt(this,n),t.apply(this,arguments)}return Dt(n,[{key:"isDefault",set:function(e){this.content.isDefault=e}}]),n}(d.b);function Ft(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Lt,Vt,Nt=(Ft(Mt={},P.a.Note,kt),Ft(Mt,P.a.Tag,rt),Ft(Mt,P.a.ItemsKey,Tt),Ft(Mt,P.a.SmartTag,lt),Ft(Mt,P.a.ActionsExtension,qe),Ft(Mt,P.a.Editor,Ae),Ft(Mt,P.a.Theme,Pe),Ft(Mt,P.a.Component,ye),Ft(Mt,P.a.Privileges,ee),Ft(Mt,P.a.UserPrefs,N),Mt);function Ut(e){return new(Nt[e.content_type]||d.d)(e)}function Wt(e,t){return e?"".concat(e,"-").concat(t):t}!function(e){e.StorageObject="storage",e.LastMigrationTimestamp="last_migration_timestamp"}(Lt||(Lt={})),function(e){e.RootKeyParams="ROOT_KEY_PARAMS",e.WrappedRootKey="WRAPPED_ROOT_KEY",e.RootKeyWrapperKeyParams="ROOT_KEY_WRAPPER_KEY_PARAMS",e.Session="session",e.User="user",e.ServerHost="server",e.LegacyUuid="uuid",e.LastSyncToken="syncToken",e.PaginationToken="cursorToken",e.BiometricsState="biometrics_state",e.MobilePasscodeTiming="passcode_timing",e.MobileBiometricsTiming="biometrics_timing",e.PrivilegesExpirey="SessionExpiresAtKey",e.PrivilegesSessionLength="SessionLengthKey",e.SessionHistoryPersistable="sessionHistory_persist",e.SessionHistoryRevisions="sessionHistory_revisions",e.SessionHistoryOptimize="sessionHistory_autoOptimize"}(Vt||(Vt={}));var Bt,Ht,zt,qt,Jt=n(9),Gt=n(12);function $t(e){return($t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Qt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Yt(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Xt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Xt(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Xt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Zt(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function en(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Zt(o,r,a,i,s,"next",e)}function s(e){Zt(o,r,a,i,s,"throw",e)}i(void 0)}))}}function tn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function nn(e,t,n){return(nn="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=sn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function rn(e,t){return(rn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function an(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=sn(e);if(t){var a=sn(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return on(this,n)}}function on(e,t){return!t||"object"!==$t(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function sn(e){return(sn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e[e.Default=1]="Default",e[e.Ephemeral=2]="Ephemeral"}(Bt||(Bt={})),function(e){e[e.Default=1]="Default",e[e.Disabled=2]="Disabled"}(Ht||(Ht={})),function(e){e[e.Default=1]="Default",e[e.Nonwrapped=2]="Nonwrapped"}(zt||(zt={})),function(e){e.Wrapped="wrapped",e.Unwrapped="unwrapped",e.Nonwrapped="nonwrapped"}(qt||(qt={}));var cn,un=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&rn(e,t)}(E,e);var t,n,r,o,s,c,l,f,p,y,d,v,m,b,g,w,k,S,x,O,D,C,I,_,R=an(E);function E(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,E),(n=R.call(this)).storagePersistable=!1,n.deviceInterface=e,n.namespace=t,n.setPersistencePolicy(Bt.Default),n.setEncryptionPolicy(Ht.Default),n}return t=E,n=[{key:"deinit",value:function(){this.deviceInterface=void 0,this.encryptionDelegate=void 0,nn(sn(E.prototype),"deinit",this).call(this)}},{key:"handleApplicationStage",value:(_=en(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,nn(sn(E.prototype),"handleApplicationStage",this).call(this,t);case 2:t===a.Launched_10&&(this.storagePersistable=!0);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"setPersistencePolicy",value:(I=en(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy=t,this.persistencePolicy!==Bt.Ephemeral){e.next=6;break}return e.next=4,this.deviceInterface.removeAllRawStorageValues();case 4:return e.next=6,this.clearAllPayloads();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return I.apply(this,arguments)})},{key:"setEncryptionPolicy",value:(C=en(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.encryptionPolicy=t;case 1:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.persistencePolicy===Bt.Ephemeral}},{key:"initializeFromDisk",value:(D=en(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getRawStorageValue(this.getPersistenceKey());case 2:t=e.sent,n=t?JSON.parse(t):void 0,this.setInitialValues(n);case 5:case"end":return e.stop()}}),e,this)}))),function(){return D.apply(this,arguments)})},{key:"setInitialValues",value:function(e){e||(e=this.defaultValuesObject()),e[qt.Unwrapped]||(e[qt.Unwrapped]={}),this.values=e}},{key:"isStorageWrapped",value:function(){var e=this.values[qt.Wrapped];return!Object(u.p)(e)&&Object.keys(e).length>0}},{key:"canDecryptWithKey",value:(O=en(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.values[qt.Wrapped],e.next=3,this.decryptWrappedValue(n,t);case 3:return r=e.sent,e.abrupt("return",!r.errorDecrypting);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"decryptWrappedValue",value:(x=en(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null==t?void 0:t.content_type){e.next=2;break}throw Error("Attempting to decrypt nonexistent wrapped value");case 2:return r=Object(j.e)(t,{content_type:P.a.EncryptedStorage}),e.next=5,this.encryptionDelegate.payloadByDecryptingPayload(r,n);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return x.apply(this,arguments)})},{key:"decryptStorage",value:(S=en(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.values[qt.Wrapped],e.next=3,this.decryptWrappedValue(t);case 3:if(!(n=e.sent).errorDecrypting){e.next=6;break}throw Error("Unable to decrypt storage.");case 6:this.values[qt.Unwrapped]=Object(u.a)(n.contentObject);case 7:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"persistValuesToDisk",value:(k=en(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.storagePersistable){e.next=2;break}return e.abrupt("return");case 2:if(this.persistencePolicy!==Bt.Ephemeral){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,this.immediatelyPersistValuesToDisk();case 6:t=e.sent,this.values[qt.Wrapped]=t[qt.Wrapped];case 8:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"immediatelyPersistValuesToDisk",value:(w=en(i.a.mark((function e(){var t=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeCriticalFunction(en(i.a.mark((function e(){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.generatePersistableValues();case 2:return n=e.sent,e.next=5,t.deviceInterface.setRawStorageValue(t.getPersistenceKey(),JSON.stringify(n));case 5:return e.abrupt("return",n);case 6:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"generatePersistableValues",value:(g=en(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object.assign({},this.values),n=t[qt.Unwrapped],e.t0=j.e,e.next=5,h.GenerateUuid();case 5:return e.t1=e.sent,e.t2=n,e.t3=P.a.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},r=(0,e.t0)(e.t4),e.next=12,this.encryptionDelegate.payloadByEncryptingPayload(r,Jt.a.LocalStoragePreferEncrypted);case 12:return a=e.sent,t[qt.Wrapped]=a.ejected(),t[qt.Unwrapped]=void 0,e.abrupt("return",t);case 16:case"end":return e.stop()}}),e,this)}))),function(){return g.apply(this,arguments)})},{key:"setValue",value:(b=en(i.a.mark((function e(t,n){var r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>2&&void 0!==a[2]?a[2]:zt.Default,this.values){e.next=3;break}throw Error("Attempting to set storage key ".concat(t," before loading local storage."));case 3:return this.values[this.domainKeyForMode(r)][t]=n,e.abrupt("return",this.persistValuesToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)})},{key:"getValue",value:(m=en(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:zt.Default,this.values){e.next=3;break}throw Error("Attempting to get storage key ".concat(t," before loading local storage."));case 3:if(this.values[this.domainKeyForMode(n)]){e.next=5;break}throw Error("Storage domain mode not available ".concat(n," for key ").concat(t));case 5:return e.abrupt("return",this.values[this.domainKeyForMode(n)][t]);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"removeValue",value:(v=en(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:zt.Default,this.values){e.next=3;break}throw Error("Attempting to remove storage key ".concat(t," before loading local storage."));case 3:return delete this.values[this.domainKeyForMode(n)][t],e.abrupt("return",this.persistValuesToDisk());case 5:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"getStorageEncryptionPolicy",value:function(){return this.encryptionPolicy}},{key:"getPersistenceKey",value:function(){return Wt(this.namespace,Lt.StorageObject)}},{key:"defaultValuesObject",value:function(e,t,n){return E.defaultValuesObject(e,t,n)}},{key:"domainKeyForMode",value:function(e){if(e===zt.Default)return qt.Unwrapped;if(e===zt.Nonwrapped)return qt.Nonwrapped;throw Error("Invalid mode")}},{key:"clearValues",value:(d=en(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setInitialValues(),e.next=3,this.immediatelyPersistValuesToDisk();case 3:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"getAllRawPayloads",value:(y=en(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.deviceInterface.getAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"savePayload",value:(p=en(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.savePayloads([t]));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"savePayloads",value:(f=en(i.a.mark((function e(t){var n,r,a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistencePolicy!==Bt.Ephemeral){e.next=2;break}return e.abrupt("return");case 2:n=[],r=Yt(t),e.prev=4,r.s();case 6:if((a=r.n()).done){e.next=21;break}if(!(o=a.value).discardable){e.next=13;break}return e.next=11,this.deletePayloadWithId(o.uuid);case 11:e.next=19;break;case 13:if(o.uuid){e.next=15;break}throw Error("Attempting to persist payload with no uuid");case 15:return e.next=17,this.encryptionDelegate.payloadByEncryptingPayload(o,this.encryptionPolicy===Ht.Default?Jt.a.LocalStoragePreferEncrypted:Jt.a.LocalStorageDecrypted);case 17:s=e.sent,n.push(s.ejected());case 19:e.next=6;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(4),r.e(e.t0);case 26:return e.prev=26,r.f(),e.finish(26);case 29:return e.abrupt("return",this.executeCriticalFunction(en(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",c.deviceInterface.saveRawDatabasePayloads(n));case 1:case"end":return e.stop()}}),e)})))));case 30:case"end":return e.stop()}}),e,this,[[4,23,26,29]])}))),function(e){return f.apply(this,arguments)})},{key:"deletePayloads",value:(l=en(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Yt(t),e.prev=1,n.s();case 3:if((r=n.n()).done){e.next=9;break}return a=r.value,e.next=7,this.deletePayloadWithId(a.uuid);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.e(e.t0);case 14:return e.prev=14,n.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e){return l.apply(this,arguments)})},{key:"deletePayloadWithId",value:(c=en(i.a.mark((function e(t){var n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeCriticalFunction(en(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.deviceInterface.removeRawDatabasePayloadWithId(t));case 1:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"clearAllPayloads",value:(s=en(i.a.mark((function e(){var t=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.executeCriticalFunction(en(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.deviceInterface.removeAllRawDatabasePayloads());case 1:case"end":return e.stop()}}),e)})))));case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"clearAllData",value:(o=en(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",Promise.all([this.clearValues(),this.clearAllPayloads()]));case 1:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}],r=[{key:"defaultValuesObject",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Qt(e={},qt.Wrapped,t),Qt(e,qt.Unwrapped,n),Qt(e,qt.Nonwrapped,r),e}}],n&&tn(t.prototype,n),r&&tn(t,r),E}(Gt.a);function ln(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}!function(e){e[e.Info=0]="Info",e[e.Danger=1]="Danger"}(cn||(cn={}));var fn=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.accessToken=t,this.expireAt=n,this.refreshToken=r,this.validUntil=a}var t,n,r;return t=e,r=[{key:"FromRaw",value:function(t){return new e(t.accessToken,t.expireAt,t.refreshToken,t.validUntil)}},{key:"FromResponse",value:function(t){var n,r,a;return new e(t.token,null===(n=t.session)||void 0===n?void 0:n.expire_at,null===(r=t.session)||void 0===r?void 0:r.refresh_token,null===(a=t.session)||void 0===a?void 0:a.valid_until)}}],(n=[{key:"getExpireAt",value:function(){return this.expireAt||0}},{key:"canExpire",value:function(){return this.getExpireAt()>0}},{key:"isExpired",value:function(){return!!this.canExpire()&&this.getExpireAt()<Date.now()}}])&&ln(t.prototype,n),r&&ln(t,r),e}(),pn="Your account session is being renewed with the server. Please try your request again.",yn="This version of the application does not support your\n                                                      newer account type. Please upgrade to the latest version\n                                                      of Standard Notes to sign in.",hn="The protocol version associated with your account is\n                                                      outdated and no longer supported by this application.\n                                                      Please visit standardnotes.org/help/security for more\n                                                      information.",dn="The encryption version for your account is outdated and\n                                                      requires upgrade. You may proceed with login, but are\n                                                      advised to perform a security update using the web or\n                                                      desktop application. Please visit\n                                                      standardnotes.org/help/security for more information.",vn="Your account was created on a platform with higher security\n                                                      capabilities than this browser supports. If we attempted\n                                                      to generate your login keys here, it would take hours. Please\n                                                      use a browser with more up to date security capabilities,\n                                                      like Google Chrome or Firefox, to log in.",mn="Unable to login due to insecure password parameters.\n                                                      Please visit standardnotes.org/help/security for\n                                                      more information.";function bn(e){return"\n          Your password must be at least ".concat(e," characters in length.\n          For your security, please choose a longer password or,\n          ideally, a passphrase, and try again.\n         ")}function gn(e,t){return"\n          Strict Sign In has refused the server's sign-in parameters.\n          The latest account version is ".concat(t,", but the server is reporting a \n          version of ").concat(e," for your account. If you'd like to proceed\n          with sign in anyway, please disable Strict Sign In and try again.\n          ")}function wn(e){return(wn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function kn(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Sn(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){kn(o,r,a,i,s,"next",e)}function s(e){kn(o,r,a,i,s,"throw",e)}i(void 0)}))}}function xn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function On(e,t,n){return(On="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Cn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Pn(e,t){return(Pn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function jn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Cn(e);if(t){var a=Cn(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Dn(this,n)}}function Dn(e,t){return!t||"object"!==wn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Cn(e){return(Cn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var In,_n=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Pn(e,t)}(h,e);var t,n,r,a,o,s,c,l,f,p,y=jn(h);function h(e,t,n,r){var a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),(a=y.call(this)).protocolService=r,a.storageService=e,a.apiService=t,a.alertService=n,a}return t=h,(n=[{key:"deinit",value:function(){this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.alertService=void 0,this.user=void 0,On(Cn(h.prototype),"deinit",this).call(this)}},{key:"initializeFromDisk",value:(p=Sn(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Vt.User);case 2:if(this.user=e.sent,this.user){e.next=8;break}return e.next=6,this.storageService.getValue(Vt.LegacyUuid);case 6:(t=e.sent)&&(this.user={uuid:t});case 8:return e.next=10,this.storageService.getValue(Vt.Session);case 10:if(!(n=e.sent)){e.next=14;break}return e.next=14,this.setSession(fn.FromRaw(n),!1);case 14:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"setSession",value:(f=Sn(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=!(r.length>1&&void 0!==r[1])||r[1],e.next=3,this.apiService.setSession(t,n);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"online",value:function(){return!this.offline()}},{key:"offline",value:function(){return Object(u.p)(this.apiService.getSession())}},{key:"getUser",value:function(){return this.user}},{key:"signOut",value:(l=Sn(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.user=void 0,e.next=3,this.apiService.getSession();case 3:(t=e.sent)&&t.canExpire()&&this.apiService.signOut();case 5:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"register",value:(c=Sn(i.a.mark((function e(t,n){var r,a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n.length<8)){e.next=2;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(bn(8))});case 2:return e.next=4,this.protocolService.createRootKey(t,n);case 4:return r=e.sent,a=r.key.serverPassword,o=r.keyParams,s=r.key,e.abrupt("return",this.apiService.register(t,a,o).then(function(){var e=Sn(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:o,rootKey:s});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"signIn",value:(s=Sn(i.a.mark((function e(t,n){var r,a,o,s,c,u,l,f,p,y,h,d,v=this,m=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=m.length>2&&void 0!==m[2]&&m[2],a=m.length>3?m[3]:void 0,o=m.length>4?m[4]:void 0,e.next=5,this.apiService.getAccountKeyParams(t,a,o);case 5:if(!(s=e.sent).error){e.next=8;break}return e.abrupt("return",{response:s});case 8:if(c={pw_cost:s.pw_cost,pw_nonce:s.pw_nonce,identifier:s.identifier,email:s.email,pw_salt:s.pw_salt,version:s.version},(u=this.protocolService.createKeyParams(c))&&u.version){e.next=12;break}return e.abrupt("return",{response:this.apiService.createErrorResponse("Invalid email or password.")});case 12:if(this.protocolService.supportedVersions().includes(u.version)){e.next=18;break}if(!this.protocolService.isVersionNewerThanLibraryVersion(u.version)){e.next=17;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(yn)});case 17:return e.abrupt("return",{response:this.apiService.createErrorResponse(hn)});case 18:if(!this.protocolService.isProtocolVersionOutdated(u.version)){e.next=29;break}if(l=this.protocolService.costMinimumForVersion(u.version),!(u.kdfIterations<l)){e.next=22;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(mn)});case 22:return f=dn,e.next=26,this.alertService.confirm(f,"Update Recommended","Sign In");case 26:if(e.sent){e.next=29;break}return e.abrupt("return",{response:this.apiService.createErrorResponse("Invalid email or password.")});case 29:if(this.protocolService.platformSupportsKeyDerivation(u)){e.next=31;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(vn)});case 31:if(!r){e.next=35;break}if(p=this.protocolService.getLatestVersion(),u.version===p){e.next=35;break}return e.abrupt("return",{response:this.apiService.createErrorResponse(gn(u.version,p))});case 35:return e.next=37,this.protocolService.computeRootKey(n,u).then((function(e){return{rootKey:e,serverPassword:e.serverPassword}}));case 37:return y=e.sent,h=y.rootKey,d=y.serverPassword,e.abrupt("return",this.apiService.signIn(t,d,a,o).then(function(){var e=Sn(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.handleAuthResponse(t);case 2:return e.abrupt("return",{response:t,keyParams:u,rootKey:h});case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 41:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"changePassword",value:(o=Sn(i.a.mark((function e(t,n,r){var a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.apiService.changePassword(t,n,r);case 2:return a=e.sent,e.next=5,this.handleAuthResponse(a);case 5:return e.abrupt("return",a);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"handleAuthResponse",value:(a=Sn(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.error){e.next=2;break}return e.abrupt("return");case 2:return n=t.user,this.user=n,e.next=6,this.storageService.setValue(Vt.User,n);case 6:if(!t.token){e.next=10;break}return r=fn.FromResponse(t),e.next=10,this.setSession(r);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})}])&&xn(t.prototype,n),r&&xn(t,r),h}(Gt.a);function Rn(e){return(Rn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function En(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function An(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){En(o,r,a,i,s,"next",e)}function s(e){En(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Mn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Tn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Kn(e,t){return(Kn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Fn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Vn(e);if(t){var a=Vn(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ln(this,n)}}function Ln(e,t){return!t||"object"!==Rn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Vn(e){return(Vn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.Get="get",e.Post="post",e.Patch="patch"}(In||(In={}));var Nn,Un=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Kn(e,t)}(f,e);var t,n,r,a,o,s,c,u,l=Fn(f);function f(){return Mn(this,f),l.apply(this,arguments)}return t=f,(n=[{key:"getAbsolute",value:(u=An(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:In.Get,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"postAbsolute",value:(c=An(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:In.Post,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"patchAbsolute",value:(s=An(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.runHttp({url:t,params:n,verb:In.Patch,authentication:r}));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"runHttp",value:(o=An(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.createXmlRequest(t),e.abrupt("return",this.runRequest(n,t.verb,t.params));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"createXmlRequest",value:function(e){var t=new XMLHttpRequest;return e.params&&e.verb===In.Get&&Object.keys(e.params).length>0&&(e.url=this.urlForUrlAndParams(e.url,e.params)),t.open(e.verb,e.url,!0),t.setRequestHeader("Content-type","application/json"),e.authentication&&t.setRequestHeader("Authorization","Bearer "+e.authentication),t}},{key:"runRequest",value:(a=An(i.a.mark((function e(t,n,r){var a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,o){t.onreadystatechange=function(){a.stateChangeHandlerForRequest(t,e,o)},n===In.Post||n===In.Patch?t.send(JSON.stringify(r)):t.send()})));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"stateChangeHandlerForRequest",value:function(e,t,n){if(4===e.readyState){var r=e.status,a={status:r};try{var o=JSON.parse(e.responseText);Object.assign(a,o)}catch(e){}r>=200&&r<=299?t(a):(a.error||(a.error={status:r}),n(a))}}},{key:"urlForUrlAndParams",value:function(e,t){var n=Object.keys(t).map((function(e){return e+"="+encodeURIComponent(t[e])})).join("&");return e.includes("?")?e+"&"+n:e+"?"+n}},{key:"isErrorResponseExpiredToken",value:function(e){return 498===e.status}}])&&Tn(t.prototype,n),r&&Tn(t,r),f}(Gt.a);function Wn(e){return(Wn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Bn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Hn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Bn(Object(n),!0).forEach((function(t){zn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Bn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function zn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function qn(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Jn(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){qn(o,r,a,i,s,"next",e)}function s(e){qn(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Gn(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function $n(e,t,n){return($n="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Zn(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Qn(e,t){return(Qn=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Yn(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Zn(e);if(t){var a=Zn(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Xn(this,n)}}function Xn(e,t){return!t||"object"!==Wn(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Zn(e){return(Zn=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.LastSyncToken="sync_token",e.PaginationToken="cursor_token",e.IntegrityCheck="compute_integrity",e.IntegrityResult="integrity_hash",e.SyncDlLimit="limit",e.SyncPayloads="items",e.ApiVersion="api"}(Nn||(Nn={}));var er,tr,nr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Qn(e,t)}(w,e);var t,n,r,a,o,s,c,l,f,p,y,h,d,v,m,b,g=Yn(w);function w(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,w),(n=g.call(this)).registering=!1,n.authenticating=!1,n.changing=!1,n.refreshingSession=!1,n.httpService=e,n.storageService=t,n}return t=w,(n=[{key:"deinit",value:function(){this.httpService=void 0,this.storageService=void 0,this.host=void 0,this.session=void 0,$n(Zn(w.prototype),"deinit",this).call(this)}},{key:"loadHost",value:(b=Jn(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Vt.ServerHost);case 2:t=e.sent,this.host=t||window._default_sync_server;case 4:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"setHost",value:(m=Jn(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.host=t,e.next=3,this.storageService.setValue(Vt.ServerHost,t);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"getHost",value:(v=Jn(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.host);case 1:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"setSession",value:(d=Jn(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=!(r.length>1&&void 0!==r[1])||r[1],this.session=t,!n){e.next=5;break}return e.next=5,this.storageService.setValue(Vt.Session,t);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"getSession",value:function(){return this.session}},{key:"path",value:(h=Jn(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getHost();case 2:if(n=e.sent){e.next=5;break}throw"Attempting to build path ".concat(t," with no host.");case 5:if(t){e.next=7;break}throw"Attempting to build path with null path.";case 7:return e.abrupt("return",Object(u.u)(n,t));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"params",value:function(e){var t=Te()(e,zn({},Nn.ApiVersion,"20200115"));return t}},{key:"createErrorResponse",value:function(e){return{error:{message:e}}}},{key:"errorResponseWithFallbackMessage",value:function(e,t){return e.error.message||(e.error.message=t),e}},{key:"getAccountKeyParams",value:(y=Jn(i.a.mark((function e(t,n,r){var a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.path("/auth/params");case 2:return a=e.sent,o=this.params({email:t}),n&&(o[n]=r),e.next=7,this.httpService.getAbsolute(a,o).catch((function(e){return c.errorResponseWithFallbackMessage(e,"A server error occurred while trying to sign in. Please try again.")}));case 7:return s=e.sent,e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return y.apply(this,arguments)})},{key:"register",value:(p=Jn(i.a.mark((function e(t,n,r){var a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.registering){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing registration request is already in progress."));case 2:return this.registering=!0,e.next=5,this.path("/auth");case 5:return a=e.sent,o=this.params(Hn({password:n,email:t},r.getPortableValue())),e.next=9,this.httpService.postAbsolute(a,o).catch((function(e){return c.errorResponseWithFallbackMessage(e,"A server error occurred while trying to register. Please try again.")}));case 9:return s=e.sent,this.registering=!1,e.abrupt("return",s);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return p.apply(this,arguments)})},{key:"signIn",value:(f=Jn(i.a.mark((function e(t,n,r,a){var o,s,c,u=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.authenticating){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing sign in request is already in progress."));case 2:return this.authenticating=!0,e.next=5,this.path("/auth/sign_in");case 5:return o=e.sent,s=this.params({email:t,password:n}),r&&(s[r]=a),e.next=10,this.httpService.postAbsolute(o,s).catch((function(e){return u.errorResponseWithFallbackMessage(e,"A server error occurred while trying to sign in. Please try again.")}));case 10:return c=e.sent,this.authenticating=!1,e.abrupt("return",c);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return f.apply(this,arguments)})},{key:"signOut",value:(l=Jn(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.path("/auth/sign_out");case 2:return t=e.sent,e.abrupt("return",this.httpService.postAbsolute(t,void 0,this.session.accessToken));case 4:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"changePassword",value:(c=Jn(i.a.mark((function e(t,n,r){var a,o,s,c=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.changing){e.next=2;break}return e.abrupt("return",this.createErrorResponse("An existing change password request is already in progress."));case 2:if(!this.refreshingSession){e.next=4;break}return e.abrupt("return",this.createErrorResponse(pn));case 4:return this.changing=!0,e.next=7,this.path("/auth/change_pw");case 7:return a=e.sent,o=this.params(Hn({current_password:t,new_password:n},r.getPortableValue())),e.next=11,this.httpService.postAbsolute(a,o,this.session.accessToken).catch(function(){var e=Jn(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!c.httpService.isErrorResponseExpiredToken(t)){e.next=2;break}return e.abrupt("return",c.refreshSessionThenRetryRequest({verb:In.Post,url:a,params:o}));case 2:return e.abrupt("return",c.errorResponseWithFallbackMessage(t,"Something went wrong while changing your password.\n                                                      Your password was not changed. Please try again."));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:return s=e.sent,this.changing=!1,e.abrupt("return",s);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"sync",value:(s=Jn(i.a.mark((function e(t,n,r,a){var o,s,c,u,l,f,p,y=this,h=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=h.length>4&&void 0!==h[4]&&h[4],c=h.length>5?h[5]:void 0,u=h.length>6?h[6]:void 0,!this.refreshingSession){e.next=5;break}return e.abrupt("return",this.createErrorResponse(pn));case 5:return e.next=7,this.path("/items/sync");case 7:return l=e.sent,f=this.params((zn(o={},Nn.SyncPayloads,t.map((function(e){return e.ejected()}))),zn(o,Nn.LastSyncToken,n),zn(o,Nn.PaginationToken,r),zn(o,Nn.IntegrityCheck,s),zn(o,Nn.SyncDlLimit,a),zn(o,"content_type",c),zn(o,"event",u),o)),e.next=11,this.httpService.postAbsolute(l,f,this.session.accessToken).catch(function(){var e=Jn(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!y.httpService.isErrorResponseExpiredToken(t)){e.next=2;break}return e.abrupt("return",y.refreshSessionThenRetryRequest({verb:In.Post,url:l,params:f}));case 2:return e.abrupt("return",y.errorResponseWithFallbackMessage(t,"Could not connect to server."));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:return p=e.sent,e.abrupt("return",p);case 13:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return s.apply(this,arguments)})},{key:"refreshSessionThenRetryRequest",value:(o=Jn(i.a.mark((function e(t){var n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.refreshSession().then((function(e){return(null==e?void 0:e.error)?e:n.httpService.runHttp(Hn(Hn({},t),{},{authentication:n.session.accessToken}))})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"refreshSession",value:(a=Jn(i.a.mark((function e(){var t,n,r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.refreshingSession){e.next=2;break}return e.abrupt("return",this.createErrorResponse(pn));case 2:return this.refreshingSession=!0,e.next=5,this.path("/session/refresh");case 5:return t=e.sent,n=this.params({access_token:this.session.accessToken,refresh_token:this.session.refreshToken}),e.next=9,this.httpService.postAbsolute(t,n).then(function(){var e=Jn(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=fn.FromResponse(t),e.next=3,a.setSession(n);case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){return a.errorResponseWithFallbackMessage(e,"A server error occurred while trying to refresh your session.\n                                                      Please try again.")}));case 9:return r=e.sent,this.refreshingSession=!1,e.abrupt("return",r);case 12:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})}])&&Gn(t.prototype,n),r&&Gn(t,r),w}(Gt.a),rr=n(18),ar=n.n(rr),or=n(23),ir=n.n(or),sr=n(20),cr=n.n(sr);function ur(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function lr(e){return{"mac-web":tr.MacWeb,"mac-desktop":tr.MacDesktop,"linux-web":tr.LinuxWeb,"linux-desktop":tr.LinuxDesktop,"windows-web":tr.WindowsWeb,"windows-desktop":tr.WindowsDesktop,ios:tr.Ios,android:tr.Android}[e]}function fr(e){return e===er.Web||e===er.Desktop}function pr(e){return e===er.Mobile}function yr(e){return(yr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function hr(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function dr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function vr(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){dr(o,r,a,i,s,"next",e)}function s(e){dr(o,r,a,i,s,"throw",e)}i(void 0)}))}}function mr(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return br(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return br(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function br(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function gr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function wr(e,t,n){return(wr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Or(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function kr(e,t){return(kr=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Sr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Or(e);if(t){var a=Or(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return xr(this,n)}}function xr(e,t){return!t||"object"!==yr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Or(e){return(Or=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e[e.Web=1]="Web",e[e.Desktop=2]="Desktop",e[e.Mobile=3]="Mobile"}(er||(er={})),function(e){e[e.Ios=1]="Ios",e[e.Android=2]="Android",e[e.MacWeb=3]="MacWeb",e[e.MacDesktop=4]="MacDesktop",e[e.WindowsWeb=5]="WindowsWeb",e[e.WindowsDesktop=6]="WindowsDesktop",e[e.LinuxWeb=7]="LinuxWeb",e[e.LinuxDesktop=8]="LinuxDesktop"}(tr||(tr={}));var Pr="org.standardnotes.sn.components",jr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&kr(e,t)}(b,e);var t,n,r,a,o,c,l,f,p,y,v,m=Sr(b);function b(e,t,n,r,a,o){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,b),(i=m.call(this)).componentState={},i.streamObservers=[],i.contextStreamObservers=[],i.activeComponents={},i.permissionDialogs=[],i.handlers=[],i.detectFocusChange=function(){var e,t=mr(i.itemManager.findItems(Object.keys(i.activeComponents)));try{var n=function(){var t=e.value;if(document.activeElement===i.iframeForComponent(t.uuid))return i.timeout((function(){i.focusChangedForComponent(t)})),"break"};for(t.s();!(e=t.n()).done;){if("break"===n())break}}catch(e){t.e(e)}finally{t.f()}},i.onWindowMessage=function(e){e.data.sessionKey&&(i.log("Component manager received message",e.data),i.handleMessage(i.componentForSessionKey(e.data.sessionKey),e.data))},i.timeout=o||setTimeout.bind(window),i.itemManager=e,i.syncService=t,i.alertService=n,i.environment=r,i.platform=a,i.configureForGeneralUsage(),r!==er.Mobile&&i.configureForNonMobileUsage(),i}return t=b,(n=[{key:"componentsForArea",value:function(e){return this.components.filter((function(t){return t.area===e}))}},{key:"deinit",value:function(){wr(Or(b.prototype),"deinit",this).call(this),this.streamObservers.length=0,this.contextStreamObservers.length=0,this.activeComponents=void 0,this.permissionDialogs.length=0,this.handlers.length=0,this.itemManager=void 0,this.syncService=void 0,this.alertService=void 0,this.removeItemObserver(),this.removeItemObserver=null,window&&!this.isMobile&&(window.removeEventListener("focus",this.detectFocusChange,!0),window.removeEventListener("blur",this.detectFocusChange,!0),window.removeEventListener("message",this.onWindowMessage))}},{key:"setDesktopManager",value:function(e){this.desktopManager=e,this.configureForDesktop()}},{key:"configureForGeneralUsage",value:function(){var e=this;this.removeItemObserver=this.itemManager.addObserver(P.a.Any,(function(t,n,r,a,o){var i=Object(u.f)(t,n,r),s=i.filter((function(e){return e.content_type===P.a.Component||e.content_type===P.a.Theme}));s.length>0&&a!==D.a.RemoteSaved&&e.isDesktop&&e.desktopManager.syncComponentsInstallation(s);var c,l=mr(s);try{for(l.s();!(c=l.n()).done;){var f=c.value,p=e.activeComponents[f.uuid];!f.active||f.deleted||p?!f.active&&p&&e.deactivateComponent(f.uuid):e.activateComponent(f.uuid)}}catch(e){l.e(e)}finally{l.f()}a!==D.a.LocalChanged&&e.notifyStreamObservers(i,a,o)}))}},{key:"notifyStreamObservers",value:function(e,t,n){var r,a=this,o=mr(this.streamObservers);try{var i=function(){var t=r.value;if(n&&n===t.componentUuid)return"continue";var o=e.filter((function(e){return-1!==t.contentTypes.indexOf(e.content_type)}));if(0===o.length)return"continue";var i=[{name:Z.StreamItems,content_types:t.contentTypes.sort()}];a.runWithPermissions(t.componentUuid,i,(function(){a.sendItemsInReply(t.componentUuid,o,t.originalMessage)}))};for(o.s();!(r=o.n()).done;)i()}catch(e){o.e(e)}finally{o.f()}var s,c=[{name:Z.StreamContextItem}],u=mr(this.contextStreamObservers);try{var l=function(){var r=s.value;if(n&&n===r.componentUuid)return"continue";var o,i=mr(a.handlers);try{for(i.s();!(o=i.n()).done;){var u=o.value;if((u.areas.includes(r.area)||u.areas.includes(X.Any))&&u.contextRequestHandler){var l=u.contextRequestHandler(r.componentUuid);if(l&&"continue"===function(){var n=ar()(e,{uuid:l.uuid});if(n){if(n.deleted)return"continue";a.runWithPermissions(r.componentUuid,c,(function(){a.sendContextItemInReply(r.componentUuid,n,r.originalMessage,t)}))}}())continue}}}catch(e){i.e(e)}finally{i.f()}};for(u.s();!(s=u.n()).done;)l()}catch(e){u.e(e)}finally{u.f()}}},{key:"isNativeExtension",value:function(e){var t=[window._extensions_manager_location,window._batch_manager_location],n=e.hosted_url,r=e.local_url&&e.local_url.replace("sn://","");return t.includes(n)||t.includes(r)}},{key:"configureForNonMobileUsage",value:function(){window.addEventListener?window.addEventListener("focus",this.detectFocusChange,!0):window.attachEvent("onfocusout",this.detectFocusChange),window.addEventListener?window.addEventListener("blur",this.detectFocusChange,!0):window.attachEvent("onblur",this.detectFocusChange),window.addEventListener("message",this.onWindowMessage)}},{key:"configureForDesktop",value:function(){var e=this;this.desktopManager.registerUpdateObserver((function(t){t.active&&t.isTheme()&&e.postActiveThemesToAllComponents()}))}},{key:"postActiveThemesToAllComponents",value:function(){var e,t=mr(this.components);try{for(t.s();!(e=t.n()).done;){var n=e.value,r=this.findOrCreateDataForComponent(n.uuid);!n.isTheme()&&n.active&&r.window&&this.postActiveThemesToComponent(n)}}catch(e){t.e(e)}finally{t.f()}}},{key:"getActiveThemes",value:function(){return this.componentsForArea(X.Themes).filter((function(e){return e.active}))}},{key:"urlsForActiveThemes",value:function(){var e,t=[],n=mr(this.getActiveThemes());try{for(n.s();!(e=n.n()).done;){var r=e.value,a=this.urlForComponent(r);a&&t.push(a)}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"postActiveThemesToComponent",value:function(e){var t={themes:this.urlsForActiveThemes()},n={action:Z.ActivateThemes,data:t};this.sendMessageToComponent(e,n)}},{key:"contextItemDidChangeInArea",value:function(e){var t,n=mr(this.handlers);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.areas.includes(e)||r.areas.includes(X.Any)){var a,o=mr(this.contextStreamObservers.filter((function(t){return t.area===e})));try{for(o.s();!(a=o.n()).done;){var i=a.value;if(r.contextRequestHandler){var s=r.contextRequestHandler(i.componentUuid);s&&this.sendContextItemInReply(i.componentUuid,s,i.originalMessage)}}}catch(e){o.e(e)}finally{o.f()}}}}catch(e){n.e(e)}finally{n.f()}}},{key:"isComponentHidden",value:function(e){return this.findOrCreateDataForComponent(e.uuid).hidden}},{key:"setComponentHidden",value:function(e,t){var n=this.findOrCreateDataForComponent(e.uuid);if(t)n.hidden=!0;else if(n.hidden){n.hidden=!1;var r=ar()(this.contextStreamObservers,{identifier:e.uuid});r&&this.handleStreamContextItemMessage(e,r.originalMessage);var a=ar()(this.streamObservers,{identifier:e.uuid});a&&this.handleStreamItemsMessage(e,a.originalMessage)}}},{key:"jsonForItem",value:function(e,t,n){var r=n===D.a.RemoteSaved||n===D.a.LocalSaved,a=(e.getDomainData(Pr)||{})[t.getClientDataKey()]||{},o={uuid:e.uuid,content_type:e.content_type,created_at:e.created_at,updated_at:e.updated_at,deleted:e.deleted,isMetadataUpdate:r,content:e.content,clientData:a};return this.removePrivatePropertiesFromResponseItems([o],t),o}},{key:"sendItemsInReply",value:function(e,t,n,r){var a=this,o=this.itemManager.findItem(e);this.log("Component manager send items in reply",o,t,n);var i={},s=t.map((function(e){return a.jsonForItem(e,o,r)}));i.items=s,this.replyToMessage(o,n,i)}},{key:"sendContextItemInReply",value:function(e,t,n,r){var a=this.itemManager.findItem(e);this.log("Component manager send context item in reply",a,t,n);var o={item:this.jsonForItem(t,a,r)};this.replyToMessage(a,n,o)}},{key:"replyToMessage",value:function(e,t,n){var r={action:Z.Reply,original:t,data:n};this.sendMessageToComponent(e,r)}},{key:"sendMessageToComponent",value:function(e,t){var n=[Z.ComponentRegistered,Z.ActivateThemes],r=this.findOrCreateDataForComponent(e.uuid);if(!r.hidden||n.includes(t.action)){this.log("Component manager send message to component",e,t);var a=this.urlForComponent(e);a&&r.window||this.alertService.alert("Standard Notes is trying to communicate with ".concat(e.name,",\n        but an error is occurring. Please restart this extension and try again.")),a.startsWith("http")||a.startsWith("file")||(a=window.location.href+a),r.window.postMessage(this.isMobile?JSON.stringify(t):t,a)}else this.log("Component disabled for current item, ignoring messages.",e.name)}},{key:"urlForComponent",value:function(e){if(e.offlineOnly&&!this.isDesktop)return null;if(e.offlineOnly||this.isDesktop&&e.local_url)return e.local_url&&e.local_url.replace("sn://",this.desktopManager.getExtServerHost());var t=e.hosted_url||e.legacy_url;if(this.isMobile){var n=this.platform===tr.Ios?"localhost":"10.0.2.2";t=t.replace("localhost",n).replace("sn.local",n)}return t}},{key:"componentForUrl",value:function(e){return this.components.filter((function(t){return t.hosted_url===e||t.legacy_url===e}))[0]}},{key:"sessionKeyForComponent",value:function(e){return this.findOrCreateDataForComponent(e.uuid).sessionKey}},{key:"componentForSessionKey",value:function(e){for(var t,n=this,r=function(){var r=o[a],i=n.componentState[r];if((null==i?void 0:i.sessionKey)===e)return t=n.components.find((function(e){return e.uuid===r})),"break"},a=0,o=Object.keys(this.componentState);a<o.length&&"break"!==r();a++);if(!t){var i,s=mr(this.handlers);try{for(s.s();!(i=s.n()).done;){var c=i.value;if(c.componentForSessionKeyHandler&&(t=c.componentForSessionKeyHandler(e)))break}}catch(e){s.e(e)}finally{s.f()}}return t}},{key:"handleMessage",value:function(e,t){var n=this;if(!e)return this.log("Component not defined for message, returning",t),void this.alertService.alert("An extension is trying to communicate with Standard Notes,but there is an error establishing a bridge. Please restart the app and try again.");var r=[Z.SaveItems,Z.AssociateItem,Z.DeassociateItem,Z.CreateItem,Z.CreateItems,Z.DeleteItems,Z.SetComponentData];if(this.getReadonlyStateForComponent(e).readonly&&r.includes(t.action))this.alertService.alert("The extension ".concat(e.name," is trying to save, but it is in a locked state and cannot accept changes."));else{if(t.action===Z.StreamItems)this.handleStreamItemsMessage(e,t);else if(t.action===Z.StreamContextItem)this.handleStreamContextItemMessage(e,t);else if(t.action===Z.SetComponentData)this.handleSetComponentDataMessage(e,t);else if(t.action===Z.DeleteItems)this.handleDeleteItemsMessage(e,t);else if(t.action===Z.CreateItems||t.action===Z.CreateItem)this.handleCreateItemsMessage(e,t);else if(t.action===Z.SaveItems)this.handleSaveItemsMessage(e,t);else if(t.action===Z.ToggleActivateComponent){var a=this.itemManager.findItem(t.data.uuid);this.handleToggleComponentMessage(a,t)}else t.action===Z.RequestPermissions?this.handleRequestPermissionsMessage(e,t):t.action===Z.InstallLocalComponent?this.handleInstallLocalComponentMessage(e,t):t.action===Z.DuplicateItem&&this.handleDuplicateItemMessage(e,t);var o,i=mr(this.handlers);try{var s=function(){var r=o.value;r.actionHandler&&(r.areas.includes(e.area)||r.areas.includes(X.Any))&&n.timeout((function(){r.actionHandler(e,t.action,t.data)}))};for(i.s();!(o=i.n()).done;)s()}catch(e){i.e(e)}finally{i.f()}}}},{key:"removePrivatePropertiesFromResponseItems",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t||!this.isNativeExtension(t)){var r=["autoupdateDisabled","permissions","active"];n&&(r=r.concat(["url","hosted_url","local_url"]));var a,o=mr(e);try{for(o.s();!(a=o.n()).done;){var i,s=a.value,c=mr(r);try{for(c.s();!(i=c.n()).done;){var u=i.value;delete s.content[u]}}catch(e){c.e(e)}finally{c.f()}}}catch(e){o.e(e)}finally{o.f()}}}},{key:"handleStreamItemsMessage",value:function(e,t){var n=this,r=[{name:Z.StreamItems,content_types:t.data.content_types.sort()}];this.runWithPermissions(e.uuid,r,(function(){ar()(n.streamObservers,{identifier:e.uuid})||n.streamObservers.push({identifier:e.uuid,componentUuid:e.uuid,area:e.area,originalMessage:t,contentTypes:t.data.content_types});var r,a=[],o=mr(t.data.content_types);try{for(o.s();!(r=o.n()).done;){var i=r.value;Object(u.j)(a,n.itemManager.nonErroredItemsForContentType(i))}}catch(e){o.e(e)}finally{o.f()}n.sendItemsInReply(e.uuid,a,t)}))}},{key:"handleStreamContextItemMessage",value:function(e,t){var n=this,r=[{name:Z.StreamContextItem}];this.runWithPermissions(e.uuid,r,(function(){ar()(n.contextStreamObservers,{identifier:e.uuid})||n.contextStreamObservers.push({identifier:e.uuid,componentUuid:e.uuid,area:e.area,originalMessage:t});var r,a=mr(n.handlersForArea(e.area));try{for(a.s();!(r=a.n()).done;){var o=r.value;if(o.contextRequestHandler){var i=o.contextRequestHandler(e.uuid);i&&n.sendContextItemInReply(e.uuid,i,t)}}}catch(e){a.e(e)}finally{a.f()}}))}},{key:"isItemIdWithinComponentContextJurisdiction",value:function(e,t){return this.itemIdsInContextJurisdictionForComponent(t).includes(e)}},{key:"itemIdsInContextJurisdictionForComponent",value:function(e){var t,n=[],r=mr(this.handlersForArea(e.area));try{for(r.s();!(t=r.n()).done;){var a=t.value;if(a.contextRequestHandler){var o=a.contextRequestHandler(e.uuid);o&&n.push(o.uuid)}}}catch(e){r.e(e)}finally{r.f()}return n}},{key:"handlersForArea",value:function(e){return this.handlers.filter((function(t){return t.areas.includes(e)}))}},{key:"handleSaveItemsMessage",value:(v=vr(i.a.mark((function e(t,n){var r,a,o,c,l,f,p,y,h=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=n.data.items,a=[],o=this.itemIdsInContextJurisdictionForComponent(t),c=r.slice(),l=mr(r.slice()),e.prev=5,l.s();case 7:if((f=l.n()).done){e.next=15;break}if(p=f.value,!o.includes(p.uuid)){e.next=13;break}return a.push({name:Z.StreamContextItem}),Object(u.B)(c,p),e.abrupt("break",15);case 13:e.next=7;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(5),l.e(e.t0);case 20:return e.prev=20,l.f(),e.finish(20);case 23:c.length>0&&(y=ir()(c.map((function(e){return e.content_type}))).sort(),a.push({name:Z.StreamItems,content_types:y})),this.runWithPermissions(t.uuid,a,vr(i.a.mark((function e(){var a,o,c,l,f,p;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(h.removePrivatePropertiesFromResponseItems(r,t,!0),a=Object(s.b)(r),o=h.itemManager.findItems(a,!0),c=0,o.forEach((function(e,n){if(e)e.locked&&(cr()(r,{uuid:e.uuid}),c++);else{var a=r[n];h.alertService.alert("The extension ".concat(t.name," is trying to save an item with type ")+"".concat(a.content_type,", but that item does not exist .")+"Please restart this extension and try again.")}})),!(c>0)){e.next=10;break}return l=1===c?"item":"items",f=1===c?"is":"are",h.alertService.alert("".concat(c," ").concat(l," you are attempting to save ").concat(f," locked and cannot be edited."),"Items Locked"),e.abrupt("return");case 10:return p=r.map((function(e){return Object(j.f)(e,D.a.ComponentRetrieved)})),e.next=13,h.itemManager.changeItems(a,(function(e){var n=Object(u.D)(p,{uuid:e.getUuid()});e.mergePayload(n);var a=Object(u.D)(r,{uuid:e.getUuid()});if(a.clientData){var o=Object(u.a)(e.getItem().getDomainData(Pr)||{});o[t.getClientDataKey()]=a.clientData,e.setDomainData(o,Pr)}}),d.c.UserInteraction,D.a.ComponentRetrieved,t.uuid);case 13:h.syncService.sync().then((function(){var e=Object.assign({},n);e.action=Z.SaveSuccess,h.replyToMessage(t,n,{}),h.handleMessage(t,e)})).catch((function(){var e=Object.assign({},n);e.action=Z.SaveError,h.replyToMessage(t,n,{error:Z.SaveError}),h.handleMessage(t,e)}));case 14:case"end":return e.stop()}}),e)}))));case 25:case"end":return e.stop()}}),e,this,[[5,17,20,23]])}))),function(e,t){return v.apply(this,arguments)})},{key:"handleDuplicateItemMessage",value:function(e,t){var n=this,r=t.data.item,a=this.itemManager.findItem(r.uuid),o=[{name:Z.StreamItems,content_types:[a.content_type]}];this.runWithPermissions(e.uuid,o,vr(i.a.mark((function r(){var o;return i.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.duplicateItem(a.uuid);case 2:o=r.sent,n.syncService.sync(),n.replyToMessage(e,t,{item:n.jsonForItem(o,e)});case 5:case"end":return r.stop()}}),r)}))))}},{key:"handleCreateItemsMessage",value:function(e,t){var n=this,r=t.data.item?[t.data.item]:t.data.items,a=ir()(r.map((function(e){return e.content_type}))),o=[{name:Z.StreamItems,content_types:a}];this.runWithPermissions(e.uuid,o,vr(i.a.mark((function a(){var o,s,c,l,f;return i.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:n.removePrivatePropertiesFromResponseItems(r,e),o=[],s=mr(r),a.prev=3,l=i.a.mark((function t(){var r,a,s,l;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((r=c.value).uuid){t.next=5;break}return t.next=4,h.GenerateUuid();case 4:r.uuid=t.sent;case 5:return a=Object(j.f)(r,D.a.ComponentCreated),s=Ut(a),t.next=9,n.itemManager.insertItem(s);case 9:return l=t.sent,t.next=12,n.itemManager.changeItem(l.uuid,(function(t){if(r.clientData){var n=Object(u.a)(l.getDomainData(Pr)||{});n[e.getClientDataKey()]=r.clientData,t.setDomainData(n,Pr)}}),d.c.UserInteraction,D.a.ComponentCreated,e.uuid);case 12:o.push(l);case 13:case"end":return t.stop()}}),t)})),s.s();case 6:if((c=s.n()).done){a.next=10;break}return a.delegateYield(l(),"t0",8);case 8:a.next=6;break;case 10:a.next=15;break;case 12:a.prev=12,a.t1=a.catch(3),s.e(a.t1);case 15:return a.prev=15,s.f(),a.finish(15);case 18:n.syncService.sync(),f=t.action===Z.CreateItem?{item:n.jsonForItem(o[0],e)}:{items:o.map((function(t){return n.jsonForItem(t,e)}))},n.replyToMessage(e,t,f);case 21:case"end":return a.stop()}}),a,null,[[3,12,15,18]])}))))}},{key:"handleDeleteItemsMessage",value:function(e,t){var n=this,r=ir()(t.data.items.map((function(e){return e.content_type}))).sort(),a=[{name:Z.StreamItems,content_types:r}];this.runWithPermissions(e.uuid,a,vr(i.a.mark((function r(){var a,o,s,c,u,l,f;return i.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=t.data.items,o=1===a.length?"item":"items",s=null,r.next=5,n.alertService.confirm("Are you sure you want to delete ".concat(a.length," ").concat(o,"?"));case 5:if(!r.sent){r.next=35;break}c=mr(a),r.prev=8,c.s();case 10:if((u=c.n()).done){r.next=23;break}if(l=u.value,f=n.itemManager.findItem(l.uuid)){r.next=16;break}return n.alertService.alert("The item you are trying to delete cannot be found."),r.abrupt("continue",21);case 16:if(![P.a.Component,P.a.Theme].includes(f.content_type)){r.next=19;break}return r.next=19,n.deactivateComponent(f.uuid);case 19:return r.next=21,n.itemManager.setItemToBeDeleted(f.uuid);case 21:r.next=10;break;case 23:r.next=28;break;case 25:r.prev=25,r.t0=r.catch(8),c.e(r.t0);case 28:return r.prev=28,c.f(),r.finish(28);case 31:n.syncService.sync(),s={deleted:!0},r.next=36;break;case 35:s={deleted:!1};case 36:n.replyToMessage(e,t,s);case 37:case"end":return r.stop()}}),r,null,[[8,25,28,31]])}))))}},{key:"handleRequestPermissionsMessage",value:function(e,t){var n=this;this.runWithPermissions(e.uuid,t.data.permissions,(function(){n.replyToMessage(e,t,{approved:!0})}))}},{key:"handleSetComponentDataMessage",value:function(e,t){var n=this;this.runWithPermissions(e.uuid,[],vr(i.a.mark((function r(){return i.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.itemManager.changeComponent(e.uuid,(function(e){e.componentData=t.data.componentData}));case 2:n.syncService.sync();case 3:case"end":return r.stop()}}),r)}))))}},{key:"handleToggleComponentMessage",value:(y=vr(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.toggleComponent(t);case 2:this.syncService.sync();case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"toggleComponent",value:(p=vr(i.a.mark((function e(t){var n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.area!==X.Modal){e.next=4;break}this.openModalComponent(t),e.next=39;break;case 4:if(!t.active){e.next=9;break}return e.next=7,this.deactivateComponent(t.uuid);case 7:e.next=39;break;case 9:if(t.content_type!==P.a.Theme){e.next=37;break}return n=t,r=this.getActiveThemes(),e.next=14,this.activateComponent(t.uuid);case 14:if(n.isLayerable()){e.next=35;break}return e.next=17,Object(u.E)(10);case 17:a=mr(r),e.prev=18,a.s();case 20:if((o=a.n()).done){e.next=27;break}if(!(s=o.value)||s.isLayerable()){e.next=25;break}return e.next=25,this.deactivateComponent(s.uuid);case 25:e.next=20;break;case 27:e.next=32;break;case 29:e.prev=29,e.t0=e.catch(18),a.e(e.t0);case 32:return e.prev=32,a.f(),e.finish(32);case 35:e.next=39;break;case 37:return e.next=39,this.activateComponent(t.uuid);case 39:case"end":return e.stop()}}),e,this,[[18,29,32,35]])}))),function(e){return p.apply(this,arguments)})},{key:"handleInstallLocalComponentMessage",value:function(e,t){if(this.isNativeExtension(e)){var n=this.itemManager.findItem(t.data.uuid);this.desktopManager.installComponent(n)}}},{key:"runWithPermissions",value:function(e,t,n){var r=this.itemManager.findItem(e);t=Object(u.a)(t);var a,o=r.permissions,s=mr(t.slice());try{var c=function(){var e=a.value,n=o.find((function(t){return t.name===e.name}));if(!n)return"continue";var r=e.content_types;if(!r)return Object(u.k)(t,e),"continue";var i,s=mr(n.content_types);try{for(s.s();!(i=s.n()).done;){var c=i.value;Object(u.B)(r,c)}}catch(e){s.e(e)}finally{s.f()}0===r.length&&Object(u.k)(t,e)};for(s.s();!(a=s.n()).done;)c()}catch(e){s.e(e)}finally{s.f()}t.length>0?this.promptForPermissions(r,t,function(){var e=vr(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t&&n();case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()):n()}},{key:"promptForPermissions",value:function(e,t,n){var r,a=this,o={component:e,permissions:t,permissionsString:this.permissionsStringForPermissions(t,e),actionBlock:n,callback:(r=vr(i.a.mark((function n(r){return i.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!r){n.next=5;break}return a.log("Changing component to expand permissions",e),n.next=4,a.itemManager.changeItem(e.uuid,(function(n){var r,a=Object(u.a)(e.permissions),o=mr(t);try{var i=function(){var e=r.value,t=a.find((function(t){return t.name===e.name}));if(t){var n=t.content_types||[];t.content_types=ir()(n.concat(e.content_types))}else a.push(e)};for(o.s();!(r=o.n()).done;)i()}catch(e){o.e(e)}finally{o.f()}n.permissions=a}));case 4:a.syncService.sync();case 5:a.permissionDialogs=a.permissionDialogs.filter((function(n){return n===o?(n.actionBlock&&n.actionBlock(r),!1):!!(n.component!==e||n.permissions!==t&&(a=t,n.permissions.some((function(e){return!a.find((function(t){return JSON.stringify(t)===JSON.stringify(e)}))}))))||(r&&n.actionBlock&&n.actionBlock(r),!1);var a})),a.permissionDialogs.length>0&&a.presentPermissionsDialog(a.permissionDialogs[0]);case 7:case"end":return n.stop()}}),n)}))),function(e){return r.apply(this,arguments)})},s=ar()(this.permissionDialogs,{component:e});this.permissionDialogs.push(o),s?this.log("Existing dialog, not presenting."):this.presentPermissionsDialog(o)}},{key:"presentPermissionsDialog",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"openModalComponent",value:function(e){throw"Must override SNComponentManager.presentPermissionsDialog"}},{key:"registerHandler",value:function(e){var t=this;return this.handlers.push(e),function(){var n=ar()(t.handlers,{identifier:e.identifier});n?Object(u.B)(t.handlers,n):t.log("Attempting to deregister non-existing handler")}}},{key:"findOrCreateDataForComponent",value:function(e){var t=this.componentState[e];return t||(t={},this.componentState[e]=t),t}},{key:"setReadonlyStateForComponent",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.findOrCreateDataForComponent(e.uuid);r.readonly=t,r.lockReadonly=n}},{key:"getReadonlyStateForComponent",value:function(e){var t=this.findOrCreateDataForComponent(e.uuid);return{readonly:t.readonly,lockReadonly:t.lockReadonly}}},{key:"registerComponentWindow",value:(f=vr(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Register component window",t),(r=this.findOrCreateDataForComponent(t.uuid)).window===n&&this.log("Web|componentManager","attempting to re-register same component window."),this.log("Web|componentManager|registerComponentWindow",t),r.window=n,e.next=7,h.GenerateUuid();case 7:r.sessionKey=e.sent,this.sendMessageToComponent(t,{action:Z.ComponentRegistered,sessionKey:r.sessionKey,componentData:t.componentData,data:{uuid:t.uuid,environment:(i=this.environment,s=void 0,(ur(s={},er.Web,"web"),ur(s,er.Desktop,"desktop"),ur(s,er.Mobile,"mobile"),s)[i]),platform:(a=this.platform,o=void 0,(ur(o={},tr.MacWeb,"mac-web"),ur(o,tr.MacDesktop,"mac-desktop"),ur(o,tr.LinuxWeb,"linux-web"),ur(o,tr.LinuxDesktop,"linux-desktop"),ur(o,tr.WindowsWeb,"windows-web"),ur(o,tr.WindowsDesktop,"windows-desktop"),ur(o,tr.Ios,"ios"),ur(o,tr.Android,"android"),o)[a]),activeThemeUrls:this.urlsForActiveThemes()}}),this.postActiveThemesToComponent(t),this.desktopManager&&this.desktopManager.notifyComponentActivation(t);case 11:case"end":return e.stop()}var a,o,i,s}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"registerComponent",value:function(e){this.log("Registering component",e);var t=this.itemManager.findItem(e);this.activeComponents[e]=t.area;var n,r=mr(this.handlers);try{for(r.s();!(n=r.n()).done;){var a,o=n.value;(o.areas.includes(t.area)||o.areas.includes(X.Any))&&(null===(a=o.activationHandler)||void 0===a||a.call(o,e,t))}}catch(e){r.e(e)}finally{r.f()}t.area===X.Themes&&this.postActiveThemesToAllComponents()}},{key:"activateComponent",value:(l=vr(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Activating component",t),(n=this.itemManager.findItem(t)).active){e.next=5;break}return e.next=5,this.itemManager.changeComponent(n.uuid,(function(e){e.active=!0}));case 5:this.registerComponent(t);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"deregisterComponent",value:function(e){this.log("Degregistering component",e);var t=this.itemManager.findItem(e);delete this.componentState[e];var n=this.activeComponents[e];if(delete this.activeComponents[e],n){var r,a=mr(this.handlers);try{for(a.s();!(r=a.n()).done;){var o,i=r.value;(i.areas.includes(n)||i.areas.includes(X.Any))&&(null===(o=i.activationHandler)||void 0===o||o.call(i,e,t))}}catch(e){a.e(e)}finally{a.f()}}this.streamObservers=this.streamObservers.filter((function(t){return t.componentUuid!==e})),this.contextStreamObservers=this.contextStreamObservers.filter((function(t){return t.componentUuid!==e})),n===X.Themes&&this.postActiveThemesToAllComponents()}},{key:"deactivateComponent",value:(c=vr(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Deactivating component",t),!(null==(r=null===(n=this.itemManager)||void 0===n?void 0:n.findItem(t))?void 0:r.active)){e.next=5;break}return e.next=5,this.itemManager.changeComponent(r.uuid,(function(e){e.active=!1}));case 5:this.findOrCreateDataForComponent(t).sessionKey=void 0,this.deregisterComponent(t);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"reloadComponent",value:(o=vr(i.a.mark((function e(t){var n,r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Reloading component",t),r=null===(n=this.itemManager)||void 0===n?void 0:n.findItem(t),e.next=4,this.itemManager.changeComponent(r.uuid,(function(e){e.active=!1}));case 4:return this.deregisterComponent(r.uuid),e.abrupt("return",new Promise((function(e){a.timeout(vr(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.itemManager.changeComponent(r.uuid,(function(e){e.active=!0}));case 2:a.registerComponent(r.uuid),e();case 4:case"end":return t.stop()}}),t)}))))})));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"deleteComponent",value:(a=vr(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.setItemToBeDeleted(t);case 2:this.syncService.sync();case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"isComponentActive",value:function(e){return e.active}},{key:"iframeForComponent",value:function(e){for(var t=0,n=Array.from(document.getElementsByTagName("iframe"));t<n.length;t++){var r=n[t];if(r.dataset.componentId===e)return r}}},{key:"focusChangedForComponent",value:function(e){var t,n=document.activeElement===this.iframeForComponent(e.uuid),r=mr(this.handlers);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.focusHandler&&a.focusHandler(e,n)}}catch(e){r.e(e)}finally{r.f()}}},{key:"handleSetSizeEvent",value:function(e,t){var n=function(e,n){var r=Object(u.s)(n.width)?n.width:"".concat(t.width,"px"),a=Object(u.s)(n.height)?n.height:"".concat(t.height,"px");e&&e.setAttribute("style","width:".concat(r,"; height:").concat(a,";"))};if(e.area===X.Rooms||e.area===X.Modal){var r=e.area===X.Rooms?"inner":"outer",a=document.getElementById("component-content-".concat(r,"-").concat(e.uuid));a&&n(a,t)}else{var o=this.iframeForComponent(e.uuid);if(!o)return;if(n(o,t),e.area===X.EditorStack){var i=o.parentElement;i&&n(i,t)}}}},{key:"editorForNote",value:function(e){var t,n,r=mr(this.componentsForArea(X.Editor));try{for(r.s();!(t=r.n()).done;){var a=t.value;if(a.isExplicitlyEnabledForItem(e.uuid))return a}}catch(e){r.e(e)}finally{r.f()}return this.isMobile?e.mobilePrefersPlainEditor||(n=this.getDefaultEditor()):e.prefersPlainEditor||(n=this.getDefaultEditor()),n&&!n.isExplicitlyDisabledForItem(e.uuid)?n:void 0}},{key:"getDefaultEditor",value:function(){var e=this.componentsForArea(X.Editor);return this.isMobile?e.filter((function(e){return e.isMobileDefault}))[0]:e.filter((function(e){return e.isDefaultEditor()}))[0]}},{key:"permissionsStringForPermissions",value:function(e,t){var n="",r=e.length,a=function(e,t){return e>0?e===t-1?2===t?" and ":", and ":", ":""};return e.forEach((function(e,o){if(e.name===Z.StreamItems){for(var i=e.content_types.map((function(e){var t=Object(P.c)(e);return t?t+"s":"items of type "+e})),s="",c=0;c<i.length;c++){var u=i[c];s+=a(c,i.length+r-o-1),s+=u}n+=a(o,r),n+=s,i.length>=2&&o<r-1&&(n+=", ")}else if(e.name===Z.StreamContextItem){var l,f=(hr(l={},X.EditorStack,"working note"),hr(l,X.NoteTags,"working note"),hr(l,X.Editor,"working note"),l);n+=a(o,r),n+=f[t.area]}})),n+"."}},{key:"isDesktop",get:function(){return this.environment===er.Desktop}},{key:"isMobile",get:function(){return this.environment===er.Mobile}},{key:"components",get:function(){return this.itemManager.getItems([P.a.Component,P.a.Theme])}}])&&gr(t.prototype,n),r&&gr(t,r),b}(Gt.a);function Dr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Cr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ir=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseCollection=t,this.applyCollection=n,this.relatedCollectionSet=r}var t,n,r,a,o;return t=e,(n=[{key:"resultingCollection",value:(a=i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw"Must override PayloadDelta.resultingCollection.";case 1:case"end":return e.stop()}}),e)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Dr(o,n,r,i,s,"next",e)}function s(e){Dr(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})},{key:"findBasePayload",value:function(e){return this.baseCollection.find(e)}},{key:"findRelatedPayload",value:function(e,t){var n,r=null===(n=this.relatedCollectionSet)||void 0===n?void 0:n.collectionForSource(t);return null==r?void 0:r.find(e)}}])&&Cr(t.prototype,n),r&&Cr(t,r),e}();function _r(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Rr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Rr(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Rr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Er(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ar=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.directMap={},this.inverseMap={}}var t,n,r;return t=e,(n=[{key:"makeCopy",value:function(){var t=new e;return t.directMap=Object.assign({},this.directMap),t.inverseMap=Object.assign({},this.inverseMap),t}},{key:"getDirectRelationships",value:function(e){return this.directMap[e]||[]}},{key:"getInverseRelationships",value:function(e){return this.inverseMap[e]||[]}},{key:"establishRelationship",value:function(e,t){this.establishDirectRelationship(e,t),this.establishInverseRelationship(e,t)}},{key:"deestablishRelationship",value:function(e,t){this.deestablishDirectRelationship(e,t),this.deestablishInverseRelationship(e,t)}},{key:"setAllRelationships",value:function(e,t){var n=this.directMap[e]||[];this.directMap[e]=t;var r,a=_r(n);try{for(a.s();!(r=a.n()).done;){var o=r.value;this.deestablishInverseRelationship(e,o)}}catch(e){a.e(e)}finally{a.f()}var i,s=_r(t);try{for(s.s();!(i=s.n()).done;){var c=i.value;this.establishInverseRelationship(e,c)}}catch(e){s.e(e)}finally{s.f()}}},{key:"removeFromMap",value:function(e){var t,n=_r(this.directMap[e]||[]);try{for(n.s();!(t=n.n()).done;){var r=t.value;Object(u.B)(this.inverseMap[r]||[],e)}}catch(e){n.e(e)}finally{n.f()}delete this.directMap[e];var a,o=_r(this.inverseMap[e]||[]);try{for(o.s();!(a=o.n()).done;){var i=a.value;Object(u.B)(this.directMap[i]||[],e)}}catch(e){o.e(e)}finally{o.f()}delete this.inverseMap[e]}},{key:"establishDirectRelationship",value:function(e,t){var n=this.directMap[e]||[];Object(u.b)(n,t),this.directMap[e]=n}},{key:"establishInverseRelationship",value:function(e,t){var n=this.inverseMap[t]||[];Object(u.b)(n,e),this.inverseMap[t]=n}},{key:"deestablishDirectRelationship",value:function(e,t){var n=this.directMap[e]||[];Object(u.B)(n,t),this.directMap[e]=n}},{key:"deestablishInverseRelationship",value:function(e,t){var n=this.inverseMap[t]||[];Object(u.B)(n,e),this.inverseMap[t]=n}}])&&Er(t.prototype,n),r&&Er(t,r),e}();function Mr(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Tr(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Tr(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Tr(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Kr(e){if(null==e)throw new TypeError("Cannot destructure undefined")}function Fr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Lr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Vr=function(){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=arguments.length>1?arguments[1]:void 0,a=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0;Fr(this,e),this.map={},this.typedMap=(Kr(t={}),t),this.dirtyIndex=new Set,this.invalidsIndex=new Set,this.nondeletedIndex=new Set,n?(this.map=r,this.typedMap=a,this.referenceMap=o,this.conflictMap=i):(this.referenceMap=new Ar,this.conflictMap=new Ar)}var t,n,r;return t=e,(n=[{key:"uuids",value:function(){return Object.keys(this.map)}},{key:"all",value:function(e){var t=this;if(e){if(Array.isArray(e)){var n,r=[],a=Mr(e);try{for(a.s();!(n=a.n()).done;){var o=n.value;Object(u.j)(r,this.typedMap[o]||[])}}catch(e){a.e(e)}finally{a.f()}return r}var i;return(null===(i=this.typedMap[e])||void 0===i?void 0:i.slice())||[]}return Object.keys(this.map).map((function(e){return t.map[e]}))}},{key:"find",value:function(e){return this.map[e]}},{key:"dirtyElements",value:function(){var e=Array.from(this.dirtyIndex);return this.findAll(e)}},{key:"invalidElements",value:function(){var e=Array.from(this.invalidsIndex);return this.findAll(e)}},{key:"nondeletedElements",value:function(){var e=Array.from(this.nondeletedIndex);return this.findAll(e)}},{key:"findAll",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=[],a=Mr(e);try{for(a.s();!(t=a.n()).done;){var o=t.value,i=this.map[o];(i||n)&&r.push(i)}}catch(e){a.e(e)}finally{a.f()}return r}},{key:"set",value:function(e){if(0!==(e=Array.isArray(e)?e:[e]).length){var t,n=Mr(e);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(this.map[r.uuid]=r,this.setToTypedMap(r),r.dirty?this.dirtyIndex.add(r.uuid):this.dirtyIndex.delete(r.uuid),r.errorDecrypting||r.waitingForKey?this.invalidsIndex.add(r.uuid):this.invalidsIndex.delete(r.uuid),r.deleted)this.referenceMap.removeFromMap(r.uuid),this.nondeletedIndex.delete(r.uuid);else{this.nondeletedIndex.add(r.uuid);var a=r.safeContent.conflict_of;a&&this.conflictMap.establishRelationship(a,r.uuid),this.referenceMap.setAllRelationships(r.uuid,r.references.map((function(e){return e.uuid})))}}}catch(e){n.e(e)}finally{n.f()}}else console.warn("Attempting to set 0 elements onto collection")}},{key:"discard",value:function(e){var t,n=Mr(e=Array.isArray(e)?e:[e]);try{for(n.s();!(t=n.n()).done;){var r=t.value;this.conflictMap.removeFromMap(r.uuid),this.referenceMap.removeFromMap(r.uuid),this.deleteFromTypedMap(r),delete this.map[r.uuid]}}catch(e){n.e(e)}finally{n.f()}}},{key:"setToTypedMap",value:function(e){var t=this.typedMap[e.content_type]||[];cr()(t,{uuid:e.uuid}),t.push(e),this.typedMap[e.content_type]=t}},{key:"deleteFromTypedMap",value:function(e){var t=this.typedMap[e.content_type]||[];cr()(t,{uuid:e.uuid}),this.typedMap[e.content_type]=t}},{key:"uuidsThatReferenceUuid",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");return this.referenceMap.getInverseRelationships(e)}},{key:"elementsReferencingElement",value:function(e){var t=this.uuidsThatReferenceUuid(e.uuid);return this.findAll(t)}},{key:"conflictsOf",value:function(e){var t=this.conflictMap.getDirectRelationships(e);return this.findAll(t)}}])&&Lr(t.prototype,n),r&&Lr(t,r),e}();function Nr(e){return(Nr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ur(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Wr(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Br(e,t){return(Br=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Hr(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=qr(e);if(t){var a=qr(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return zr(this,n)}}function zr(e,t){return!t||"object"!==Nr(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function qr(e){return(qr=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Jr=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Br(e,t)}(o,e);var t,n,r,a=Hr(o);function o(){return Ur(this,o),a.apply(this,arguments)}return t=o,r=[{key:"WithPayloads",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0,n=new o;return n.source=t,e.length>0&&n.set(e),Object.freeze(n),n}},{key:"FromCollection",value:function(e){var t=new o(!0,Object.freeze(Object.assign({},e.map)),Object.freeze(Object.assign({},e.typedMap)),Object.freeze(e.referenceMap.makeCopy()),Object.freeze(e.conflictMap.makeCopy()));return Object.freeze(t),t}}],(n=[{key:"payloads",get:function(){return this.all()}}])&&Wr(t.prototype,n),r&&Wr(t,r),o}(Vr);function Gr(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return $r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return $r(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function $r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Qr(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Yr(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qr(Object(n),!0).forEach((function(t){ea(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qr(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Xr(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Zr(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Xr(o,r,a,i,s,"next",e)}function s(e){Xr(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ea(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ta=ea({},P.a.Note,(function(e,t,n){var r=n.all(P.a.Component).map((function(e){return Ut(e)})).filter((function(e){return e.area===X.Editor})).find((function(t){return t.isExplicitlyEnabledForItem(e.uuid)}));if(r){var a=new he(r,d.c.Internal);return a.associateWithItem(t.uuid),[a.getResult()]}}));function na(e,t,n){return ra.apply(this,arguments)}function ra(){return(ra=Zr(i.a.mark((function e(t,n,r){var a,o,s,c,l,f,p;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=[],e.next=3,h.GenerateUuid();case 3:return e.t0=e.sent,e.t1=new Date,o={uuid:e.t0,dirty:!0,dirtiedDate:e.t1,lastSyncBegan:null,lastSyncEnd:null},r&&(o.content=Yr(Yr({},t.safeContent),{},{conflict_of:t.uuid})),s=Object(j.b)(t,o),a.push(s),c=n.elementsReferencingElement(t),e.next=12,ia(c,[{uuid:s.uuid,content_type:s.content_type}]);case 12:return l=e.sent,Object(u.j)(a,l),(f=ta[t.content_type])&&(p=f(t,s,n))&&Object(u.j)(a,p),e.abrupt("return",a);case 17:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function aa(e,t){return oa.apply(this,arguments)}function oa(){return(oa=Zr(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],e.t0=j.b,e.t1=t,e.next=5,h.GenerateUuid();case 5:return e.t2=e.sent,e.t3=new Date,e.t4={uuid:e.t2,dirty:!0,dirtiedDate:e.t3,lastSyncBegan:null,lastSyncEnd:null},a=(0,e.t0)(e.t1,e.t4),r.push(a),o=n.elementsReferencingElement(t),e.next=13,ia(o,[{uuid:a.uuid,content_type:a.content_type}],[t.uuid]);case 13:return s=e.sent,Object(u.j)(r,s),c=Object(j.b)(t,{deleted:!0,dirty:!1,content:void 0}),r.push(c),e.abrupt("return",r);case 18:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ia(e,t,n){return sa.apply(this,arguments)}function sa(){return(sa=Zr(i.a.mark((function e(t,n,r){var a,o,s,c,u,l,f,p,y,h,d,v;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=[],o=Gr(t);try{for(o.s();!(s=o.n()).done;){if(c=s.value,u=c.contentObject.references.slice(),n){l=Gr(n);try{for(l.s();!(f=l.n()).done;)p=f.value,u.push(p)}catch(e){l.e(e)}finally{l.f()}}if(r){y=Gr(r);try{for(y.s();!(h=y.n()).done;)d=h.value,cr()(u,{uuid:d})}catch(e){y.e(e)}finally{y.f()}}v=Object(j.b)(c,{dirty:!0,dirtiedDate:new Date,content:Yr(Yr({},c.safeContent),{},{references:u})}),a.push(v)}}catch(e){o.e(e)}finally{o.f()}return e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ca(e,t){var n=Ut(e),r=Ut(t);return n.isItemContentEqualWith(r)}var ua=n(5);function la(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function fa(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?la(Object(n),!0).forEach((function(t){pa(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):la(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function pa(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ya(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ha(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ya(o,r,a,i,s,"next",e)}function s(e){ya(o,r,a,i,s,"throw",e)}i(void 0)}))}}function da(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var va=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.baseCollection=t,this.basePayload=n,this.applyPayload=r,this.source=a}var t,n,r,a,o;return t=e,(n=[{key:"resultingCollection",value:(o=ha(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Ut(this.basePayload),n=Ut(this.applyPayload),r=t.strategyWhenConflictingWithItem(n),e.next=5,this.payloadsByHandlingStrategy(r);case 5:return a=e.sent,e.abrupt("return",Jr.WithPayloads(a,this.source));case 7:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"payloadsByHandlingStrategy",value:(a=ha(i.a.mark((function e(t){var n,r,a,o,s,c,l,f,p,y,h,d;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.baseCollection.conflictsOf(this.applyPayload.uuid)[0])||!ca(n,this.applyPayload)){e.next=3;break}return e.abrupt("return",[]);case 3:if(t!==ne.a.KeepLeft){e.next=7;break}return r=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),a=Object(j.b)(this.basePayload,{updated_at:r,dirty:!0,dirtiedDate:new Date}),e.abrupt("return",[a]);case 7:if(t!==ne.a.KeepRight){e.next=10;break}return o=Object(j.g)(this.applyPayload,this.basePayload,[ua.a.LastSyncBegan],{lastSyncEnd:new Date}),e.abrupt("return",[o]);case 10:if(t!==ne.a.KeepLeftDuplicateRight){e.next=17;break}return s=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),c=Object(j.b)(this.basePayload,{updated_at:s,dirty:!0,dirtiedDate:new Date}),e.next=15,na(this.applyPayload,this.baseCollection,!0);case 15:return l=e.sent,e.abrupt("return",[c].concat(l));case 17:if(t!==ne.a.DuplicateLeftKeepRight){e.next=23;break}return e.next=20,na(this.basePayload,this.baseCollection,!0);case 20:return f=e.sent,p=Object(j.g)(this.applyPayload,this.basePayload,[ua.a.LastSyncBegan],{lastSyncEnd:new Date}),e.abrupt("return",f.concat([p]));case 23:if(t!==ne.a.KeepLeftMergeRefs){e.next=28;break}return y=Object(u.J)(this.basePayload.contentObject.references,this.applyPayload.contentObject.references,["uuid","content_type"]),h=Object(u.n)(this.basePayload.updated_at,this.applyPayload.updated_at),d=Object(j.b)(this.basePayload,{updated_at:h,dirty:!0,dirtiedDate:new Date,content:fa(fa({},this.basePayload.safeContent),{},{references:y})}),e.abrupt("return",[d]);case 28:throw"Unhandled strategy";case 29:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})}])&&da(t.prototype,n),r&&da(t,r),e}();function ma(e){return(ma="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ba(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ga(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ga(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function ga(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function wa(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ka(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){wa(o,r,a,i,s,"next",e)}function s(e){wa(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Sa(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function xa(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Oa(e,t){return(Oa=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Pa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Da(e);if(t){var a=Da(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ja(this,n)}}function ja(e,t){return!t||"object"!==ma(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Da(e){return(Da=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ca=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Oa(e,t)}(c,e);var t,n,r,a,o,s=Pa(c);function c(){return Sa(this,c),s.apply(this,arguments)}return t=c,(n=[{key:"resultingCollection",value:(o=ka(i.a.mark((function e(){var t,n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=ba(this.applyCollection.all()),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=13;break}return a=r.value,e.next=8,this.payloadsByHandlingPayload(a,t);case 8:o=e.sent,s=o.map((function(e){return Object(j.b)(e,{dirty:!0,dirtiedDate:new Date,deleted:!1})})),Object(u.j)(t,s);case 11:e.next=4;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),n.e(e.t0);case 18:return e.prev=18,n.f(),e.finish(18);case 21:return e.abrupt("return",Jr.WithPayloads(t,D.a.FileImport));case 22:case"end":return e.stop()}}),e,this,[[2,15,18,21]])}))),function(){return o.apply(this,arguments)})},{key:"payloadsByHandlingPayload",value:(a=ka(i.a.mark((function e(t,n){var r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=n.find((function(e){return e.contentObject.conflict_of===t.uuid})))||(r=n.find((function(e){return e.uuid===t.uuid}))),r||(r=this.findBasePayload(t.uuid)),r){e.next=5;break}return e.abrupt("return",[t]);case 5:return a=new va(this.baseCollection,r,t,D.a.FileImport),e.next=8,a.resultingCollection();case 8:return o=e.sent,e.abrupt("return",o.all());case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})}])&&xa(t.prototype,n),r&&xa(t,r),c}(Ir);function Ia(e){return(Ia="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _a(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ra(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ra(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Ra(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ea(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Aa(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Ea(o,r,a,i,s,"next",e)}function s(e){Ea(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Ma(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ta(e,t,n){return(Ta="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Va(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Ka(e,t){return(Ka=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Fa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Va(e);if(t){var a=Va(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return La(this,n)}}function La(e,t){return!t||"object"!==Ia(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Va(e){return(Va=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Na=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ka(e,t)}(y,e);var t,n,r,a,o,c,l,f,p=Fa(y);function y(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,y),(e=p.call(this)).changeObservers=[],e.emitQueue=[],e.collection=new Vr,e}return t=y,(n=[{key:"getMasterCollection",value:function(){return Jr.FromCollection(this.collection)}},{key:"deinit",value:function(){Ta(Va(y.prototype),"deinit",this).call(this),this.changeObservers.length=0,this.resetState()}},{key:"resetState",value:function(){this.collection=new Vr}},{key:"find",value:function(e){return this.collection.findAll(e)}},{key:"emitCollection",value:(f=Aa(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.emitPayloads(t.all(),t.source,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"emitPayload",value:(l=Aa(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.emitPayloads([t],n,r);case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"emitPayloads",value:(c=Aa(i.a.mark((function e(t,n,r){var a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return 0===t.length&&console.warn("Attempting to emit 0 payloads."),e.abrupt("return",new Promise((function(e){a.emitQueue.push({payloads:t,source:n,sourceKey:r,resolve:e}),1===a.emitQueue.length&&a.popQueue()})));case 2:case"end":return e.stop()}}),e)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"popQueue",value:(o=Aa(i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=this.emitQueue[0],n=this.mergePayloadsOntoMaster(t.payloads),r=n.changed,a=n.inserted,o=n.discarded,this.notifyChangeObservers(r,a,o,t.source,t.sourceKey),Object(u.B)(this.emitQueue,t),t.resolve(),this.emitQueue.length>0&&this.popQueue();case 6:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"mergePayloadsOntoMaster",value:function(e){var t,n=[],r=[],a=[],o=_a(e);try{for(o.s();!(t=o.n()).done;){var i=t.value;if(i.uuid&&i.content_type){var s=this.collection.find(i.uuid),c=s?Object(j.g)(s,i):i;c.discardable?(this.collection.discard(c),a.push(c)):(this.collection.set(c),s?n.push(c):r.push(c))}else console.error("Payload is corrupt:",i)}}catch(e){o.e(e)}finally{o.f()}return{changed:n,inserted:r,discarded:a}}},{key:"addObserver",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;Array.isArray(e)||(e=[e]);var a={types:e,priority:r,callback:t};return this.changeObservers.push(a),function(){Object(u.B)(n.changeObservers,a)}}},{key:"notifyChangeObservers",value:function(e,t,n,r,a){var o,i=function(e,t){return t.includes(P.a.Any)?e.slice():e.slice().filter((function(e){return t.includes(e.content_type)}))},s=_a(this.changeObservers.slice().sort((function(e,t){return e.priority<t.priority?-1:1})));try{for(s.s();!(o=s.n()).done;){var c=o.value;c.callback(i(e,c.types),i(t,c.types),i(n,c.types),r,a)}}catch(e){s.e(e)}finally{s.f()}}},{key:"importPayloads",value:(a=Aa(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new Ca(this.getMasterCollection(),Jr.WithPayloads(t,D.a.FileImport)),e.next=3,n.resultingCollection();case 3:return r=e.sent,e.next=6,this.emitCollection(r);case 6:return e.abrupt("return",Object(s.b)(r.payloads));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"removePayloadLocally",value:function(e){this.collection.discard(e)}}])&&Ma(t.prototype,n),r&&Ma(t,r),y}(Gt.a),Ua=n(8);function Wa(e){return(Wa="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ba(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ha(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ha(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Ha(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function za(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function qa(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){za(o,r,a,i,s,"next",e)}function s(e){za(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Ja(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ga(e,t,n){return(Ga="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Xa(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function $a(e,t){return($a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Qa(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Xa(e);if(t){var a=Xa(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ya(this,n)}}function Ya(e,t){return!t||"object"!==Wa(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Xa(e){return(Xa=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Za=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&$a(e,t)}(f,e);var t,n,r,a,o,c,l=Qa(f);function f(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(n=l.call(this)).resolveQueue=[],n.registeredPredicates=[],n.itemManager=e,n.syncService=t,n.addObservers(),n}return t=f,(n=[{key:"deinit",value:function(){this.syncService=void 0,this.itemManager=void 0,this.resolveQueue.length=0,this.registeredPredicates.length=0,this.removeItemObserver(),this.removeItemObserver=void 0,this.removeSyncObserver(),this.removeSyncObserver=void 0,Ga(Xa(f.prototype),"deinit",this).call(this)}},{key:"popResolveQueue",value:function(){var e=this.resolveQueue.slice();return this.resolveQueue=[],e}},{key:"addObservers",value:function(){var e=this;this.removeItemObserver=this.itemManager.addObserver(P.a.Any,(function(t,n){n.length>0&&(e.resolveQueue=e.resolveQueue.concat(n))})),this.removeSyncObserver=this.syncService.addEventObserver(function(){var t=qa(i.a.mark((function t(n){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n!==Ua.a.DownloadFirstSyncCompleted&&n!==Ua.a.FullSyncCompleted){t.next=3;break}return t.next=3,e.resolveSingletonsForItems(e.popResolveQueue(),n);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}},{key:"registerPredicate",value:function(e){this.registeredPredicates.push(e)}},{key:"validItemsMatchingPredicate",value:function(e){return this.itemManager.itemsMatchingPredicate(e).filter((function(e){return!e.errorDecrypting}))}},{key:"resolveSingletonsForItems",value:(c=qa(i.a.mark((function e(t,n){var r,a,o,s,c,l,f,p,y=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=function(e){var t,n=Ba(y.registeredPredicates);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(e.satisfiesPredicate(r))return y.validItemsMatchingPredicate(r)}}catch(e){n.e(e)}finally{n.f()}},a=function(e){return e.isSingleton?y.validItemsMatchingPredicate(e.singletonPredicate):null},o=function(e){var t=a(e);return t&&t.length>0?t:r(e)},s=[],c=Ba(t),e.prev=5,c.s();case 7:if((l=c.n()).done){e.next=19;break}if(f=l.value,!s.includes(f)){e.next=11;break}return e.abrupt("continue",17);case 11:if(p=o(f),Object(u.j)(s,p||[]),p&&!(p.length<=1)){e.next=15;break}return e.abrupt("continue",17);case 15:return e.next=17,this.handleStrategy(p,f.singletonStrategy);case 17:e.next=7;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(5),c.e(e.t0);case 24:return e.prev=24,c.f(),e.finish(24);case 27:s.length>0&&n===Ua.a.FullSyncCompleted&&setTimeout((function(){y.syncService.sync()}));case 28:case"end":return e.stop()}}),e,this,[[5,21,24,27]])}))),function(e,t){return c.apply(this,arguments)})},{key:"handleStrategy",value:(o=qa(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n===d.e.KeepEarliest){e.next=2;break}throw"Unhandled singleton strategy";case 2:return r=t.sort((function(e,t){return e.errorDecrypting?1:t.errorDecrypting||e.created_at<t.created_at?-1:1})),a=Object(u.d)(r,0),e.next=6,this.itemManager.setItemsToBeDeleted(Object(s.b)(a));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"findOrCreateSingleton",value:(a=qa(i.a.mark((function e(t,n,r){var a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=qa(i.a.mark((function e(o){var c,u,l,f,p,y,d;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((c=a.validItemsMatchingPredicate(t)).length>0)){e.next=3;break}return e.abrupt("return",o(c[0]));case 3:if(a.syncService.getLastSyncDate()){e.next=14;break}return u=!1,l=a.itemManager.addObserver(n,(function(e,n){if(n.length>0){var r=a.itemManager.subItemsMatchingPredicates(n,[t]);r.length>0&&(u=!0,o(r[0]))}})),e.next=8,a.syncService.sync();case 8:if(l(),!u){e.next=11;break}return e.abrupt("return");case 11:if(!((f=a.validItemsMatchingPredicate(t)).length>0)){e.next=14;break}return e.abrupt("return",o(f[0]));case 14:return p=a.itemManager.itemsMatchingPredicate(t).filter((function(e){return e.errorDecrypting})),e.next=17,a.itemManager.setItemsToBeDeleted(Object(s.b)(p));case 17:return e.t0=j.e,e.next=20,h.GenerateUuid();case 20:return e.t1=e.sent,e.t2=n,e.t3=r,e.t4=new Date,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:!0,dirtiedDate:e.t4},y=(0,e.t0)(e.t5),e.next=28,a.itemManager.emitItemFromPayload(y);case 28:if(d=e.sent){e.next=31;break}throw Error("Created singleton item should not be null ".concat(n));case 31:return e.next=33,a.syncService.sync();case 33:return e.abrupt("return",o(d));case 34:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),function(e,t,n){return a.apply(this,arguments)})}])&&Ja(t.prototype,n),r&&Ja(t,r),f}(Gt.a);function eo(e){return(eo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function to(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return no(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return no(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function no(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ro(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ao(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ro(o,r,a,i,s,"next",e)}function s(e){ro(o,r,a,i,s,"throw",e)}i(void 0)}))}}function oo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function io(e,t,n){return(io="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=lo(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function so(e,t){return(so=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function co(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=lo(e);if(t){var a=lo(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return uo(this,n)}}function uo(e,t){return!t||"object"!==eo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function lo(e){return(lo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var fo=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&so(e,t)}(d,e);var t,n,r,a,o,s,c,u,l,f,p,y,h=co(d);function d(e,t,n,r,a,o,i){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,d),(s=h.call(this)).previousPasswords=[],s.itemManager=e,s.alertService=t,s.deviceInterface=n,s.httpService=r,s.modelManager=a,s.protocolService=o,s.syncService=i,s.previousPasswords=[],s}return t=d,(n=[{key:"deinit",value:function(){this.itemManager=void 0,this.alertService=void 0,this.deviceInterface=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.syncService=void 0,this.previousPasswords.length=0,io(lo(d.prototype),"deinit",this).call(this)}},{key:"getExtensions",value:function(){return this.itemManager.nonErroredItemsForContentType(P.a.ActionsExtension)}},{key:"extensionsInContextOfItem",value:function(e){return this.getExtensions().filter((function(t){return t.supported_types.includes(e.content_type)||t.actionsWithContextForItem(e).length>0}))}},{key:"loadExtensionInContextOfItem",value:(y=ao(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={content_type:n.content_type,item_uuid:n.uuid},e.next=3,this.httpService.getAbsolute(t.url,r).catch((function(e){return console.error("Error loading extension",e),null}));case 3:if(a=e.sent){e.next=6;break}return e.abrupt("return");case 6:return o=a.description||t.description,s=a.supported_types||t.supported_types,c=a.actions?a.actions.map((function(e){return new Ke(e)})):[],e.next=11,this.itemManager.changeActionsExtension(t.uuid,(function(e){e.description=o,e.supported_types=s,e.actions=c,e.hidden=!1}));case 11:return e.abrupt("return",this.itemManager.findItem(t.uuid));case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"runAction",value:(p=ao(i.a.mark((function e(t,n,r){var a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=t.verb,e.next="get"===e.t0?3:"render"===e.t0?7:"show"===e.t0?11:"post"===e.t0?15:19;break;case 3:return e.next=5,this.handleGetAction(t,r);case 5:return a=e.sent,e.abrupt("break",20);case 7:return e.next=9,this.handleRenderAction(t,r);case 9:return a=e.sent,e.abrupt("break",20);case 11:return e.next=13,this.handleShowAction(t);case 13:return a=e.sent,e.abrupt("break",20);case 15:return e.next=17,this.handlePostAction(t,n);case 17:return a=e.sent,e.abrupt("break",20);case 19:return e.abrupt("break",20);case 20:return e.abrupt("return",a);case 21:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return p.apply(this,arguments)})},{key:"handleGetAction",value:(f=ao(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.alertService.confirm("Are you sure you want to replace the current note contents with this action's results?");case 2:if(!e.sent){e.next=7;break}return e.abrupt("return",this.runConfirmedGetAction(t,n));case 7:return e.abrupt("return",{error:{message:"Action canceled by user."}});case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"runConfirmedGetAction",value:(l=ao(i.a.mark((function e(t,n){var r,a,o=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpService.getAbsolute(t.url).catch((function(e){var t=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return o.alertService.alert(t.message),{error:t}}));case 2:if(!(r=e.sent).error){e.next=5;break}return e.abrupt("return",{response:r});case 5:return e.next=7,this.payloadByDecryptingResponse(r,n);case 7:return a=e.sent,e.next=10,this.modelManager.emitPayload(Object(j.b)(a,{dirty:!0,dirtiedDate:new Date}),D.a.RemoteActionRetrieved);case 10:return this.syncService.sync(),e.abrupt("return",{response:r,item:r.item});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"handleRenderAction",value:(u=ao(i.a.mark((function e(t,n){var r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpService.getAbsolute(t.url).then(function(){var e=ao(i.a.mark((function e(t){var r,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.payloadByDecryptingResponse(t,n);case 2:if(!(r=e.sent)){e.next=8;break}return e.next=6,a.itemManager.createItem(r.content_type,r.contentObject);case 6:return o=e.sent,e.abrupt("return",{response:t,item:o});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){var t=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return a.alertService.alert(t.message),{error:t}}));case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"payloadByDecryptingResponse",value:(c=ao(i.a.mark((function e(t,n,r){var a,o,s,c,u,l,f,p,y;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(j.e)(t.item),e.next=3,this.protocolService.payloadByDecryptingPayload(a,r);case 3:if((o=e.sent).errorDecrypting){e.next=6;break}return e.abrupt("return",o);case 6:if(t.auth_params){e.next=9;break}return this.alertService.alert("We were unable to decrypt this revision using your current keys, and this revision is missing metadata that would allow us to try different keys to decrypt it. This can likely be fixed with some manual intervention. Please email hello@standardnotes.org for assistance."),e.abrupt("return",void 0);case 9:s=[],c=to(this.previousPasswords),e.prev=11,c.s();case 13:if((u=c.n()).done){e.next=30;break}if(l=u.value,!s.includes(l)){e.next=17;break}return e.abrupt("continue",28);case 17:return s.push(l),e.next=20,this.protocolService.computeRootKey(l,t.auth_params);case 20:if(f=e.sent){e.next=23;break}return e.abrupt("continue",28);case 23:return e.next=25,this.payloadByDecryptingResponse(t,n,f);case 25:if(!(p=e.sent)){e.next=28;break}return e.abrupt("return",p);case 28:e.next=13;break;case 30:e.next=35;break;case 32:e.prev=32,e.t0=e.catch(11),c.e(e.t0);case 35:return e.prev=35,c.f(),e.finish(35);case 38:return e.next=40,n();case 40:return y=e.sent,this.previousPasswords.push(y),e.abrupt("return",this.payloadByDecryptingResponse(t,n,r));case 43:case"end":return e.stop()}}),e,this,[[11,32,35,38]])}))),function(e,t,n){return c.apply(this,arguments)})},{key:"handlePostAction",value:(s=ao(i.a.mark((function e(t,n){var r,a,o,s=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.access_type===Re.Decrypted,e.next=3,this.outgoingPayloadForItem(n,r);case 3:return a=e.sent,o={items:[a]},e.abrupt("return",this.httpService.postAbsolute(t.url,o).then((function(e){return{response:e}})).catch((function(e){return console.error("Action error response:",e),s.alertService.alert("An issue occurred while processing this action. Please try again."),{response:e}})));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"handleShowAction",value:(o=ao(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.deviceInterface.openUrl(t.url),e.abrupt("return",{response:void 0});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"outgoingPayloadForItem",value:(a=ao(i.a.mark((function e(t){var n,r,a,o=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>1&&void 0!==o[1]&&o[1],r=n?Jt.a.FileDecrypted:Jt.a.FileEncrypted,e.next=4,this.protocolService.payloadByEncryptingPayload(t.payloadRepresentation(),r);case 4:return a=e.sent,e.abrupt("return",a.ejected());case 6:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})}])&&oo(t.prototype,n),r&&oo(t,r),d}(Gt.a);function po(e){return(po="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function yo(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ho(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function vo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function mo(e,t){return(mo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function bo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=wo(e);if(t){var a=wo(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return go(this,n)}}function go(e,t){return!t||"object"!==po(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function wo(e){return(wo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ko=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&mo(e,t)}(u,e);var t,n,r,a,o,c=bo(u);function u(){return ho(this,u),c.apply(this,arguments)}return t=u,n=[{key:"compare",value:function(e){if(this.version!==e.version)return!1;var t=this.serverPassword&&e.serverPassword;return this.masterKey===e.masterKey&&(!t||this.serverPassword===e.serverPassword)}},{key:"getPersistableValue",value:function(){var e={version:this.version};return this.masterKey&&(e.masterKey=this.masterKey),this.dataAuthenticationKey&&(e.dataAuthenticationKey=this.dataAuthenticationKey),e}},{key:"version",get:function(){if(!this.payload.safeContent.version)throw"Attempting to create key without version.";return this.payload.safeContent.version}},{key:"isRootKey",get:function(){return!0}},{key:"itemsKey",get:function(){return this.masterKey}},{key:"masterKey",get:function(){return this.payload.safeContent.masterKey}},{key:"serverPassword",get:function(){return this.payload.safeContent.serverPassword}},{key:"dataAuthenticationKey",get:function(){return this.payload.safeContent.dataAuthenticationKey}}],r=[{key:"Create",value:(a=i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=4;break}return e.next=3,h.GenerateUuid();case 3:n=e.sent;case 4:return t.version||(t.dataAuthenticationKey?t.version=xt.a.V002:t.version=xt.a.V001),r=Object(j.e)({uuid:n,content_type:P.a.RootKey,content:Object(s.a)(t)}),e.abrupt("return",new u(r));case 7:case"end":return e.stop()}}),e)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){yo(o,n,r,i,s,"next",e)}function s(e){yo(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e,t){return o.apply(this,arguments)})}],n&&vo(t.prototype,n),r&&vo(t,r),u}(d.d);function So(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function xo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Oo=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.services=t,this.stageHandlers={},this.registerStageHandlers()}var t,n,r,a,o;return t=e,n=[{key:"registerStageHandler",value:function(e,t){this.stageHandlers[e]=t}},{key:"markDone",value:function(){var e;null===(e=this.onDoneHandler)||void 0===e||e.call(this),this.onDoneHandler=void 0}},{key:"onDone",value:function(e){this.onDoneHandler=e}},{key:"handleStage",value:(a=i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.stageHandlers[t])){e.next=4;break}return e.next=4,n();case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){So(o,n,r,i,s,"next",e)}function s(e){So(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e){return o.apply(this,arguments)})}],r=[{key:"timestamp",value:function(){throw"Must override"}}],n&&xo(t.prototype,n),r&&xo(t,r),e}();function Po(e){return(Po="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function jo(e){return function(e){if(Array.isArray(e))return _o(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||Io(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Do(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=Io(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Co(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||Io(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Io(e,t){if(e){if("string"==typeof e)return _o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_o(e,t):void 0}}function _o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ro(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Eo(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ao(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Eo(o,r,a,i,s,"next",e)}function s(e){Eo(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Mo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function To(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ko(e,t){return(Ko=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Fo(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Vo(e);if(t){var a=Vo(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Lo(this,n)}}function Lo(e,t){return!t||"object"!==Po(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Vo(e){return(Vo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var No={WebPasscodeParamsKey:"offlineParams",MobilePasscodeParamsKey:"pc_params",AllAccountKeyParamsKey:"auth_params",WebEncryptedStorageKey:"encryptedStorage",MobileWrappedRootKeyKey:"encrypted_account_keys",AllMigrations:"migrations"},Uo=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ko(e,t)}(x,e);var t,n,r,o,c,l,f,d,v,m,b,w,k,S=Fo(x);function x(){return Mo(this,x),S.apply(this,arguments)}return t=x,n=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(a.PreparingForLaunch_0,Ao(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!fr(e.services.environment)){t.next=4;break}return t.abrupt("return",e.migrateStorageStructureForWebDesktop());case 4:if(!pr(e.services.environment)){t.next=6;break}return t.abrupt("return",e.migrateStorageStructureForMobile());case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(a.StorageDecrypted_09,Ao(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateArbitraryRawStorageToManagedStorageAllPlatforms();case 2:return t.next=4,e.migrateSessionStorage();case 4:return t.next=6,e.deleteLegacyStorageValues();case 6:case"end":return t.stop()}}),t)})))),this.registerStageHandler(a.LoadingDatabase_11,Ao(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.createDefaultItemsKeyForAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateStorageStructureForWebDesktop",value:(k=Ao(i.a.mark((function e(){var t,n,r,a,o,s,c,l,f,p,y,h,d,v,m,b,g,w,k;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.services.deviceInterface,Ro(t={},qt.Wrapped,{}),Ro(t,qt.Unwrapped,{}),Ro(t,qt.Nonwrapped,{}),r=t,e.next=4,n.getJsonParsedStorageValue(No.AllAccountKeyParamsKey);case 4:return(a=e.sent)&&(r.nonwrapped[Vt.RootKeyParams]=a),e.next=8,n.getJsonParsedStorageValue(No.WebEncryptedStorageKey);case 8:if(!(o=e.sent)){e.next=36;break}return s=Object(j.e)(o),e.next=13,this.webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage(s);case 13:if(c=e.sent,l=c.key,f=c.decryptedStoragePayload,p=c.keyParams,r.nonwrapped[Vt.RootKeyWrapperKeyParams]=p.getPortableValue(),y=Object(u.a)(f.contentObject.storage),h=Object(u.v)(y),r.nonwrapped[Vt.RootKeyParams]=h[No.AllAccountKeyParamsKey],d=l,Object(u.p)(h.mk)){e.next=31;break}return e.next=26,this.webDesktopHelperExtractAndWrapAccountKeysFromValueStore(l,h);case 26:v=e.sent,m=v.accountKey,b=v.wrappedKey,d=m,r.nonwrapped[Vt.WrappedRootKey]=b;case 31:return e.next=33,this.webDesktopHelperEncryptStorage(d,f,h);case 33:r.wrapped=e.sent,e.next=55;break;case 36:return e.next=38,this.services.deviceInterface.getRawStorageValue("ak");case 38:return g=e.sent,w=Object(u.p)(g)?xt.a.V002:xt.a.V003,e.t0=ko,e.next=43,this.services.deviceInterface.getRawStorageValue("mk");case 43:return e.t1=e.sent,e.next=46,this.services.deviceInterface.getRawStorageValue("pw");case 46:return e.t2=e.sent,e.t3=g,e.t4=w,e.t5={masterKey:e.t1,serverPassword:e.t2,dataAuthenticationKey:e.t3,version:e.t4},e.next=52,e.t0.Create.call(e.t0,e.t5);case 52:return k=e.sent,e.next=55,this.services.deviceInterface.setKeychainValue(k.getPersistableValue());case 55:return e.next=57,this.allPlatformHelperSetStorageStructure(r);case 57:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"allPlatformHelperSetStorageStructure",value:(w=Ao(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=un.defaultValuesObject(t.wrapped,t.unwrapped,t.nonwrapped))[qt.Unwrapped]=void 0,e.next=4,this.services.deviceInterface.setRawStorageValue(Wt(this.services.namespace,Lt.StorageObject),JSON.stringify(n));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage",value:(b=Ao(i.a.mark((function e(t){var n,r,a,o,s,c,u,l,f,h;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getJsonParsedStorageValue(No.WebPasscodeParamsKey);case 2:n=e.sent,r=this.services.protocolService.createKeyParams(n),o=!0,c=new g([p.LocalPasscode],y.Migration);case 6:if(!o){e.next=23;break}return e.next=9,this.services.challengeService.promptForChallengeResponseWithCustomValidation(c);case 9:return u=e.sent,l=Co(u,1),f=l[0],h=f.value,e.next=15,this.services.protocolService.computeRootKey(h,r);case 15:return s=e.sent,e.next=18,this.services.protocolService.payloadByDecryptingPayload(t,s);case 18:a=e.sent,o=a.errorDecrypting,this.services.challengeService.setValidationStatusForChallenge(c,f,!a.errorDecrypting),e.next=6;break;case 23:return e.abrupt("return",{decryptedStoragePayload:a,key:s,keyParams:r});case 24:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"webDesktopHelperExtractAndWrapAccountKeysFromValueStore",value:(m=Ao(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.ak?xt.a.V003:xt.a.V002,e.next=3,ko.Create({masterKey:n.mk,serverPassword:n.pw,dataAuthenticationKey:n.ak,version:a});case 3:if(o=e.sent,delete n.mk,delete n.pw,delete n.ak,s=Object(j.e)(o),!t){e.next=12;break}return e.next=11,this.services.protocolService.payloadByEncryptingPayload(s,Jt.a.LocalStorageEncrypted,t);case 11:c=e.sent;case 12:return e.abrupt("return",{accountKey:o,wrappedKey:null===(r=c)||void 0===r?void 0:r.ejected()});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})},{key:"webDesktopHelperEncryptStorage",value:(v=Ao(i.a.mark((function e(t,n,r){var a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.protocolService.payloadByEncryptingPayload(Object(j.b)(n,{content_type:P.a.EncryptedStorage,content:r}),Jt.a.LocalStoragePreferEncrypted,t);case 2:return a=e.sent,e.abrupt("return",a.ejected());case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return v.apply(this,arguments)})},{key:"migrateStorageStructureForMobile",value:(d=Ao(i.a.mark((function e(){var t,n,r,a,o,c,l,f,d,v,m,b,w,k,S,x,O,D,C,I,_,R,E=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getJsonParsedStorageValue(No.MobileWrappedRootKeyKey);case 2:return r=e.sent,e.next=5,this.services.deviceInterface.getJsonParsedStorageValue(No.AllAccountKeyParamsKey);case 5:return a=e.sent,e.next=8,this.services.deviceInterface.getJsonParsedStorageValue(No.MobilePasscodeParamsKey);case 8:return o=e.sent,Ro(n={},qt.Nonwrapped,(Ro(t={},Vt.WrappedRootKey,r),Ro(t,Vt.RootKeyWrapperKeyParams,o),Ro(t,Vt.RootKeyParams,a),t)),Ro(n,qt.Unwrapped,{}),Ro(n,qt.Wrapped,{}),c=n,e.next=12,this.services.deviceInterface.getKeychainValue();case 12:if(l=e.sent,!o){e.next=59;break}if(f=this.services.protocolService.createKeyParams(o),d=function(){var e=Ao(i.a.mark((function e(){var t,n,r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=l.offline.pw,r=new g([p.LocalPasscode],y.Migration);case 2:if(n&&n.serverPassword===t){e.next=15;break}return e.next=5,E.services.challengeService.promptForChallengeResponseWithCustomValidation(r);case 5:return a=e.sent,o=Co(a,1),s=o[0],c=s.value,e.next=11,E.services.protocolService.computeRootKey(c,f);case 11:n=e.sent,E.services.challengeService.setValidationStatusForChallenge(r,s,n.serverPassword===t),e.next=2;break;case 15:return e.abrupt("return",n);case 16:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),v=l.offline.timing,c.unwrapped[Vt.MobilePasscodeTiming]=v,m=l.biometrics_prefs,c.unwrapped[Vt.BiometricsState]=m.enabled,c.unwrapped[Vt.MobileBiometricsTiming]=m.timing,!r){e.next=39;break}return e.next=24,d();case 24:return b=e.sent,e.next=27,this.services.protocolService.payloadByDecryptingPayload(Object(j.e)(r),b);case 27:return w=e.sent,k=w.contentObject.accountKeys,S=Object(u.p)(k.ak)?xt.a.V002:xt.a.V003,x=Object(j.b)(w,{content:{masterKey:k.mk,serverPassword:k.pw,dataAuthenticationKey:k.ak,version:k.version||S,accountKeys:null}}),e.next=33,this.services.protocolService.payloadByEncryptingPayload(x,Jt.a.LocalStoragePreferEncrypted,b);case 33:return O=e.sent,c.nonwrapped[Vt.WrappedRootKey]=O.ejected(),e.next=37,this.services.deviceInterface.clearKeychainValue();case 37:e.next=57;break;case 39:if(r){e.next=57;break}return e.next=42,d();case 42:return D=e.sent,e.t0=j.e,e.next=46,h.GenerateUuid();case 46:return e.t1=e.sent,e.t2=Object(s.a)(c.unwrapped),e.t3=P.a.EncryptedStorage,e.t4={uuid:e.t1,content:e.t2,content_type:e.t3},C=(0,e.t0)(e.t4),e.next=53,this.services.protocolService.payloadByEncryptingPayload(C,Jt.a.LocalStoragePreferEncrypted,D);case 53:return I=e.sent,c.wrapped=I.ejected(),e.next=57,this.services.deviceInterface.clearKeychainValue();case 57:e.next=67;break;case 59:if(!l||!l.mk){e.next=67;break}return _=Object(u.p)(l.ak)?xt.a.V002:xt.a.V003,e.next=64,ko.Create({masterKey:l.mk,serverPassword:l.pw,dataAuthenticationKey:l.ak,version:l.version||_});case 64:return R=e.sent,e.next=67,this.services.deviceInterface.setKeychainValue(R.getPersistableValue());case 67:return e.next=69,this.allPlatformHelperSetStorageStructure(c);case 69:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"migrateArbitraryRawStorageToManagedStorageAllPlatforms",value:(f=Ao(i.a.mark((function e(){var t,n,r,a,o,s,c,l,f,p,y;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getAllRawStorageKeyValues();case 2:t=e.sent,n=Object(u.x)(No),r=function(e){try{return JSON.parse(e)}catch(t){return e}},a=this.services.namespace,o=Do(t),e.prev=7,o.s();case 9:if((s=o.n()).done){e.next=22;break}if(c=s.value,l=c.key,f=c.value,p=a&&a.length>0&&l.startsWith(a),!n.includes(l)&&!p){e.next=16;break}return e.abrupt("continue",20);case 16:if(Object(u.p)(f)){e.next=20;break}return y=r(f),e.next=20,this.services.storageService.setValue(l,y);case 20:e.next=9;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(7),o.e(e.t0);case 27:return e.prev=27,o.f(),e.finish(27);case 30:case"end":return e.stop()}}),e,this,[[7,24,27,30]])}))),function(){return f.apply(this,arguments)})},{key:"deleteLegacyStorageValues",value:(l=Ao(i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=["mk","ak","jwt","ephemeral","cachedThemes"],n=[].concat(jo(Object(u.x)(Vt)),jo(Object(u.x)(No)),t),r=Do(n),e.prev=3,r.s();case 5:if((a=r.n()).done){e.next=11;break}return o=a.value,e.next=9,this.services.deviceInterface.removeRawStorageValue(o);case 9:e.next=5;break;case 11:e.next=16;break;case 13:e.prev=13,e.t0=e.catch(3),r.e(e.t0);case 16:return e.prev=16,r.f(),e.finish(16);case 19:case"end":return e.stop()}}),e,this,[[3,13,16,19]])}))),function(){return l.apply(this,arguments)})},{key:"migrateSessionStorage",value:(c=Ao(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.services.storageService.getValue("jwt");case 3:if(t=e.sent){e.next=6;break}return e.abrupt("return");case 6:return n=new fn(t),e.next=9,this.services.storageService.setValue(Vt.Session,n);case 9:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"createDefaultItemsKeyForAllPlatforms",value:(o=Ao(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.protocolService.getRootKey();case 2:if(!(t=e.sent)){e.next=19;break}return e.next=6,this.services.protocolService.getRootKeyParams();case 6:return n=e.sent,e.t0=j.e,e.next=10,h.GenerateUuid();case 10:return e.t1=e.sent,e.t2=P.a.ItemsKey,e.t3=Object(s.a)({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:n.version}),e.t4=new Date,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:!0,dirtiedDate:e.t4},r=(0,e.t0)(e.t5),a=Ut(r),e.next=19,this.services.itemManager.emitItemFromPayload(a.payloadRepresentation(),D.a.LocalChanged);case 19:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}],r=[{key:"timestamp",value:function(){return new Date("2020-01-15").getTime()}}],n&&To(t.prototype,n),r&&To(t,r),x}(Oo);function Wo(e){return(Wo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Bo(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ho(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Bo(o,r,a,i,s,"next",e)}function s(e){Bo(o,r,a,i,s,"throw",e)}i(void 0)}))}}function zo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function qo(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Jo(e,t){return(Jo=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Go(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Qo(e);if(t){var a=Qo(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return $o(this,n)}}function $o(e,t){return!t||"object"!==Wo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Qo(e){return(Qo=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Yo=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Jo(e,t)}(c,e);var t,n,r,o,s=Go(c);function c(){return zo(this,c),s.apply(this,arguments)}return t=c,n=[{key:"registerStageHandlers",value:function(){var e=this;this.registerStageHandler(a.PreparingForLaunch_0,Ho(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.migrateMigrationTimestampAllPlatforms();case 2:e.markDone();case 3:case"end":return t.stop()}}),t)}))))}},{key:"migrateMigrationTimestampAllPlatforms",value:(o=Ho(i.a.mark((function e(){var t,n,r,a,o,s,c,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=!1,n=0,r=["migrations","ephemeral","user","cachedThemes","syncToken","encryptedStorage"];case 3:if(!(n<r.length)){e.next=14;break}return a=r[n],e.next=7,this.services.deviceInterface.getRawStorageValue(a);case 7:if(!e.sent){e.next=11;break}return t=!0,e.abrupt("break",14);case 11:n++,e.next=3;break;case 14:return o=Wt(this.services.namespace,Lt.LastMigrationTimestamp),e.next=17,this.services.deviceInterface.getRawStorageValue(o);case 17:if(s=e.sent,(c=!Object(u.p)(s))||!t){e.next=25;break}return l=new Date(0).getTime(),e.next=23,this.services.deviceInterface.setRawStorageValue(o,l);case 23:e.next=32;break;case 25:if(c||t){e.next=31;break}return f=(new Date).getTime(),e.next=29,this.services.deviceInterface.setRawStorageValue(o,f);case 29:e.next=32;break;case 31:case 32:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})}],r=[{key:"timestamp",value:function(){return new Date("2020-01-01").getTime()}}],n&&qo(t.prototype,n),r&&qo(t,r),c}(Oo);function Xo(e){return(Xo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Zo(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ei(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ei(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function ei(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ti(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ni(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ti(o,r,a,i,s,"next",e)}function s(e){ti(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ri(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ai(e,t,n){return(ai="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ci(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function oi(e,t){return(oi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ii(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ci(e);if(t){var a=ci(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return si(this,n)}}function si(e,t){return!t||"object"!==Xo(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ci(e){return(ci=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ui=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&oi(e,t)}(b,e);var t,n,o,s,l,f,p,y,h,d,v,m=ii(b);function b(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,b),(t=m.call(this)).services=e,t.handledFullSyncStage=!1,t}return t=b,(n=[{key:"deinit",value:function(){this.services=void 0,this.activeMigrations&&(this.activeMigrations.length=0),ai(ci(b.prototype),"deinit",this).call(this)}},{key:"initialize",value:(v=ni(i.a.mark((function e(){var t,n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.runBaseMigration();case 2:return e.next=4,this.getRequiredMigrations();case 4:this.activeMigrations=e.sent,this.activeMigrations.length>0&&(t=Object(u.w)(this.activeMigrations)).onDone(ni(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.saveLastMigrationTimestamp(t.constructor.timestamp());case 2:case"end":return e.stop()}}),e)}))));case 6:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"handleApplicationStage",value:(d=ni(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,ai(ci(b.prototype),"handleApplicationStage",this).call(this,t);case 2:return e.next=4,this.handleStage(t);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"handleApplicationEvent",value:(h=ni(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==c.a.SignedIn){e.next=5;break}return e.next=3,this.handleStage(a.SignedIn_30);case 3:e.next=10;break;case 5:if(t!==c.a.CompletedFullSync){e.next=10;break}if(this.handledFullSyncStage){e.next=10;break}return this.handledFullSyncStage=!0,e.next=10,this.handleStage(a.FullSyncCompleted_13);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"runBaseMigration",value:(y=ni(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Yo(this.services),e.next=3,t.handleStage(a.PreparingForLaunch_0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"getRequiredMigrations",value:(p=ni(i.a.mark((function e(){var t,n,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastMigrationTimestamp();case 2:t=e.sent,n=[],a=Object.keys(r).map((function(e){return r[e]})).sort((function(e,t){var n=e.timestamp(),r=t.timestamp();return n<r?-1:n>r?1:0})),o=Zo(a);try{for(o.s();!(s=o.n()).done;)(c=s.value).timestamp()>t&&n.push(new c(this.services))}catch(e){o.e(e)}finally{o.f()}return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getTimeStampKey",value:function(){return Wt(this.services.namespace,Lt.LastMigrationTimestamp)}},{key:"getLastMigrationTimestamp",value:(f=ni(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.getRawStorageValue(this.getTimeStampKey());case 2:if(t=e.sent,!Object(u.p)(t)){e.next=5;break}throw"Timestamp should not be null. Be sure to run base migration first.";case 5:return e.abrupt("return",JSON.parse(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"saveLastMigrationTimestamp",value:(l=ni(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.deviceInterface.setRawStorageValue(this.getTimeStampKey(),JSON.stringify(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"handleStage",value:(s=ni(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Zo(this.activeMigrations),e.prev=1,n.s();case 3:if((r=n.n()).done){e.next=9;break}return a=r.value,e.next=7,a.handleStage(t);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.e(e.t0);case 14:return e.prev=14,n.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e){return s.apply(this,arguments)})}])&&ri(t.prototype,n),o&&ri(t,o),b}(Gt.a);function li(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function fi(e){return new vi(e)}var pi,yi,hi,di,vi=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.content=t}var t,n,r;return t=e,(n=[{key:"getPortableValue",value:function(){return Object(xt.b)(this.version,xt.a.V003)>=0?Object(u.y)(this.content,["pw_cost"]):this.content}},{key:"isKeyParamsObject",get:function(){return!0}},{key:"kdfIterations",get:function(){return this.content.pw_cost}},{key:"seed",get:function(){return this.content.pw_nonce}},{key:"identifier",get:function(){return this.content.identifier||this.content.email}},{key:"salt",get:function(){return this.content.pw_salt}},{key:"version",get:function(){return this.content.version}}])&&li(t.prototype,n),r&&li(t,r),e}();function mi(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function bi(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){mi(o,r,a,i,s,"next",e)}function s(e){mi(o,r,a,i,s,"throw",e)}i(void 0)}))}}function gi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function wi(e){return(wi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ki(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Si(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ki(o,r,a,i,s,"next",e)}function s(e){ki(o,r,a,i,s,"throw",e)}i(void 0)}))}}function xi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Oi(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Pi(e,t,n){return(Pi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ii(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ji(e,t){return(ji=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Di(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Ii(e);if(t){var a=Ii(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ci(this,n)}}function Ci(e,t){return!t||"object"!==wi(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ii(e){return(Ii=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=512]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength"}(pi||(pi={})),function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(yi||(yi={})),function(e){e[e.SaltSeedLength=256]="SaltSeedLength",e[e.PbkdfCost=11e4]="PbkdfCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(hi||(hi={})),function(e){e[e.ArgonSaltSeedLength=256]="ArgonSaltSeedLength",e[e.ArgonSaltLength=128]="ArgonSaltLength",e[e.ArgonIterations=5]="ArgonIterations",e[e.ArgonMemLimit=67108864]="ArgonMemLimit",e[e.ArgonOutputKeyBytes=64]="ArgonOutputKeyBytes",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionNonceLength=192]="EncryptionNonceLength"}(di||(di={}));var _i="00000000000000000000000000000000",Ri=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ji(e,t)}(h,e);var t,n,r,a,o,s,c,u,l,f,p,y=Di(h);function h(){return xi(this,h),y.apply(this,arguments)}return t=h,(n=[{key:"getEncryptionDisplayName",value:function(){return"AES-256"}},{key:"generateNewItemsKeyContent",value:(p=Si(i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=pi.EncryptionKeyLength,e.next=3,this.crypto.generateRandomKey(t);case 3:return n=e.sent,r={itemsKey:n,version:this.version},e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"createRootKey",value:(f=Si(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=pi.PbkdfMinCost,e.next=3,this.crypto.generateRandomKey(pi.SaltSeedLength);case 3:return a=e.sent,e.next=6,this.crypto.unsafeSha1(t+"SN"+a);case 6:return o=e.sent,e.next=9,this.deriveKey(n,o,r);case 9:return s=e.sent,c=fi({email:t,pw_cost:r,pw_nonce:a,pw_salt:o,version:this.version}),e.abrupt("return",{key:s,keyParams:c});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"computeRootKey",value:(l=Si(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deriveKey(t,n.salt,n.kdfIterations);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"decryptString",value:(u=Si(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,_i,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"encryptString",value:(c=Si(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,_i,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=Si(i.a.mark((function e(t,n,r){var a,o,s,c,u,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==ft.a.DecryptedBareObject&&n!==ft.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",Pi(Ii(h.prototype),"generateEncryptedParameters",this).call(this,t,n,r));case 2:if(n===ft.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(n);case 4:if(r){e.next=6;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 6:return e.next=8,this.crypto.generateRandomKey(2*pi.EncryptionKeyLength);case 8:return a=e.sent,e.next=11,this.encryptString(a,r.itemsKey);case 11:return o=e.sent,e.next=14,this.firstHalfOfKey(a);case 14:return s=e.sent,e.next=17,this.secondHalfOfKey(a);case 17:return c=e.sent,e.next=20,this.encryptString(JSON.stringify(t.content),s);case 20:return u=e.sent,l=r.version+u,e.next=24,this.crypto.hmac256(l,c);case 24:return f=e.sent,e.abrupt("return",Object(j.c)({uuid:t.uuid,items_key_id:r instanceof Tt?r.uuid:void 0,content:l,enc_item_key:o,auth_hash:f}));case 26:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(o=Si(i.a.mark((function e(t,n){var r,a,o,s,c,u,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==ft.a.DecryptedBareObject&&r!==ft.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",Pi(Ii(h.prototype),"generateDecryptedParameters",this).call(this,t,n));case 3:if(t.enc_item_key){e.next=6;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",t);case 6:return a=t.enc_item_key,a=this.version+a,o=this.encryptionComponentsFromString(a,n.itemsKey),e.next=11,this.decryptString(o.ciphertext,o.key);case 11:if(s=e.sent){e.next=15;break}return console.error("Error decrypting parameters",t),e.abrupt("return",Object(j.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 15:return e.next=17,this.firstHalfOfKey(s);case 17:return c=e.sent,u=this.encryptionComponentsFromString(t.contentString,c),e.next=21,this.decryptString(u.ciphertext,u.key);case 21:if(l=e.sent){e.next=26;break}return e.abrupt("return",Object(j.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 26:return e.abrupt("return",Object(j.a)(t,{content:JSON.parse(l),items_key_id:void 0,enc_item_key:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===t.errorDecrypting,waitingForKey:!1}));case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"encryptionComponentsFromString",value:function(e,t){var n=e.substring(0,xt.a.VersionLength);return{ciphertext:e.substring(xt.a.VersionLength,e.length),version:n,key:t}}},{key:"deriveKey",value:(a=Si(i.a.mark((function e(t,n,r){var a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.pbkdf2(t,n,r,pi.PbkdfOutputLength);case 2:return a=e.sent,e.next=5,this.splitKey(a,2);case 5:return o=e.sent,e.next=8,ko.Create({serverPassword:o[0],masterKey:o[1],version:this.version});case 8:return s=e.sent,e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"version",get:function(){return xt.a.V001}}])&&Oi(t.prototype,n),r&&Oi(t,r),h}(function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.crypto=t}var t,n,r,a,o,c,u,l;return t=e,(n=[{key:"firstHalfOfKey",value:(l=bi(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(0,t.length/2));case 1:case"end":return e.stop()}}),e)}))),function(e){return l.apply(this,arguments)})},{key:"secondHalfOfKey",value:(u=bi(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.substring(t.length/2,t.length));case 1:case"end":return e.stop()}}),e)}))),function(e){return u.apply(this,arguments)})},{key:"splitKey",value:function(e,t){for(var n=e.length/t,r=[],a=0;a<t;a++){var o=e.slice(n*a,n*(a+1));r.push(o)}return r}},{key:"createItemsKey",value:(c=bi(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateNewItemsKeyContent();case 2:return t=e.sent,e.t0=j.e,e.next=6,h.GenerateUuid();case 6:return e.t1=e.sent,e.t2=P.a.ItemsKey,e.t3=Object(s.a)(t),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},n=(0,e.t0)(e.t4),e.abrupt("return",Ut(n));case 12:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(o=bi(i.a.mark((function e(t,n,r){var a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==ft.a.DecryptedBareObject){e.next=4;break}return e.abrupt("return",Object(j.c)({content:t.content}));case 4:if(n!==ft.a.DecryptedBase64String){e.next=13;break}return a=JSON.stringify(t.content),e.next=8,this.crypto.base64Encode(a);case 8:return o=e.sent,s=xt.a.V000Base64Decrypted+o,e.abrupt("return",Object(j.c)({content:s}));case 13:throw"Must override generateEncryptedParameters to handle format ".concat(n,".");case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(a=bi(i.a.mark((function e(t,n){var r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==ft.a.DecryptedBareObject){e.next=5;break}return e.abrupt("return",t);case 5:if(r!==ft.a.DecryptedBase64String){e.next=20;break}return a=t.contentString.substring(xt.a.VersionLength,t.contentString.length),e.prev=7,e.next=10,this.crypto.base64Decode(a);case 10:s=e.sent,o=JSON.parse(s),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(7),o=t.content;case 17:return e.abrupt("return",Object(j.a)(t,{content:o}));case 20:throw"Must override generateDecryptedParameters to handle format ".concat(r,".");case 21:case"end":return e.stop()}}),e,this,[[7,14]])}))),function(e,t){return a.apply(this,arguments)})}])&&gi(t.prototype,n),r&&gi(t,r),e}());function Ei(e){return(Ei="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ai(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Mi(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Ai(o,r,a,i,s,"next",e)}function s(e){Ai(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Ti(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ki(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Fi(e,t,n){return(Fi="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ui(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Li(e,t){return(Li=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Vi(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Ui(e);if(t){var a=Ui(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ni(this,n)}}function Ni(e,t){return!t||"object"!==Ei(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ui(e){return(Ui=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Wi=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Li(e,t)}(v,e);var t,n,r,a,o,s,c,u,l,f,p,y,h,d=Vi(v);function v(){return Ti(this,v),d.apply(this,arguments)}return t=v,(n=[{key:"generateNewItemsKeyContent",value:(h=Mi(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=yi.EncryptionKeyLength,e.next=3,this.crypto.generateRandomKey(t);case 3:return n=e.sent,e.next=6,this.crypto.generateRandomKey(t);case 6:return r=e.sent,a={itemsKey:n,dataAuthenticationKey:r,version:this.version},e.abrupt("return",a);case 9:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"createRootKey",value:(y=Mi(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=yi.PbkdfMinCost,e.next=3,this.crypto.generateRandomKey(yi.SaltSeedLength);case 3:return a=e.sent,e.next=6,this.crypto.unsafeSha1(t+":"+a);case 6:return o=e.sent,e.next=9,this.deriveKey(n,o,r);case 9:return s=e.sent,c=fi({email:t,pw_cost:r,pw_nonce:a,pw_salt:o,version:this.version}),e.abrupt("return",{key:s,keyParams:c});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"computeRootKey",value:(p=Mi(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deriveKey(t,n.salt,n.kdfIterations);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"decryptString002",value:(f=Mi(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcDecrypt(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"encryptString002",value:(l=Mi(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.aes256CbcEncrypt(t,r,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"encryptTextParams",value:(u=Mi(i.a.mark((function e(t,n,r,a,o){var s,c,u,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(yi.EncryptionIvLength);case 2:return s=e.sent,e.next=5,this.encryptString002(t,n,s);case 5:return c=e.sent,u=[o,a,s,c].join(":"),e.next=9,this.crypto.hmac256(u,r);case 9:return l=e.sent,f=[o,l,a,s,c].join(":"),e.abrupt("return",f);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return u.apply(this,arguments)})},{key:"decryptTextParams",value:(c=Mi(i.a.mark((function e(t,n,r,a,o,s){var c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw"Attempting to decryptTextParams with null encryptionKey";case 2:return e.next=4,this.crypto.hmac256(t,s);case 4:if(c=e.sent,!1!==this.crypto.timingSafeEqual(o,c)){e.next=8;break}return console.error("Auth hash does not match, returning null."),e.abrupt("return",null);case 8:return e.abrupt("return",this.decryptString002(n,r,a));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a,o){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=Mi(i.a.mark((function e(t,n,r){var a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==ft.a.DecryptedBareObject&&n!==ft.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",Fi(Ui(v.prototype),"generateEncryptedParameters",this).call(this,t,n,r));case 2:if(n===ft.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(n);case 4:if(r&&r.itemsKey){e.next=6;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 6:return e.next=8,this.crypto.generateRandomKey(2*yi.EncryptionKeyLength);case 8:return a=e.sent,e.next=11,this.encryptTextParams(a,r.itemsKey,r.dataAuthenticationKey,t.uuid,r.version);case 11:return o=e.sent,e.next=14,this.firstHalfOfKey(a);case 14:return s=e.sent,e.next=17,this.secondHalfOfKey(a);case 17:return c=e.sent,e.next=20,this.encryptTextParams(JSON.stringify(t.content),s,c,t.uuid,r.version);case 20:return u=e.sent,e.abrupt("return",Object(j.c)({uuid:t.uuid,items_key_id:r instanceof Tt?r.uuid:void 0,content:u,enc_item_key:o}));case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(o=Mi(i.a.mark((function e(t,n){var r,a,o,s,c,u,l,f,p;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==ft.a.DecryptedBareObject&&r!==ft.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",Fi(Ui(v.prototype),"generateDecryptedParameters",this).call(this,t,n));case 3:if(t.enc_item_key){e.next=6;break}return console.error("Missing item encryption key, skipping decryption."),e.abrupt("return",t);case 6:if(n&&n.itemsKey){e.next=8;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 8:return a=t.enc_item_key,o=this.encryptionComponentsFromString002(a,n.itemsKey,n.dataAuthenticationKey),e.next=12,this.decryptTextParams(o.ciphertextToAuth,o.contentCiphertext,o.encryptionKey,o.iv,o.authHash,o.authKey);case 12:if(s=e.sent){e.next=16;break}return console.error("Error decrypting item_key parameters",t),e.abrupt("return",Object(j.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 16:return e.next=18,this.firstHalfOfKey(s);case 18:return c=e.sent,e.next=21,this.secondHalfOfKey(s);case 21:return u=e.sent,l=this.encryptionComponentsFromString002(t.contentString,c,u),e.next=25,this.decryptTextParams(l.ciphertextToAuth,l.contentCiphertext,l.encryptionKey,l.iv,l.authHash,l.authKey);case 25:if(f=e.sent){e.next=30;break}return e.abrupt("return",Object(j.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 30:return e.prev=30,e.t0=JSON,e.next=34,this.crypto.base64Decode(l.authParams);case 34:e.t1=e.sent,p=e.t0.parse.call(e.t0,e.t1),e.next=40;break;case 38:e.prev=38,e.t2=e.catch(30);case 40:return e.abrupt("return",Object(j.a)(t,{content:JSON.parse(f),items_key_id:void 0,enc_item_key:void 0,auth_params:p,errorDecrypting:!1,errorDecryptingValueChanged:!0===t.errorDecrypting,waitingForKey:!1}));case 41:case"end":return e.stop()}}),e,this,[[30,38]])}))),function(e,t){return o.apply(this,arguments)})},{key:"deriveKey",value:(a=Mi(i.a.mark((function e(t,n,r){var a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.pbkdf2(t,n,r,yi.PbkdfOutputLength);case 2:return a=e.sent,e.next=5,this.splitKey(a,3);case 5:return o=e.sent,e.next=8,ko.Create({serverPassword:o[0],masterKey:o[1],dataAuthenticationKey:o[2],version:this.version});case 8:return s=e.sent,e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"encryptionComponentsFromString002",value:function(e,t,n){var r=e.split(":");return{encryptionVersion:r[0],authHash:r[1],uuid:r[2],iv:r[3],contentCiphertext:r[4],authParams:r[5],ciphertextToAuth:[r[0],r[2],r[3],r[4]].join(":"),encryptionKey:t,authKey:n}}},{key:"version",get:function(){return xt.a.V002}}])&&Ki(t.prototype,n),r&&Ki(t,r),v}(Ri);function Bi(e){return(Bi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Hi(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function zi(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Hi(o,r,a,i,s,"next",e)}function s(e){Hi(o,r,a,i,s,"throw",e)}i(void 0)}))}}function qi(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ji(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Gi(e,t){return(Gi=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function $i(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Yi(e);if(t){var a=Yi(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Qi(this,n)}}function Qi(e,t){return!t||"object"!==Bi(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Yi(e){return(Yi=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Xi=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Gi(e,t)}(u,e);var t,n,r,a,o,s,c=$i(u);function u(){return qi(this,u),c.apply(this,arguments)}return t=u,(n=[{key:"computeRootKey",value:(s=zi(i.a.mark((function e(t,n){var r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=hi.PbkdfCost,a=this.version,e.next=4,this.generateSalt(n.identifier,a,r,n.seed);case 4:return o=e.sent,e.next=7,this.deriveKey(t,o,r);case 7:return s=e.sent,e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"createRootKey",value:(o=zi(i.a.mark((function e(t,n){var r,a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.version,a=hi.PbkdfCost,e.next=4,this.crypto.generateRandomKey(hi.SaltSeedLength);case 4:return o=e.sent,e.next=7,this.generateSalt(t,r,a,o);case 7:return s=e.sent,e.next=10,this.deriveKey(n,s,a);case 10:return c=e.sent,u=fi({identifier:t,pw_cost:a,pw_nonce:o,version:r}),e.abrupt("return",{key:c,keyParams:u});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"generateSalt",value:(a=zi(i.a.mark((function e(t,n,r,a){var o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,"SF",n,r,a].join(":"));case 2:return o=e.sent,e.abrupt("return",o);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return a.apply(this,arguments)})},{key:"version",get:function(){return xt.a.V003}}])&&Ji(t.prototype,n),r&&Ji(t,r),u}(Wi);function Zi(e){return(Zi="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function es(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ts(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){es(o,r,a,i,s,"next",e)}function s(e){es(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ns(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function rs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function as(e,t,n){return(as="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=cs(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function os(e,t){return(os=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function is(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=cs(e);if(t){var a=cs(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ss(this,n)}}function ss(e,t){return!t||"object"!==Zi(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function cs(e){return(cs=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var us,ls=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&os(e,t)}(m,e);var t,n,r,a,o,s,c,l,f,p,y,h,d,v=is(m);function m(){return ns(this,m),v.apply(this,arguments)}return t=m,(n=[{key:"getEncryptionDisplayName",value:function(){return"XChaCha20"}},{key:"generateNewItemsKeyContent",value:(d=ts(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(di.EncryptionKeyLength);case 2:return t=e.sent,n={itemsKey:t,version:this.version},e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"generateSalt004",value:(h=ts(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.sha256([t,n].join(":"));case 2:return r=e.sent,e.abrupt("return",Object(u.I)(r,di.ArgonSaltLength));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)})},{key:"computeRootKey",value:(y=ts(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateSalt004(n.identifier,n.seed);case 2:return r=e.sent,e.next=5,this.deriveKey(t,r,di.ArgonIterations);case 5:return a=e.sent,e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)})},{key:"createRootKey",value:(p=ts(i.a.mark((function e(t,n){var r,a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.version,a=di.ArgonIterations,e.next=4,this.crypto.generateRandomKey(di.ArgonSaltSeedLength);case 4:return o=e.sent,e.next=7,this.generateSalt004(t,o);case 7:return s=e.sent,e.next=10,this.deriveKey(n,s,a);case 10:return c=e.sent,u=fi({identifier:t,pw_cost:a,pw_nonce:o,version:r}),e.abrupt("return",{key:c,keyParams:u});case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"encryptString004",value:(f=ts(i.a.mark((function e(t,n,r,a){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw"encryptString null nonce";case 2:if(n){e.next=4;break}throw"encryptString null rawKey";case 4:return e.abrupt("return",this.crypto.xchacha20Encrypt(t,r,n,JSON.stringify(a)));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return f.apply(this,arguments)})},{key:"decryptString004",value:(l=ts(i.a.mark((function e(t,n,r,a){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.crypto.xchacha20Decrypt(t,r,n,JSON.stringify(a)));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return l.apply(this,arguments)})},{key:"generateEncryptedProtocolString",value:(c=ts(i.a.mark((function e(t,n,r){var a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.generateRandomKey(di.EncryptionNonceLength);case 2:return a=e.sent,o=this.version,e.next=6,this.encryptString004(t,n,a,{u:r,v:o});case 6:return s=e.sent,c=[o,a,s].join(":"),e.abrupt("return",c);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"generateEncryptedParameters",value:(s=ts(i.a.mark((function e(t,n,r){var a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==ft.a.DecryptedBareObject&&n!==ft.a.DecryptedBase64String){e.next=2;break}return e.abrupt("return",as(cs(m.prototype),"generateEncryptedParameters",this).call(this,t,n,r));case 2:if(n===ft.a.EncryptedString){e.next=4;break}throw"Unsupport format for generateEncryptedParameters ".concat(n);case 4:if(t.uuid){e.next=6;break}throw"payload.uuid cannot be null";case 6:if(r&&r.itemsKey){e.next=8;break}throw"Attempting to generateEncryptedParameters with no itemsKey.";case 8:return e.next=10,this.crypto.generateRandomKey(di.EncryptionKeyLength);case 10:return a=e.sent,o=JSON.stringify(t.content),e.next=14,this.generateEncryptedProtocolString(o,a,t.uuid);case 14:return s=e.sent,e.next=17,this.generateEncryptedProtocolString(a,r.itemsKey,t.uuid);case 17:return c=e.sent,e.abrupt("return",Object(j.c)({uuid:t.uuid,items_key_id:r instanceof Tt?r.uuid:void 0,content:s,enc_item_key:c}));case 19:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"generateDecryptedParameters",value:(o=ts(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.format)!==ft.a.DecryptedBareObject&&r!==ft.a.DecryptedBase64String){e.next=3;break}return e.abrupt("return",as(cs(m.prototype),"generateDecryptedParameters",this).call(this,t,n));case 3:if(t.uuid){e.next=5;break}throw"encryptedParameters.uuid cannot be null";case 5:if(n&&n.itemsKey){e.next=7;break}throw"Attempting to generateDecryptedParameters with no itemsKey.";case 7:return a=this.deconstructEncryptedPayloadString(t.enc_item_key),e.next=10,this.decryptString004(a.ciphertext,n.itemsKey,a.nonce,{u:t.uuid,v:a.version});case 10:if(o=e.sent){e.next=14;break}return console.error("Error decrypting itemKey parameters",t),e.abrupt("return",Object(j.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 14:return s=this.deconstructEncryptedPayloadString(t.contentString),e.next=17,this.decryptString004(s.ciphertext,o,s.nonce,{u:t.uuid,v:s.version});case 17:if(c=e.sent){e.next=22;break}return e.abrupt("return",Object(j.a)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 22:return e.abrupt("return",Object(j.a)(t,{content:JSON.parse(c),items_key_id:void 0,enc_item_key:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===t.errorDecrypting,waitingForKey:!1}));case 23:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"deconstructEncryptedPayloadString",value:function(e){var t=e.split(":");return{version:t[0],nonce:t[1],ciphertext:t[2]}}},{key:"deriveKey",value:(a=ts(i.a.mark((function e(t,n,r){var a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.crypto.argon2(t,n,r,di.ArgonMemLimit,di.ArgonOutputKeyBytes);case 2:return a=e.sent,o=this.splitKey(a,2),s=o[0],c=o[1],e.abrupt("return",ko.Create({masterKey:s,serverPassword:c,version:this.version}));case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return a.apply(this,arguments)})},{key:"version",get:function(){return xt.a.V004}}])&&rs(t.prototype,n),r&&rs(t,r),m}(Xi);function fs(e){return(fs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ps(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||hs(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ys(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=hs(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function hs(e,t){if(e){if("string"==typeof e)return ds(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ds(e,t):void 0}}function ds(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function vs(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ms(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function bs(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ms(o,r,a,i,s,"next",e)}function s(e){ms(o,r,a,i,s,"throw",e)}i(void 0)}))}}function gs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ws(e,t,n){return(ws="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ps(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function ks(e,t){return(ks=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ss(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Ps(e);if(t){var a=Ps(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return xs(this,n)}}function xs(e,t){return!t||"object"!==fs(t)&&"function"!=typeof t?Os(e):t}function Os(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ps(e){return(Ps=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e[e.RootKeyNone=0]="RootKeyNone",e[e.RootKeyOnly=1]="RootKeyOnly",e[e.RootKeyPlusWrapper=2]="RootKeyPlusWrapper",e[e.WrapperOnly=3]="WrapperOnly"}(us||(us={}));var js=xt.a.V003,Ds=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ks(e,t)}(re,e);var t,n,r,a,o,l,f,p,y,d,v,m,b,g,w,k,S,x,O,C,I,_,R,E,A,M,T,K,F,L,V,N,U,W,B,H,z,q,J,G,$,Q,Y,X,Z,ee,te,ne=Ss(re);function re(e,t,n,r,a){var o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,re),(o=ne.call(this)).operators={},o.keyMode=us.RootKeyNone,o.keyObservers=[],o.itemManager=e,o.modelManager=t,o.deviceInterface=n,o.storageService=r,o.crypto=a,Object(u.r)()?h.SetGenerators(o.crypto.generateUUID,void 0):h.SetGenerators(o.crypto.generateUUID,o.crypto.generateUUIDSync),Object.defineProperty(Os(o),"rootKey",{enumerable:!1,writable:!0}),o.removeItemsObserver=o.itemManager.addObserver([P.a.ItemsKey],(function(e,t){t.length>0&&o.decryptErroredItems()})),o}return t=re,(n=[{key:"deinit",value:function(){this.itemManager=void 0,this.modelManager=void 0,this.deviceInterface=void 0,this.storageService=void 0,this.crypto.deinit(),this.crypto=void 0,this.operators={},this.keyObservers.length=0,this.removeItemsObserver(),this.removeItemsObserver=null,this.rootKey=void 0,ws(Ps(re.prototype),"deinit",this).call(this)}},{key:"initialize",value:(te=bs(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKey();case 2:return t=e.sent,e.next=5,this.getAccountKeyParams();case 5:return n=e.sent,e.next=8,this.hasRootKeyWrapper();case 8:if(r=e.sent,a=!Object(u.p)(t)||!Object(u.p)(n),!r||!a){e.next=14;break}this.keyMode=us.RootKeyPlusWrapper,e.next=27;break;case 14:if(!r||a){e.next=18;break}this.keyMode=us.WrapperOnly,e.next=27;break;case 18:if(r||!a){e.next=22;break}this.keyMode=us.RootKeyOnly,e.next=27;break;case 22:if(r||a){e.next=26;break}this.keyMode=us.RootKeyNone,e.next=27;break;case 26:throw"Invalid key mode condition";case 27:if(this.keyMode!==us.RootKeyOnly){e.next=33;break}return e.next=30,this.getRootKeyFromKeychain();case 30:return this.rootKey=e.sent,e.next=33,this.notifyObserversOfKeyChange();case 33:case"end":return e.stop()}}),e,this)}))),function(){return te.apply(this,arguments)})},{key:"getDefaultOperatorEncryptionDisplayName",value:function(){return this.defaultOperator().getEncryptionDisplayName()}},{key:"getLatestVersion",value:function(){return xt.a.V004}},{key:"hasAccount",value:function(){switch(this.keyMode){case us.RootKeyNone:case us.WrapperOnly:return!1;case us.RootKeyOnly:case us.RootKeyPlusWrapper:return!0;default:throw Error("Unhandled keyMode value '".concat(this.keyMode,"'."))}}},{key:"getUserVersion",value:(ee=bs(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getAccountKeyParams();case 2:return t=e.sent,e.abrupt("return",t&&t.version);case 4:case"end":return e.stop()}}),e,this)}))),function(){return ee.apply(this,arguments)})},{key:"upgradeAvailable",value:(Z=bs(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.accountUpgradeAvailable();case 2:return t=e.sent,e.next=5,this.passcodeUpgradeAvailable();case 5:return n=e.sent,e.abrupt("return",t||n);case 7:case"end":return e.stop()}}),e,this)}))),function(){return Z.apply(this,arguments)})},{key:"accountUpgradeAvailable",value:(X=bs(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getUserVersion();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",t!==this.getLatestVersion());case 6:case"end":return e.stop()}}),e,this)}))),function(){return X.apply(this,arguments)})},{key:"passcodeUpgradeAvailable",value:(Y=bs(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",t.version!==this.getLatestVersion());case 6:case"end":return e.stop()}}),e,this)}))),function(){return Y.apply(this,arguments)})},{key:"platformSupportsKeyDerivation",value:function(e){return Object(xt.b)(e.version,xt.a.V004)>=0||!!Object(u.t)()||Object(u.r)()}},{key:"supportedVersions",value:function(){return[xt.a.V001,xt.a.V002,xt.a.V003,xt.a.V004]}},{key:"isVersionNewerThanLibraryVersion",value:function(e){var t=this.getLatestVersion();return 1===Object(xt.b)(e,t)}},{key:"isProtocolVersionOutdated",value:function(e){var t,n=(vs(t={},xt.a.V001,Date.parse("2018-01-01")),vs(t,xt.a.V002,Date.parse("2020-01-01")),t)[e];return!!n&&(new Date).getTime()>n}},{key:"costMinimumForVersion",value:function(e){if(Object(xt.b)(e,xt.a.V003)>=0)throw"Cost minimums only apply to versions <= 002";if(e===xt.a.V001)return pi.PbkdfMinCost;if(e===xt.a.V002)return yi.PbkdfMinCost;throw"Invalid version for cost minimum: ".concat(e)}},{key:"createOperatorForLatestVersion",value:function(){return this.createOperatorForVersion(this.getLatestVersion())}},{key:"createOperatorForVersion",value:function(e){if(e===xt.a.V001)return new Ri(this.crypto);if(e===xt.a.V002)return new Wi(this.crypto);if(e===xt.a.V003)return new Xi(this.crypto);if(e===xt.a.V004)return new ls(this.crypto);if(e===xt.a.V000Base64Decrypted)return this.createOperatorForLatestVersion();throw"Unable to find operator for version ".concat(e)}},{key:"operatorForVersion",value:function(e){var t=e,n=this.operators[t];return n||(n=this.createOperatorForVersion(e),this.operators[t]=n),n}},{key:"defaultOperator",value:function(){return this.operatorForVersion(this.getLatestVersion())}},{key:"computeRootKey",value:(Q=bs(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.version,a=this.operatorForVersion(r),e.abrupt("return",a.computeRootKey(t,n));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return Q.apply(this,arguments)})},{key:"createRootKey",value:($=bs(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.defaultOperator(),e.abrupt("return",r.createRootKey(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return $.apply(this,arguments)})},{key:"payloadContentFormatForIntent",value:function(e,t){if(t){if(e===Jt.a.Sync||e===Jt.a.FileEncrypted||e===Jt.a.FilePreferEncrypted||e===Jt.a.LocalStorageEncrypted||e===Jt.a.LocalStoragePreferEncrypted)return ft.a.EncryptedString;throw"Unhandled encrypted case in protocolService.payloadContentFormatForIntent."}if(e===Jt.a.LocalStorageDecrypted||e===Jt.a.LocalStoragePreferEncrypted||e===Jt.a.FileDecrypted||e===Jt.a.FilePreferEncrypted)return ft.a.DecryptedBareObject;if(e===Jt.a.SyncDecrypted)return ft.a.DecryptedBase64String;throw"Unhandled decrypted case in protocolService.payloadContentFormatForIntent."}},{key:"payloadByEncryptingPayload",value:(G=bs(i.a.mark((function e(t,n,r){var a,o,s,c,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.errorDecrypting){e.next=2;break}return e.abrupt("return",t);case 2:if(!t.deleted){e.next=4;break}return e.abrupt("return",t);case 4:if(!Object(u.p)(n)){e.next=6;break}throw"Attempting to encrypt payload with null intent";case 6:if(r||Object(Jt.c)(n)){e.next=10;break}return e.next=9,this.keyToUseForEncryptionOfPayload(t,n);case 9:r=e.sent;case 10:if(r||!Object(Jt.b)(n)){e.next=12;break}throw Error("Attempting to generate encrypted payload with no key.");case 12:if(t.format===ft.a.DecryptedBareObject){e.next=14;break}throw"Attempting to encrypt already encrypted payload.";case 14:if(t.content){e.next=16;break}throw"Attempting to encrypt payload with no content.";case 16:if(t.uuid){e.next=18;break}throw"Attempting to encrypt payload with no uuid.";case 18:return a=r?r.version:this.getLatestVersion(),o=this.payloadContentFormatForIntent(n,r),s=this.operatorForVersion(a),e.next=23,s.generateEncryptedParameters(t,o,r);case 23:if(c=e.sent){e.next=26;break}throw"Unable to generate encryption parameters";case 26:return l=Object(j.d)(t,n,c),e.abrupt("return",l);case 28:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return G.apply(this,arguments)})},{key:"payloadsByEncryptingPayloads",value:(J=bs(i.a.mark((function e(t,n){var r,a,o,s,c,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=ys(t),e.prev=2,a.s();case 4:if((o=a.n()).done){e.next=13;break}return s=o.value,c=Object(u.o)(n)?n(s):n,e.next=9,this.payloadByEncryptingPayload(s,c);case 9:l=e.sent,r.push(l);case 11:e.next=4;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),a.e(e.t0);case 18:return e.prev=18,a.f(),e.finish(18);case 21:return e.abrupt("return",r);case 22:case"end":return e.stop()}}),e,this,[[2,15,18,21]])}))),function(e,t){return J.apply(this,arguments)})},{key:"payloadByDecryptingPayload",value:(q=bs(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.content){e.next=2;break}throw"Attempting to decrypt payload that has no content.";case 2:if((r=t.format)!==ft.a.DecryptedBareObject){e.next=5;break}return e.abrupt("return",t);case 5:if(n||r!==ft.a.EncryptedString){e.next=11;break}return e.next=8,this.keyToUseForDecryptionOfPayload(t);case 8:if(n=e.sent){e.next=11;break}return e.abrupt("return",Object(j.e)(t,{waitingForKey:!0,errorDecrypting:!0}));case 11:return a=t.version,o=this.operatorForVersion(a),s=Object(j.c)(t),e.prev=14,e.next=17,o.generateDecryptedParameters(s,n);case 17:return c=e.sent,e.abrupt("return",Object(j.e)(t,c));case 21:return e.prev=21,e.t0=e.catch(14),console.error("Error decrypting payload",t,e.t0),e.abrupt("return",Object(j.e)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting}));case 25:case"end":return e.stop()}}),e,this,[[14,21]])}))),function(e,t){return q.apply(this,arguments)})},{key:"payloadsByDecryptingPayloads",value:(z=bs(i.a.mark((function e(t,n){var r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=[],a=ys(t),e.prev=2,a.s();case 4:if((o=a.n()).done){e.next=22;break}if(s=o.value){e.next=9;break}return r.push(s),e.abrupt("continue",20);case 9:if(!0!==s.deleted||!Object(u.p)(s.content)){e.next=12;break}return r.push(s),e.abrupt("continue",20);case 12:if(Object(u.s)(s.content)){e.next=16;break}return r.push(s),e.abrupt("continue",20);case 16:return e.next=18,this.payloadByDecryptingPayload(s,n);case 18:c=e.sent,r.push(c);case 20:e.next=4;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(2),a.e(e.t0);case 27:return e.prev=27,a.f(),e.finish(27);case 30:return e.abrupt("return",r);case 31:case"end":return e.stop()}}),e,this,[[2,24,27,30]])}))),function(e,t){return z.apply(this,arguments)})},{key:"decryptErroredItems",value:(H=bs(i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(t=this.itemManager.invalidItems).length){e.next=3;break}return e.abrupt("return");case 3:return n=t.map((function(e){return e.payloadRepresentation()})),e.next=6,this.payloadsByDecryptingPayloads(n);case 6:return r=e.sent,e.next=9,this.modelManager.emitPayloads(r,D.a.LocalChanged);case 9:case"end":return e.stop()}}),e,this)}))),function(){return H.apply(this,arguments)})},{key:"payloadsByDecryptingBackupFile",value:(B=bs(i.a.mark((function e(t,n){var r,a,o,s,c,l,f,p,y,h,d,v=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.keyParams||t.auth_params,a=t.items,o=a.map((function(e){return Object(j.f)(e,D.a.FileImport)})),s=[],!r){e.next=35;break}return c=this.createKeyParams(r),e.next=8,this.computeRootKey(n,c);case 8:return l=e.sent,f=o.filter((function(e){return e.content_type===P.a.ItemsKey})),e.next=12,this.payloadsByDecryptingPayloads(f,l);case 12:p=e.sent,Object(u.j)(s,p),y=ys(o),e.prev=15,d=i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((t=h.value).content_type!==P.a.ItemsKey){e.next=3;break}return e.abrupt("return","continue");case 3:return e.prev=3,e.next=6,v.keyToUseForDecryptionOfPayload(t);case 6:return(n=e.sent)||(r=p.find((function(e){return t.items_key_id===e.uuid})),a=t.version,r?n=Ut(r):Object(xt.b)(a,xt.a.V003)<=0&&(n=l)),e.next=10,v.payloadByDecryptingPayload(t,n);case 10:o=e.sent,s.push(o),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(3),s.push(Object(j.e)(t,{errorDecrypting:!0,errorDecryptingValueChanged:!t.errorDecrypting})),console.error("Error decrypting payload",t,e.t0);case 18:case"end":return e.stop()}}),e,null,[[3,14]])})),y.s();case 18:if((h=y.n()).done){e.next=25;break}return e.delegateYield(d(),"t0",20);case 20:if("continue"!==e.t0){e.next=23;break}return e.abrupt("continue",23);case 23:e.next=18;break;case 25:e.next=30;break;case 27:e.prev=27,e.t1=e.catch(15),y.e(e.t1);case 30:return e.prev=30,y.f(),e.finish(30);case 33:e.next=36;break;case 35:s=o;case 36:return e.abrupt("return",s);case 37:case"end":return e.stop()}}),e,this,[[15,27,30,33]])}))),function(e,t){return B.apply(this,arguments)})},{key:"createKeyParams",value:function(e){return e.version||(e.version=xt.a.V002),fi(e)}},{key:"createBackupFile",value:(W=bs(i.a.mark((function e(t){var n,r,a,o,s,c,u,l,f,p,y,h,d=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=d.length>1&&void 0!==d[1]?d[1]:Jt.a.FilePreferEncrypted,r=d.length>2&&void 0!==d[2]&&d[2],a=t||this.itemManager.items,!r||0!==a.length){e.next=5;break}return e.abrupt("return",void 0);case 5:o=[],s=ys(a),e.prev=7,s.s();case 9:if((c=s.n()).done){e.next=22;break}if(!(u=c.value).errorDecrypting){e.next=15;break}o.push(u.payload),e.next=20;break;case 15:return l=Object(j.f)(u.payload,D.a.FileImport),e.next=18,this.payloadByEncryptingPayload(l,n);case 18:f=e.sent,o.push(f);case 20:e.next=9;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(7),s.e(e.t0);case 27:return e.prev=27,s.f(),e.finish(27);case 30:return p={items:o.map((function(e){return e.ejected()}))},e.next=33,this.getRootKeyParams();case 33:return(y=e.sent)&&n!==Jt.a.FileDecrypted&&(p.keyParams=y.getPortableValue()),h=2,e.abrupt("return",JSON.stringify(p,null,h));case 37:case"end":return e.stop()}}),e,this,[[7,24,27,30]])}))),function(e){return W.apply(this,arguments)})},{key:"onKeyStatusChange",value:function(e){var t=this;return this.keyObservers.push(e),function(){Object(u.B)(t.keyObservers,e)}}},{key:"notifyObserversOfKeyChange",value:(U=bs(i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=ys(this.keyObservers),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,r();case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(){return U.apply(this,arguments)})},{key:"getRootKeyFromKeychain",value:(N=bs(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.getKeychainValue();case 2:if(t=e.sent,!Object(u.p)(t)){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.next=7,ko.Create(t);case 7:return n=e.sent,e.abrupt("return",n);case 9:case"end":return e.stop()}}),e,this)}))),function(){return N.apply(this,arguments)})},{key:"saveRootKeyToKeychain",value:(V=bs(i.a.mark((function e(){var t,n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(u.p)(this.rootKey)){e.next=2;break}throw"Attempting to non-existent root key to the keychain.";case 2:if(this.keyMode===us.RootKeyOnly){e.next=4;break}throw"Should not be persisting wrapped key to keychain.";case 4:return t=this.rootKey.getPersistableValue(),e.abrupt("return",this.executeCriticalFunction((function(){return n.deviceInterface.setKeychainValue(t)})));case 6:case"end":return e.stop()}}),e,this)}))),function(){return V.apply(this,arguments)})},{key:"hasRootKeyWrapper",value:(L=bs(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return t=e.sent,e.abrupt("return",!Object(u.p)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return L.apply(this,arguments)})},{key:"hasPasscode",value:function(){return this.keyMode===us.WrapperOnly||this.keyMode===us.RootKeyPlusWrapper}},{key:"rootKeyNeedsUnwrapping",value:(F=bs(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.hasRootKeyWrapper();case 2:if(e.t0=e.sent,!e.t0){e.next=5;break}e.t0=Object(u.p)(this.rootKey);case 5:return e.abrupt("return",e.t0);case 6:case"end":return e.stop()}}),e,this)}))),function(){return F.apply(this,arguments)})},{key:"getRootKeyWrapperKeyParams",value:(K=bs(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Vt.RootKeyWrapperKeyParams,zt.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.abrupt("return",this.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return K.apply(this,arguments)})},{key:"getWrappedRootKey",value:(T=bs(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(Vt.WrappedRootKey,zt.Nonwrapped));case 1:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"getRootKeyParams",value:(M=bs(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==us.WrapperOnly){e.next=4;break}return e.abrupt("return",this.getRootKeyWrapperKeyParams());case 4:if(this.keyMode!==us.RootKeyOnly&&this.keyMode!==us.RootKeyPlusWrapper){e.next=8;break}return e.abrupt("return",this.getAccountKeyParams());case 8:if(this.keyMode!==us.RootKeyNone){e.next=12;break}return e.abrupt("return",void 0);case 12:throw"Unhandled key mode for getRootKeyParams ".concat(this.keyMode);case 13:case"end":return e.stop()}}),e,this)}))),function(){return M.apply(this,arguments)})},{key:"getAccountKeyParams",value:(A=bs(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Vt.RootKeyParams,zt.Nonwrapped);case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",void 0);case 5:return e.abrupt("return",this.createKeyParams(t));case 6:case"end":return e.stop()}}),e,this)}))),function(){return A.apply(this,arguments)})},{key:"validateWrappingKey",value:(E=bs(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getWrappedRootKey();case 2:if(n=e.sent,this.keyMode!==us.WrapperOnly){e.next=7;break}return e.abrupt("return",this.storageService.canDecryptWithKey(t));case 7:if(this.keyMode!==us.RootKeyOnly&&this.keyMode!==us.RootKeyPlusWrapper){e.next=15;break}return r=Object(j.e)(n),e.next=11,this.payloadByDecryptingPayload(r,t);case 11:return a=e.sent,e.abrupt("return",!a.errorDecrypting);case 15:throw"Unhandled case in validateWrappingKey";case 16:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"computeWrappingKey",value:(R=bs(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:return r=e.sent,e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return R.apply(this,arguments)})},{key:"unwrapRootKey",value:(_=bs(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==us.WrapperOnly){e.next=3;break}return this.rootKey=t,e.abrupt("return");case 3:if(this.keyMode===us.RootKeyPlusWrapper){e.next=5;break}throw"Invalid key mode condition for unwrapping.";case 5:return e.next=7,this.getWrappedRootKey();case 7:return n=e.sent,r=Object(j.e)(n),e.next=11,this.payloadByDecryptingPayload(r,t);case 11:if(!(a=e.sent).errorDecrypting){e.next=16;break}throw Error("Unable to decrypt root key with provided wrapping key.");case 16:return e.next=18,ko.Create(a.contentObject,a.uuid);case 18:return this.rootKey=e.sent,e.next=21,this.notifyObserversOfKeyChange();case 21:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"setNewRootKeyWrapper",value:(I=bs(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode!==us.RootKeyNone){e.next=4;break}this.keyMode=us.WrapperOnly,e.next=9;break;case 4:if(this.keyMode!==us.RootKeyOnly){e.next=8;break}this.keyMode=us.RootKeyPlusWrapper,e.next=9;break;case 8:throw Error("Attempting to set wrapper on already wrapped key.");case 9:return e.next=11,this.deviceInterface.clearKeychainValue();case 11:if(this.keyMode!==us.WrapperOnly&&this.keyMode!==us.RootKeyPlusWrapper){e.next=26;break}if(this.keyMode!==us.WrapperOnly){e.next=18;break}return this.rootKey=t,e.next=16,this.reencryptItemsKeys();case 16:e.next=20;break;case 18:return e.next=20,this.wrapAndPersistRootKey(t);case 20:return e.next=22,this.storageService.setValue(Vt.RootKeyWrapperKeyParams,n.getPortableValue(),zt.Nonwrapped);case 22:return e.next=24,this.notifyObserversOfKeyChange();case 24:e.next=27;break;case 26:throw Error("Invalid keyMode on setNewRootKeyWrapper");case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return I.apply(this,arguments)})},{key:"wrapAndPersistRootKey",value:(C=bs(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(j.e)(this.rootKey,{content:this.rootKey.getPersistableValue()}),e.next=3,this.payloadByEncryptingPayload(n,Jt.a.LocalStorageEncrypted,t);case 3:return r=e.sent,e.next=6,this.storageService.setValue(Vt.WrappedRootKey,r.ejected(),zt.Nonwrapped);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"removeRootKeyWrapper",value:(O=bs(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keyMode===us.WrapperOnly||this.keyMode===us.RootKeyPlusWrapper){e.next=2;break}throw"Attempting to remove root key wrapper on unwrapped key.";case 2:return this.keyMode===us.WrapperOnly?(this.keyMode=us.RootKeyNone,this.rootKey=void 0):this.keyMode===us.RootKeyPlusWrapper&&(this.keyMode=us.RootKeyOnly),e.next=5,this.storageService.removeValue(Vt.WrappedRootKey,zt.Nonwrapped);case 5:return e.next=7,this.storageService.removeValue(Vt.RootKeyWrapperKeyParams,zt.Nonwrapped);case 7:if(this.keyMode!==us.RootKeyOnly){e.next=10;break}return e.next=10,this.saveRootKeyToKeychain();case 10:return e.next=12,this.notifyObserversOfKeyChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return O.apply(this,arguments)})},{key:"setNewRootKey",value:(x=bs(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}throw Error("keyParams must be supplied if setting root key.");case 2:if(this.rootKey!==t){e.next=4;break}throw Error("Attempting to set root key as same current value.");case 4:if(this.keyMode!==us.WrapperOnly){e.next=8;break}this.keyMode=us.RootKeyPlusWrapper,e.next=16;break;case 8:if(this.keyMode!==us.RootKeyNone){e.next=12;break}this.keyMode=us.RootKeyOnly,e.next=16;break;case 12:if(this.keyMode!==us.RootKeyOnly&&this.keyMode!==us.RootKeyPlusWrapper){e.next=15;break}e.next=16;break;case 15:throw Error("Unhandled key mode for setNewRootKey ".concat(this.keyMode));case 16:return this.rootKey=t,e.next=19,this.storageService.setValue(Vt.RootKeyParams,n.getPortableValue(),zt.Nonwrapped);case 19:if(this.keyMode!==us.RootKeyOnly){e.next=24;break}return e.next=22,this.saveRootKeyToKeychain();case 22:e.next=29;break;case 24:if(this.keyMode!==us.RootKeyPlusWrapper){e.next=29;break}if(r){e.next=27;break}throw Error("wrappingKey must be supplied");case 27:return e.next=29,this.wrapAndPersistRootKey(r);case 29:return e.next=31,this.notifyObserversOfKeyChange();case 31:return e.next=33,this.reencryptItemsKeys();case 33:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return x.apply(this,arguments)})},{key:"getRootKey",value:(S=bs(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rootKey);case 1:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"clearLocalKeyState",value:(k=bs(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deviceInterface.clearKeychainValue();case 2:return e.next=4,this.storageService.removeValue(Vt.WrappedRootKey,zt.Nonwrapped);case 4:return e.next=6,this.storageService.removeValue(Vt.RootKeyWrapperKeyParams,zt.Nonwrapped);case 6:return e.next=8,this.storageService.removeValue(Vt.RootKeyParams,zt.Nonwrapped);case 8:return this.keyMode=us.RootKeyNone,this.rootKey=void 0,e.next=12,this.notifyObserversOfKeyChange();case 12:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"validateAccountPassword",value:(w=bs(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:if(r=e.sent,!(a=r.compare(this.rootKey))){e.next=11;break}return e.abrupt("return",{valid:a,artifacts:{rootKey:r}});case 11:return e.abrupt("return",{valid:!1});case 12:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"validatePasscode",value:(g=bs(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKeyWrapperKeyParams();case 2:return n=e.sent,e.next=5,this.computeRootKey(t,n);case 5:return r=e.sent,e.next=8,this.validateWrappingKey(r);case 8:if(!(a=e.sent)){e.next=13;break}return e.abrupt("return",{valid:a,artifacts:{wrappingKey:r}});case 13:return e.abrupt("return",{valid:!1});case 14:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"contentTypeUsesRootKeyEncryption",value:function(e){return e===P.a.ItemsKey||e===P.a.EncryptedStorage}},{key:"keyToUseForEncryptionOfPayload",value:(b=bs(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(u.p)(n)){e.next=2;break}throw"Intent must be supplied when looking up key for encryption of item.";case 2:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){e.next=15;break}return e.next=5,this.getRootKey();case 5:if(r=e.sent){e.next=12;break}if(!Object(Jt.b)(n)){e.next=11;break}throw"Root key encryption is required but no root key is available.";case 11:return e.abrupt("return",void 0);case 12:return e.abrupt("return",r);case 15:return e.abrupt("return",this.getDefaultItemsKey());case 16:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)})},{key:"keyToUseForDecryptionOfPayload",value:(m=bs(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.contentTypeUsesRootKeyEncryption(t.content_type)){e.next=2;break}return e.abrupt("return",this.getRootKey());case 2:if(!t.items_key_id){e.next=5;break}return n=this.itemsKeyForPayload(t),e.abrupt("return",n);case 5:if((r=t.version)!==this.getLatestVersion()){e.next=8;break}throw"No associated key found for item encrypted with latest protocol version.";case 8:return e.abrupt("return",this.defaultItemsKeyForItemVersion(r));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"onSyncEvent",value:(v=bs(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==c.b.FullSyncCompleted){e.next=3;break}return e.next=3,this.handleFullSyncCompletion();case 3:if(t!==c.b.DownloadFirstSyncCompleted){e.next=6;break}return e.next=6,this.handleDownloadFirstSyncCompletion();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"handleDownloadFirstSyncCompletion",value:(d=bs(i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.latestItemsKeys(),n=t.filter((function(e){return e.neverSynced})),r=t.find((function(e){return!e.neverSynced&&e.isDefault})),Object(u.p)(r)){e.next=9;break}return e.next=7,this.itemManager.setItemsToBeDeleted(Object(s.b)(n));case 7:e.next=20;break;case 9:return e.next=11,this.getRootKey();case 11:if(!(a=e.sent)){e.next=20;break}if(!((o=n.filter((function(e){return e.version!==a.version}))).length>0)){e.next=17;break}return e.next=17,this.itemManager.setItemsToBeDeleted(Object(s.b)(o));case 17:if(0!==this.latestItemsKeys().length){e.next=20;break}return e.next=20,this.createNewDefaultItemsKey();case 20:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"handleFullSyncCompletion",value:(y=bs(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.getDefaultItemsKey()){e.next=6;break}return e.next=4,this.createNewDefaultItemsKey();case 4:if(this.keyMode!==us.WrapperOnly){e.next=6;break}return e.abrupt("return",this.repersistAllItems());case 6:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"repersistAllItems",value:(p=bs(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.items,n=t.map((function(e){return Object(j.e)(e)})),e.abrupt("return",this.storageService.savePayloads(n));case 3:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"latestItemsKeys",value:function(){return this.itemManager.itemsKeys()}},{key:"itemsKeyForPayload",value:function(e){return this.latestItemsKeys().find((function(t){return t.uuid===e.items_key_id}))}},{key:"getDefaultItemsKey",value:function(){var e=this.latestItemsKeys();return 1===e.length?e[0]:e.find((function(e){return e.isDefault}))}},{key:"reencryptItemsKeys",value:(f=bs(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((t=this.latestItemsKeys()).length>0)){e.next=4;break}return e.next=4,this.itemManager.setItemsDirty(Object(s.b)(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"defaultItemsKeyForItemVersion",value:(l=bs(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.latestItemsKeys().find((function(e){return e.version===t})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"createNewDefaultItemsKey",value:(o=bs(i.a.mark((function e(){var t,n,r,a,o,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRootKey();case 2:if(t=e.sent,n=t?t.version:this.getLatestVersion(),!(Object(xt.b)(n,js)<=0)){e.next=16;break}return e.t0=j.e,e.next=8,h.GenerateUuid();case 8:e.t1=e.sent,e.t2=P.a.ItemsKey,e.t3=Object(s.a)({itemsKey:t.masterKey,dataAuthenticationKey:t.dataAuthenticationKey,version:n}),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},a=(0,e.t0)(e.t4),r=Ut(a),e.next=19;break;case 16:return e.next=18,this.operatorForVersion(n).createItemsKey();case 18:r=e.sent;case 19:if(!(o=this.getDefaultItemsKey())){e.next=23;break}return e.next=23,this.itemManager.changeItemsKey(o.uuid,(function(e){e.isDefault=!1}));case 23:return e.next=25,this.itemManager.insertItem(r);case 25:return c=e.sent,e.next=28,this.itemManager.changeItemsKey(c.uuid,(function(e){e.isDefault=!0}));case 28:return e.abrupt("return",c);case 29:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"changePassword",value:(a=bs(i.a.mark((function e(t,n,r,a){var o,s,c,u,l,f,p,y,h,d,v=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([this.getRootKey(),this.getRootKeyParams()]);case 2:return o=e.sent,s=ps(o,2),c=s[0],u=s[1],l=this.getDefaultItemsKey(),e.next=9,this.computeRootKey(n,u);case 9:if(f=e.sent,c.compare(f)){e.next=12;break}return e.abrupt("return",[Error("Invalid password.")]);case 12:return e.next=14,this.createRootKey(t,r);case 14:return p=e.sent,y=p.key,h=p.keyParams,e.next=19,this.setNewRootKey(y,h,a);case 19:return e.next=21,this.createNewDefaultItemsKey();case 21:return d=e.sent,e.abrupt("return",[null,{currentServerPassword:f.serverPassword,newRootKey:y,newKeyParams:h,rollback:function(){var e=bs(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,v.setNewRootKey(c,u,a);case 2:return e.next=4,Promise.all([v.itemManager.setItemToBeDeleted(d.uuid),v.itemManager.changeItem(l.uuid,(function(e){e.isDefault=!0}))]);case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}()}]);case 23:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return a.apply(this,arguments)})}])&&gs(t.prototype,n),r&&gs(t,r),re}(Gt.a);function Cs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Is=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.defaultContentKeyToDiffOn="text",this.textCharDiffLength=0,this.hasPreviousEntry=!1;var n=t.updated_at;Object(u.s)(n)&&(n=new Date(n)),this.payload=Object(j.b)(t,{updated_at:n})}var t,n,r;return t=e,(n=[{key:"setPreviousEntry",value:function(e){this.hasPreviousEntry=null!=e,this.payload.contentObject[this.defaultContentKeyToDiffOn]&&(this.textCharDiffLength=e?this.payload.contentObject[this.defaultContentKeyToDiffOn].length-e.payload.contentObject[this.defaultContentKeyToDiffOn].length:this.payload.contentObject[this.defaultContentKeyToDiffOn].length)}},{key:"operationVector",value:function(){return void 0!==this.textCharDiffLength?this.hasPreviousEntry&&0!==this.textCharDiffLength?this.textCharDiffLength<0?-1:1:0:1}},{key:"deltaSize",value:function(){return void 0!==this.textCharDiffLength?Math.abs(this.textCharDiffLength):1}},{key:"isSameAsEntry",value:function(e){if(!e)return!1;var t=Ut(this.payload),n=Ut(e.payload);return t.isItemContentEqualWith(n)}}])&&Cs(t.prototype,n),r&&Cs(t,r),e}();function _s(e){return(_s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Rs(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Es(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function As(e,t){return(As=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ms(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Ks(e);if(t){var a=Ks(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ts(this,n)}}function Ts(e,t){return!t||"object"!==_s(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ks(e){return(Ks=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Fs=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&As(e,t)}(o,e);var t,n,r,a=Ms(o);function o(){return Rs(this,o),a.apply(this,arguments)}return t=o,(n=[{key:"previewTitle",value:function(){return this.payload.updated_at.toLocaleString()}},{key:"previewSubTitle",value:function(){return this.hasPreviousEntry?this.textCharDiffLength<0?"".concat(-1*this.textCharDiffLength," characters removed"):this.textCharDiffLength>0?"".concat(this.textCharDiffLength," characters added"):"Title or metadata changed":"".concat(this.textCharDiffLength," characters loaded")}}])&&Es(t.prototype,n),r&&Es(t,r),o}(Is);function Ls(e){var t,n,r,a=(t={},n=P.a.Note,r=Fs,n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t)[e[ua.a.ContentType]];if(!a)throw"Invalid item history class";return new a(e)}function Vs(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Ns(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ns(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Ns(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Us(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ws=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.entries=[],t){var n,r=Vs(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;a.setPreviousEntry(this.getLastEntry()),this.entries.push(a)}}catch(e){r.e(e)}finally{r.f()}}}var t,n,r;return t=e,r=[{key:"FromJson",value:function(t){return new e(t.entries.map((function(e){return Ls(e.payload)})))}}],(n=[{key:"getLastEntry",value:function(){return this.entries[this.entries.length-1]}},{key:"addHistoryEntryForItem",value:function(e){var t=Ls(e),n=this.getLastEntry();if(t.setPreviousEntry(n),!t.isSameAsEntry(n))return this.entries.push(t),t}},{key:"clear",value:function(){this.entries.length=0}},{key:"optimize",value:function(){var e=this,t=[],n=function(e){return e.deltaSize()>15},r=function(r,a,o){if(o)t.push(r);else{var i=t.indexOf(r);-1!==i&&t.splice(i,1)}if(o&&n(r)&&-1===r.operationVector()){var s=e.entries[a-1];s&&t.push(s)}};this.entries.forEach((function(t,a){if(0===a||a===e.entries.length-1)r(t,a,!0);else{var o=n(t);r(t,a,o)}})),this.entries=this.entries.filter((function(e,n){return-1!==t.indexOf(e)}))}}])&&Us(t.prototype,n),r&&Us(t,r),e}();function Bs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Hs=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.itemRevisionThreshold=60,this.content=t,this.content||(this.content={itemUUIDToItemHistoryMapping:{}})}var t,n,r;return t=e,r=[{key:"FromJson",value:function(t){if(t){var n=t.content;return Object.keys(n.itemUUIDToItemHistoryMapping).forEach((function(e){var t=n.itemUUIDToItemHistoryMapping[e];n.itemUUIDToItemHistoryMapping[e]=Ws.FromJson(t)})),new e(n)}return new e}}],(n=[{key:"addEntryForPayload",value:function(e){return this.historyForItem(e.uuid).addHistoryEntryForItem(e)}},{key:"historyForItem",value:function(e){var t=this.content.itemUUIDToItemHistoryMapping[e];return t||(t=new Ws,this.content.itemUUIDToItemHistoryMapping[e]=t),t}},{key:"clearItemHistory",value:function(e){this.historyForItem(e.uuid).clear()}},{key:"clearAllHistory",value:function(){this.content.itemUUIDToItemHistoryMapping={}}},{key:"setItemRevisionThreshold",value:function(e){this.itemRevisionThreshold=e}},{key:"optimizeHistoryForItem",value:function(e){var t=this.historyForItem(e);t.entries.length>this.itemRevisionThreshold&&t.optimize()}}])&&Bs(t.prototype,n),r&&Bs(t,r),e}();function zs(e){return(zs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function qs(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Js(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Js(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Js(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Gs(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function $s(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Gs(o,r,a,i,s,"next",e)}function s(e){Gs(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Qs(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Ys(e,t,n){return(Ys="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=tc(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Xs(e,t){return(Xs=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Zs(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=tc(e);if(t){var a=tc(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ec(this,n)}}function ec(e,t){return!t||"object"!==zs(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function tc(e){return(tc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var nc,rc,ac,oc=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Xs(e,t)}(h,e);var t,n,r,a,o,s,c,l,f,p,y=Zs(h);function h(e,t,n,r){var a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,h),(a=y.call(this)).contentTypes=[],a.persistable=!1,a.autoOptimize=!1,a.itemManager=e,a.storageService=t,a.contentTypes=n,a.timeout=r,a}return t=h,(n=[{key:"deinit",value:function(){this.itemManager=void 0,this.storageService=void 0,this.contentTypes.length=0,this.historySession=void 0,this.timeout=null,this.removeChangeObserver&&(this.removeChangeObserver(),this.removeChangeObserver=null),Ys(tc(h.prototype),"deinit",this).call(this)}},{key:"initializeFromDisk",value:(p=$s(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Vt.SessionHistoryPersistable);case 2:return this.persistable=e.sent,e.next=5,this.storageService.getValue(Vt.SessionHistoryRevisions).then((function(e){return Hs.FromJson(e)}));case 5:return this.historySession=e.sent,e.next=8,this.storageService.getValue(Vt.SessionHistoryOptimize);case 8:t=e.sent,Object(u.p)(t)?this.autoOptimize=!0:this.autoOptimize=t,this.addChangeObserver();case 11:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"addChangeObserver",value:function(){var e=this;this.removeChangeObserver=this.itemManager.addObserver(this.contentTypes,(function(t,n,r,a){var o=Object(u.f)(t,n,r);if(a!==D.a.LocalChanged){var i,s=qs(o);try{for(s.s();!(i=s.n()).done;){var c=i.value;try{c.deleted||c.errorDecrypting||e.addHistoryEntryForItem(c)}catch(e){console.error("Unable to add item history entry:",e)}}}catch(e){s.e(e)}finally{s.f()}}}))}},{key:"isDiskEnabled",value:function(){return this.persistable}},{key:"isAutoOptimizeEnabled",value:function(){return this.autoOptimize}},{key:"saveToDisk",value:(f=$s(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable){e.next=2;break}return e.abrupt("return");case 2:this.storageService.setValue(Vt.SessionHistoryRevisions,this.historySession);case 3:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"setSessionItemRevisionThreshold",value:function(e){this.historySession.setItemRevisionThreshold(e)}},{key:"addHistoryEntryForItem",value:(l=$s(i.a.mark((function e(t){var n,r,a=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=Object(j.f)(t,D.a.SessionHistory),r=this.historySession.addEntryForPayload(n),this.autoOptimize&&this.historySession.optimizeHistoryForItem(t.uuid),r&&this.persistable&&(this.saveTimeout&&(this.timeout.hasOwnProperty("cancel")?this.timeout.cancel(this.saveTimeout):clearTimeout(this.saveTimeout)),this.saveTimeout=this.timeout((function(){a.saveToDisk()}),2e3));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"historyForItem",value:function(e){return this.historySession.historyForItem(e.uuid)}},{key:"clearHistoryForItem",value:(c=$s(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearItemHistory(t),e.abrupt("return",this.saveToDisk());case 2:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"clearAllHistory",value:(s=$s(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.historySession.clearAllHistory(),e.abrupt("return",this.storageService.removeValue(Vt.SessionHistoryRevisions));case 2:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"toggleDiskSaving",value:(o=$s(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.persistable=!this.persistable,!this.persistable){e.next=6;break}this.storageService.setValue(Vt.SessionHistoryPersistable,!0),this.saveToDisk(),e.next=8;break;case 6:return this.storageService.setValue(Vt.SessionHistoryPersistable,!1),e.abrupt("return",this.storageService.removeValue(Vt.SessionHistoryRevisions));case 8:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"toggleAutoOptimize",value:(a=$s(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.autoOptimize=!this.autoOptimize,this.autoOptimize?this.storageService.setValue(Vt.SessionHistoryOptimize,!0):this.storageService.setValue(Vt.SessionHistoryOptimize,!1);case 2:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})}])&&Qs(t.prototype,n),r&&Qs(t,r),h}(Gt.a);function ic(e){return(ic="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function sc(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return cc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return cc(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function cc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function uc(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function lc(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){uc(o,r,a,i,s,"next",e)}function s(e){uc(o,r,a,i,s,"throw",e)}i(void 0)}))}}function fc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function pc(e,t,n){return(pc="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=vc(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function yc(e,t){return(yc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function hc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=vc(e);if(t){var a=vc(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return dc(this,n)}}function dc(e,t){return!t||"object"!==ic(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function vc(e){return(vc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function mc(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.None=0]="None",e[e.FiveMinutes=300]="FiveMinutes",e[e.OneHour=3600]="OneHour",e[e.OneWeek=604800]="OneWeek"}(ac||(ac={}));var bc,gc=(mc(nc={},V.AccountPassword,{label:"Account Password",prompt:"Please enter your account password."}),mc(nc,V.LocalPasscode,{label:"Local Passcode",prompt:"Please enter your local passcode."}),nc),wc=(mc(rc={},L.ManageExtensions,{label:"Manage Extensions"}),mc(rc,L.ManageBackups,{label:"Download/Import Backups"}),mc(rc,L.ViewProtectedNotes,{label:"View Protected Notes"}),mc(rc,L.ManagePrivileges,{label:"Manage Privileges"}),mc(rc,L.ManagePasscode,{label:"Manage Passcode"}),mc(rc,L.DeleteNote,{label:"Delete Notes"}),rc),kc=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&yc(e,t)}(m,e);var t,n,r,a,o,c,u,l,f,p,y,h,d,v=hc(m);function m(e,t,n,r,a,o){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,m),(i=v.call(this)).availableActions=[],i.availableCredentials=[],i.itemManager=e,i.syncService=t,i.singletonManager=n,i.protocolService=r,i.storageService=a,i.sessionManager=o,i.loadDefaults(),i}return t=m,(n=[{key:"deinit",value:function(){this.itemManager=void 0,this.syncService=void 0,this.singletonManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.sessionManager=void 0,pc(vc(m.prototype),"deinit",this).call(this)}},{key:"loadDefaults",value:function(){this.availableActions=Object.keys(L).map((function(e){return L[e]})),this.availableCredentials=[V.AccountPassword,V.LocalPasscode]}},{key:"getAvailableActions",value:function(){return this.availableActions}},{key:"getAvailableCredentials",value:function(){return this.availableCredentials}},{key:"netCredentialsForAction",value:(d=lc(i.a.mark((function e(t){var n,r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getPrivileges();case 2:n=e.sent,r=n.getCredentialsForAction(t),a=[],o=sc(r),e.prev=6,o.s();case 8:if((s=o.n()).done){e.next=24;break}if((c=s.value)!==V.AccountPassword){e.next=17;break}return e.next=13,this.sessionManager.online();case 13:e.sent&&a.push(c),e.next=22;break;case 17:if(c!==V.LocalPasscode){e.next=22;break}return e.next=20,this.protocolService.hasRootKeyWrapper();case 20:e.sent&&a.push(c);case 22:e.next=8;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(6),o.e(e.t0);case 29:return e.prev=29,o.f(),e.finish(29);case 32:return e.abrupt("return",a);case 33:case"end":return e.stop()}}),e,this,[[6,26,29,32]])}))),function(e){return d.apply(this,arguments)})},{key:"getPrivileges",value:(h=lc(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=P.a.Privileges,n=new C.a("content_type","=",t),e.abrupt("return",this.singletonManager.findOrCreateSingleton(n,t,Object(s.a)({})));case 3:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"setSessionLength",value:(y=lc(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t,a=void 0,(a=new Date).setSeconds(a.getSeconds()+r),n=a,e.next=4,this.storageService.setValue(Vt.PrivilegesExpirey,n);case 4:return e.next=6,this.storageService.setValue(Vt.PrivilegesSessionLength,t);case 6:case"end":return e.stop()}var r,a}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"clearSession",value:(p=lc(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setSessionLength(ac.None));case 1:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"getSelectedSessionLength",value:(f=lc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Vt.PrivilegesSessionLength);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",t);case 7:return e.abrupt("return",ac.None);case 8:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"getSessionExpirey",value:(l=lc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Vt.PrivilegesExpirey);case 2:if(!(t=e.sent)){e.next=7;break}return e.abrupt("return",new Date(t));case 7:return e.abrupt("return",new Date);case 8:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"actionHasPrivilegesConfigured",value:(u=lc(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:return e.t0=e.sent.length,e.abrupt("return",e.t0>0);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"actionRequiresPrivilege",value:(c=lc(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSessionExpirey();case 2:if(!(e.sent>new Date)){e.next=5;break}return e.abrupt("return",!1);case 5:return e.next=7,this.netCredentialsForAction(t);case 7:return n=e.sent,e.abrupt("return",n.length>0);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"authenticateAction",value:(o=lc(i.a.mark((function e(t,n){var r,a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.netCredentialsForAction(t);case 2:r=e.sent,a=[],o=[],s=sc(r),e.prev=6,s.s();case 8:if((c=s.n()).done){e.next=16;break}return u=c.value,e.next=12,this.verifyAuthenticationParameters(u,n[u]);case 12:e.sent?a.push(u):o.push(u);case 14:e.next=8;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(6),s.e(e.t0);case 21:return e.prev=21,s.f(),e.finish(21);case 24:return e.abrupt("return",{success:0===o.length,successfulCredentials:a,failedCredentials:o});case 25:case"end":return e.stop()}}),e,this,[[6,18,21,24]])}))),function(e,t){return o.apply(this,arguments)})},{key:"verifyAuthenticationParameters",value:(a=lc(i.a.mark((function e(t,n){var r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==V.AccountPassword){e.next=8;break}return e.next=3,this.protocolService.validateAccountPassword(n);case 3:return r=e.sent,a=r.valid,e.abrupt("return",a);case 8:if(t!==V.LocalPasscode){e.next=14;break}return e.next=11,this.protocolService.validatePasscode(n);case 11:return o=e.sent,s=o.valid,e.abrupt("return",s);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"displayInfoForCredential",value:function(e){return gc[e]}},{key:"displayInfoForAction",value:function(e){return wc[e]}},{key:"getSessionLengthOptions",value:function(){return[{value:ac.None,label:"Don't Remember"},{value:ac.FiveMinutes,label:"5 Minutes"},{value:ac.OneHour,label:"1 Hour"},{value:ac.OneWeek,label:"1 Week"}]}}])&&fc(t.prototype,n),r&&fc(t,r),m}(Gt.a);function Sc(e){return(Sc="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function xc(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Oc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Oc(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Oc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Pc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function jc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Dc(e,t,n){return(Dc="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Rc(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Cc(e,t){return(Cc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ic(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Rc(e);if(t){var a=Rc(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return _c(this,n)}}function _c(e,t){return!t||"object"!==Sc(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Rc(e){return(Rc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}!function(e){e.CreatedAt="created_at",e.UpdatedAt="userModifiedDate",e.Title="title"}(bc||(bc={}));var Ec=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Cc(e,t)}(o,e);var t,n,r,a=Ic(o);function o(){var e;return Pc(this,o),(e=a.apply(this,arguments)).displaySortBy={},e.displayFilter={},e.filteredMap={},e.sortedMap={},e}return t=o,(n=[{key:"set",value:function(e){e=Array.isArray(e)?e:[e],Dc(Rc(o.prototype),"set",this).call(this,e),this.filterSortElements(e)}},{key:"discard",value:function(e){e=Array.isArray(e)?e:[e],Dc(Rc(o.prototype),"discard",this).call(this,e),this.filterSortElements(e)}},{key:"setDisplayOptions",value:function(e,t,n,r){var a=this.displaySortBy[e],o=this.displayFilter[e];if(!a||a.key!==t||a.dir!==n||o||r){this.displaySortBy[e]=t?{key:t,dir:n}:void 0,this.displayFilter[e]=r,this.filteredMap[e]={},this.sortedMap[e]=[];var i=this.all(e);i.length>0&&this.filterSortElements(i)}}},{key:"displayElements",value:function(e){var t=this.sortedMap[e];if(!t)throw Error("Attempting to access display elements for \n        non-configured content type ".concat(e));return t.slice()}},{key:"filterSortElements",value:function(e){if(0!==Object.keys(this.displaySortBy).length){var t,n=new Set,r=xc(e);try{for(r.s();!(t=r.n()).done;){var a=t.value,o=a.content_type,i=this.displaySortBy[o];if(i){var s=this.displayFilter[o],c=this.filteredMap[o],l=this.sortedMap[o],f=!(a.deleted||!this.map[a.uuid])&&(!s||s(a)),p=c[a.uuid];if(f)if(Object(u.p)(p))l.push(a),n.add(o);else{var y=l[p],h=y[i.key],d=a[i.key];l[p]=a;var v=y.pinned!==a.pinned;Object(u.e)(h,d)&&!v||n.add(o)}else Object(u.p)(p)||(delete c[a.uuid],l[p]=void 0,n.add(o))}}}catch(e){r.e(e)}finally{r.f()}var m,b=xc(n.values());try{for(b.s();!(m=b.n()).done;){var g=m.value;this.resortContentType(g)}}catch(e){b.e(e)}finally{b.f()}}}},{key:"resortContentType",value:function(e){var t,n=this.sortedMap[e],r=this.displaySortBy[e],a=this.filteredMap[e],o=[],i=0,s=xc(n.sort((function(e,t){return function e(t,n){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t)return-1;if(!n)return 1;if(!a){if(t.pinned&&n.pinned)return e(t,n,!0);if(t.pinned)return-1;if(n.pinned)return 1}var o=t[r.key]||"",i=n[r.key]||"",s=1;if("asc"===r.dir&&(s*=-1),r.key===bc.Title){if(o=o.toLowerCase(),i=i.toLowerCase(),0===o.length&&0===i.length)return 0;if(0===o.length&&0!==i.length)return 1*s;if(0!==o.length&&0===i.length)return-1*s;s*=-1}return o>i?-1*s:o<i?1*s:0}(e,t)})));try{for(s.s();!(t=s.n()).done;){var c=t.value;c&&(o.push(c),a[c.uuid]=i,i++)}}catch(e){s.e(e)}finally{s.f()}this.sortedMap[e]=o}}])&&jc(t.prototype,n),r&&jc(t,r),o}(Vr);function Ac(e){return(Ac="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Mc(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Tc(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Tc(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Tc(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Kc(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Fc(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Kc(o,r,a,i,s,"next",e)}function s(e){Kc(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Lc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Vc(e,t){return(Vc=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Nc(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Bc(e);if(t){var a=Bc(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Uc(this,n)}}function Uc(e,t){return!t||"object"!==Ac(t)&&"function"!=typeof t?Wc(e):t}function Wc(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Bc(e){return(Bc=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Hc=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Vc(e,t)}(F,e);var t,n,r,a,o,c,l,f,p,y,v,m,b,g,w,k,S,x,O,I,_,R,E,A,M,T,K=Nc(F);function F(e){var t,n,r,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,F),(t=K.call(this)).observers=[],t.modelManager=e,t.createCollection(),t.unsubChangeObserver=t.modelManager.addObserver(P.a.Any,t.onPayloadChange.bind(Wc(t))),t.systemSmartTags=(n=Object(j.e)({uuid:"all-notes",content_type:P.a.SmartTag,content:Object(s.a)({title:"All notes",isSystemTag:!0,isAllTag:!0,predicate:C.a.FromArray(["content_type","=",P.a.Note])})}),r=Object(j.e)({uuid:"archived-notes",content_type:P.a.SmartTag,content:Object(s.a)({title:"Archived",isSystemTag:!0,isArchiveTag:!0,predicate:C.a.FromArray(["archived","=",JSON.stringify(!0)])})}),a=Object(j.e)({uuid:"trashed-notes",content_type:P.a.SmartTag,content:Object(s.a)({title:"Trash",isSystemTag:!0,isTrashTag:!0,predicate:C.a.FromArray(["trashed","=",JSON.stringify(!0)])})}),[Ut(n),Ut(r),Ut(a)]),t}return t=F,(n=[{key:"setDisplayOptions",value:function(e,t,n,r){this.collection.setDisplayOptions(e,t,n,r)}},{key:"getDisplayableItems",value:function(e){return this.collection.displayElements(e)}},{key:"deinit",value:function(){this.unsubChangeObserver(),this.unsubChangeObserver=void 0,this.modelManager=void 0,this.collection=void 0}},{key:"resetState",value:function(){this.createCollection()}},{key:"createCollection",value:function(){this.collection=new Ec,this.collection.setDisplayOptions(P.a.Note,bc.CreatedAt,"dsc"),this.collection.setDisplayOptions(P.a.Tag,bc.Title,"asc"),this.collection.setDisplayOptions(P.a.ItemsKey,bc.CreatedAt,"asc"),this.collection.setDisplayOptions(P.a.Component,bc.CreatedAt,"asc"),this.collection.setDisplayOptions(P.a.SmartTag,bc.Title,"asc")}},{key:"findItem",value:function(e){return this.collection.find(e)}},{key:"findItems",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.collection.findAll(e,t)}},{key:"itemsKeys",value:function(){return this.collection.displayElements(P.a.ItemsKey)}},{key:"addObserver",value:function(e,t){var n=this;Array.isArray(e)||(e=[e]);var r={contentType:e,callback:t};return this.observers.push(r),function(){Object(u.B)(n.observers,r)}}},{key:"itemsReferencingItem",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");var t=this.collection.uuidsThatReferenceUuid(e);return this.findItems(t)}},{key:"referencesForItem",value:function(e){if(!Object(u.s)(e))throw Error("Must use uuid string");var t=this.findItem(e).references.map((function(e){return e.uuid}));return this.findItems(t)}},{key:"onPayloadChange",value:(T=Fc(i.a.mark((function e(t,n,r,a,o){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.setPayloads(t,n,r,a,o));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return T.apply(this,arguments)})},{key:"setPayloads",value:(M=Fc(i.a.mark((function e(t,n,r,a,o){var s,c,u,l,f,p,y;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=t.map((function(e){return Ut(e)})),c=n.map((function(e){return Ut(e)})),(u=s.concat(c)).length>0&&this.collection.set(u),l=r.map((function(e){return Ut(e)})),f=Mc(l);try{for(f.s();!(p=f.n()).done;)y=p.value,this.collection.discard(y)}catch(e){f.e(e)}finally{f.f()}return e.next=9,this.notifyObservers(s,c,l,a,o);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r,a){return M.apply(this,arguments)})},{key:"notifyObservers",value:(A=Fc(i.a.mark((function e(t,n,r,a,o){var s,c,u,l,f,p,y,h;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:s=function(e,t){return e.filter((function(e){return t.includes(P.a.Any)||t.includes(e.content_type)}))},c=this.observers.slice(),u=Mc(c),e.prev=3,u.s();case 5:if((l=u.n()).done){e.next=16;break}if(f=l.value,p=s(t,f.contentType),y=s(n,f.contentType),h=s(r,f.contentType),0!==p.length||0!==y.length||0!==h.length){e.next=12;break}return e.abrupt("continue",14);case 12:return e.next=14,f.callback(p,y,h,a,o);case 14:e.next=5;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(3),u.e(e.t0);case 21:return e.prev=21,u.f(),e.finish(21);case 24:case"end":return e.stop()}}),e,this,[[3,18,21,24]])}))),function(e,t,n,r,a){return A.apply(this,arguments)})},{key:"changeItem",value:(E=Fc(i.a.mark((function e(t,n){var r,a,o,s,c=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]?c[2]:d.c.UserInteraction,a=c.length>3&&void 0!==c[3]?c[3]:D.a.LocalChanged,o=c.length>4?c[4]:void 0,Object(u.s)(t)){e.next=5;break}throw Error("Invalid uuid for changeItem");case 5:return e.next=7,this.changeItems([t],n,r,a,o);case 7:return s=e.sent,e.abrupt("return",s[0]);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return E.apply(this,arguments)})},{key:"createMutatorForItem",value:function(e,t){return e.content_type===P.a.Note?new St(e,t):e.content_type===P.a.Tag?new at(e,t):e.content_type===P.a.Component?new he(e,t):e.content_type===P.a.ActionsExtension?new Je(e,t):e.content_type===P.a.ItemsKey?new Kt(e,t):e.content_type===P.a.Privileges?new te(e,t):e.content_type===P.a.UserPrefs?new U(e,t):new d.b(e,t)}},{key:"changeItems",value:(R=Fc(i.a.mark((function e(t,n){var r,a,o,s,c,u,l,f,p,y,h,v=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=v.length>2&&void 0!==v[2]?v[2]:d.c.UserInteraction,a=v.length>3&&void 0!==v[3]?v[3]:D.a.LocalChanged,o=v.length>4?v[4]:void 0,s=this.findItems(t,!0),c=[],u=Mc(s),e.prev=6,u.s();case 8:if((l=u.n()).done){e.next=18;break}if(f=l.value){e.next=12;break}throw Error("Attempting to change non-existant item");case 12:p=this.createMutatorForItem(f,r),n&&n(p),y=p.getResult(),c.push(y);case 16:e.next=8;break;case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(6),u.e(e.t0);case 23:return e.prev=23,u.f(),e.finish(23);case 26:return e.next=28,this.modelManager.emitPayloads(c,a,o);case 28:return h=this.findItems(c.map((function(e){return e.uuid}))),e.abrupt("return",h);case 30:case"end":return e.stop()}}),e,this,[[6,20,23,26]])}))),function(e,t){return R.apply(this,arguments)})},{key:"changeNote",value:(_=Fc(i.a.mark((function e(t,n){var r,a,o,s,c,u=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:d.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:D.a.LocalChanged,o=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant note");case 6:return c=new St(s,r),e.abrupt("return",this.applyTransform(c,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return _.apply(this,arguments)})},{key:"changeComponent",value:(I=Fc(i.a.mark((function e(t,n){var r,a,o,s,c,u=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:d.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:D.a.LocalChanged,o=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant component");case 6:return c=new he(s,r),e.abrupt("return",this.applyTransform(c,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return I.apply(this,arguments)})},{key:"changeActionsExtension",value:(O=Fc(i.a.mark((function e(t,n){var r,a,o,s,c,u=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:d.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:D.a.LocalChanged,o=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant extension");case 6:return c=new Je(s,r),e.abrupt("return",this.applyTransform(c,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return O.apply(this,arguments)})},{key:"changeItemsKey",value:(x=Fc(i.a.mark((function e(t,n){var r,a,o,s,c,u=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=u.length>2&&void 0!==u[2]?u[2]:d.c.UserInteraction,a=u.length>3&&void 0!==u[3]?u[3]:D.a.LocalChanged,o=u.length>4?u[4]:void 0,s=this.findItem(t)){e.next=6;break}throw Error("Attempting to change non-existant itemsKey");case 6:return c=new Kt(s,r),e.abrupt("return",this.applyTransform(c,n,a,o));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return x.apply(this,arguments)})},{key:"applyTransform",value:(S=Fc(i.a.mark((function e(t,n){var r,a,o,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]?s[2]:D.a.LocalChanged,a=s.length>3?s[3]:void 0,n(t),o=t.getResult(),e.abrupt("return",this.modelManager.emitPayload(o,r,a));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return S.apply(this,arguments)})},{key:"setItemDirty",value:(k=Fc(i.a.mark((function e(t){var n,r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=a.length>1&&void 0!==a[1]&&a[1],Object(u.s)(t)){e.next=3;break}throw Error("Must use uuid when setting item dirty");case 3:return e.next=5,this.setItemsDirty([t],n);case 5:return r=e.sent,e.abrupt("return",r[0]);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return k.apply(this,arguments)})},{key:"setItemsDirty",value:(w=Fc(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]&&r[1],Object(u.s)(t[0])){e.next=3;break}throw Error("Must use uuid when setting item dirty");case 3:return e.abrupt("return",this.changeItems(t,void 0,n?d.c.UserInteraction:d.c.Internal));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"getDirtyItems",value:function(){return this.collection.dirtyElements().filter((function(e){return!e.errorDecrypting||e.deleted}))}},{key:"insertItem",value:(g=Fc(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.payload,e.next=3,this.emitItemFromPayload(n);case 3:return r=e.sent,e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)})},{key:"duplicateItem",value:(b=Fc(i.a.mark((function e(t){var n,r,a,o,s,c=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=c.length>1&&void 0!==c[1]&&c[1],r=this.findItem(t),a=Object(j.e)(r),e.next=5,na(a,this.modelManager.getMasterCollection(),n);case 5:return o=e.sent,e.next=8,this.modelManager.emitPayloads(o,D.a.LocalChanged);case 8:return s=this.findItem(o[0].uuid),e.abrupt("return",s);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return b.apply(this,arguments)})},{key:"createItem",value:(m=Fc(i.a.mark((function e(t,n){var r,a,o,c=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>2&&void 0!==c[2]&&c[2],a=c.length>3?c[3]:void 0,t){e.next=4;break}throw"Attempting to create item with no contentType";case 4:return e.t0=j.e,e.next=7,h.GenerateUuid();case 7:return e.t1=e.sent,e.t2=t,e.t3=n?Object(s.a)(n):void 0,e.t4=r,e.t5={uuid:e.t1,content_type:e.t2,content:e.t3,dirty:e.t4},e.t6=a,o=(0,e.t0)(e.t5,e.t6),e.next=16,this.modelManager.emitPayload(o,D.a.Constructor);case 16:return e.abrupt("return",this.findItem(o.uuid));case 17:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)})},{key:"createTemplateItem",value:(v=Fc(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=j.e,e.next=3,h.GenerateUuid();case 3:return e.t1=e.sent,e.t2=t,e.t3=Object(s.a)(n||{}),e.t4={uuid:e.t1,content_type:e.t2,content:e.t3},r=(0,e.t0)(e.t4),e.abrupt("return",Ut(r));case 9:case"end":return e.stop()}}),e)}))),function(e,t){return v.apply(this,arguments)})},{key:"emitItemFromPayload",value:(y=Fc(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]?r[1]:D.a.Constructor,e.next=3,this.modelManager.emitPayload(t,n);case 3:return e.abrupt("return",this.findItem(t.uuid));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return y.apply(this,arguments)})},{key:"emitItemsFromPayloads",value:(p=Fc(i.a.mark((function e(t){var n,r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:D.a.Constructor,e.next=3,this.modelManager.emitPayloads(t,n);case 3:return r=Object(s.b)(t),e.abrupt("return",this.findItems(r));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"setItemToBeDeleted",value:(f=Fc(i.a.mark((function e(t){var n,r,a,o,s,c,u;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.collection.uuidsThatReferenceUuid(t),r=this.findItem(t),e.next=4,this.changeItem(t,(function(e){e.setDeleted()}));case 4:a=e.sent,o=Mc(n),e.prev=6,o.s();case 8:if((s=o.n()).done){e.next=16;break}if(c=s.value,!(u=this.findItem(c))){e.next=14;break}return e.next=14,this.changeItem(u.uuid,(function(e){e.removeItemAsRelationship(r)}));case 14:e.next=8;break;case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(6),o.e(e.t0);case 21:return e.prev=21,o.f(),e.finish(21);case 24:return e.abrupt("return",a);case 25:case"end":return e.stop()}}),e,this,[[6,18,21,24]])}))),function(e){return f.apply(this,arguments)})},{key:"setItemsToBeDeleted",value:(l=Fc(i.a.mark((function e(t){var n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=[],r=Mc(t),e.prev=2,r.s();case 4:if((a=r.n()).done){e.next=12;break}return o=a.value,e.next=8,this.setItemToBeDeleted(o);case 8:s=e.sent,n.push(s);case 10:e.next=4;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),r.e(e.t0);case 17:return e.prev=17,r.f(),e.finish(17);case 20:return e.abrupt("return",n);case 21:case"end":return e.stop()}}),e,this,[[2,14,17,20]])}))),function(e){return l.apply(this,arguments)})},{key:"getItems",value:function(e){return this.collection.all(e)}},{key:"nonErroredItemsForContentType",value:function(e){return this.collection.all(e).filter((function(e){return!e.errorDecrypting&&!e.waitingForKey}))}},{key:"itemsMatchingPredicate",value:function(e){return this.itemsMatchingPredicates([e])}},{key:"itemsMatchingPredicates",value:function(e){return this.subItemsMatchingPredicates(this.items,e)}},{key:"subItemsMatchingPredicates",value:function(e,t){return e.filter((function(e){if(e.deleted)return!1;var n,r=Mc(t);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(!e.satisfiesPredicate(a))return!1}}catch(e){r.e(e)}finally{r.f()}return!0}))}},{key:"findTagByTitle",value:function(e){return Object(u.D)(this.tags,{title:e})}},{key:"findOrCreateTagByTitle",value:(c=Fc(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.findTagByTitle(t),e.t0=n,e.t0){e.next=6;break}return e.next=5,this.createItem(P.a.Tag,Object(s.a)({title:t}),!0);case 5:e.t0=e.sent;case 6:return e.abrupt("return",e.t0);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"notesMatchingSmartTag",value:function(e){var t=[new C.a("content_type","=",P.a.Note),e.predicate];if(!e.isTrashTag){var n=new C.a("content.trashed","=",!1);t.push(n)}return this.itemsMatchingPredicates(t)}},{key:"emptyTrash",value:(o=Fc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.trashedItems,e.abrupt("return",this.setItemsToBeDeleted(Object(s.b)(t)));case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"getSmartTags",value:function(){var e=this.collection.displayElements(P.a.SmartTag);return this.systemSmartTags.concat(e)}},{key:"removeAllItemsFromMemory",value:(a=Fc(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(s.b)(this.items),e.next=3,this.changeItems(t,(function(e){e.setDeleted()}),d.c.NonDirtying);case 3:this.resetState(),this.modelManager.resetState();case 5:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"removeItemLocally",value:function(e){this.collection.discard(e),this.modelManager.removePayloadLocally(e.payload)}},{key:"items",get:function(){return this.collection.all()}},{key:"nonDeletedItems",get:function(){return this.collection.nondeletedElements()}},{key:"invalidItems",get:function(){return this.collection.invalidElements()}},{key:"notes",get:function(){return this.collection.displayElements(P.a.Note)}},{key:"tags",get:function(){return this.collection.displayElements(P.a.Tag)}},{key:"components",get:function(){return this.collection.displayElements(P.a.Component)}},{key:"trashSmartTag",get:function(){return this.systemSmartTags.find((function(e){return e.isTrashTag}))}},{key:"trashedItems",get:function(){return this.notesMatchingSmartTag(this.trashSmartTag)}},{key:"noteCount",get:function(){return this.collection.all(P.a.Note).length}}])&&Lc(t.prototype,n),r&&Lc(t,r),F}(Gt.a);function zc(e,t){return e.sort((function(e,n){var r=new Date(n.updated_at).getTime()-new Date(e.updated_at).getTime(),a=0,o=0;return t&&(a=t.indexOf(e.content_type),o=t.indexOf(n.content_type),-1===a&&(a=t.length),-1===o&&(o=t.length)),a===o?r:a<o?-1:1}))}function qc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Jc=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.inProgress=!1,this.completedUpload=0,this.totalUpload=0,this.downloaded=0,this.databaseLoadCurrent=0,this.databaseLoadTotal=0,this.databaseLoadDone=!1,this.syncing=!1,this.interval=t,this.receiver=n}var t,n,r;return t=e,(n=[{key:"deinit",value:function(){this.stopTimingMonitor()}},{key:"setSyncInProgress",value:function(e){this.inProgress=!0}},{key:"setUploadStatus",value:function(e,t){this.completedUpload=e,this.totalUpload=t,this.receiver(Ua.a.StatusChanged)}},{key:"setDownloadStatus",value:function(e){this.downloaded+=e,this.receiver(Ua.a.StatusChanged)}},{key:"setDatabaseLoadStatus",value:function(e,t,n){this.databaseLoadCurrent=e,this.databaseLoadTotal=t,this.databaseLoadDone=n,n?this.receiver(Ua.a.LocalDataLoaded):this.receiver(Ua.a.LocalDataIncrementalLoad)}},{key:"getStats",value:function(){return{uploadCompletionCount:this.completedUpload,uploadTotalCount:this.totalUpload,downloadCount:this.downloaded,localDataDone:this.databaseLoadDone,localDataCurrent:this.databaseLoadCurrent,localDataTotal:this.databaseLoadTotal}}},{key:"setDidBegin",value:function(){this.syncing=!0,this.syncStart=new Date}},{key:"setDidEnd",value:function(){this.syncing=!1,this.syncEnd=new Date}},{key:"startTimingMonitor",value:function(){var e=this;this.timingMonitor&&this.stopTimingMonitor(),this.timingMonitor=this.interval((function(){e.secondsSinceSyncStart>5&&(e.receiver(Ua.a.SyncTakingTooLong),e.stopTimingMonitor())}),500)}},{key:"stopTimingMonitor",value:function(){Object.prototype.hasOwnProperty.call(this.interval,"cancel")?this.interval.cancel(this.timingMonitor):clearInterval(this.timingMonitor),this.timingMonitor=null}},{key:"hasError",value:function(){return!!this.error}},{key:"setError",value:function(e){this.error=e}},{key:"clearError",value:function(){this.error=null}},{key:"reset",value:function(){this.downloaded=0,this.completedUpload=0,this.totalUpload=0,this.inProgress=!1,this.syncing=!1,this.error=null,this.stopTimingMonitor(),this.receiver(Ua.a.StatusChanged)}},{key:"syncInProgress",get:function(){return!0===this.syncing}},{key:"secondsSinceSyncStart",get:function(){return((new Date).getTime()-this.syncStart.getTime())/1e3}}])&&qc(t.prototype,n),r&&qc(t,r),e}();function Gc(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function $c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Qc=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.discordance=0,this.outOfSync=!1,this.receiver=t,this.maxDiscordance=n,this.reset()}var t,n,r,a,o;return t=e,(n=[{key:"isOutOfSync",value:function(){return this.outOfSync}},{key:"reset",value:function(){this.lastPreSyncSave=void 0,this.lastSyncDate=void 0,this.discordance=0,this.outOfSync=!1}},{key:"getLastClientIntegrityHash",value:function(){return this.lastClientHash}},{key:"clearIntegrityHashes",value:function(){this.lastClientHash=void 0,this.lastServerHash=void 0}},{key:"setIntegrityHashes",value:(a=i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.lastClientHash=t,this.lastServerHash=n,n&&0!==n.length&&t&&t!==n?(this.discordance++,this.discordance>=this.maxDiscordance&&!this.outOfSync&&(this.outOfSync=!0,this.receiver(Ua.a.EnterOutOfSync))):(this.outOfSync&&(this.outOfSync=!1,this.receiver(Ua.a.ExitOutOfSync)),this.discordance=0);case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Gc(o,n,r,i,s,"next",e)}function s(e){Gc(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e,t){return o.apply(this,arguments)})},{key:"needsSync",get:function(){return this.discordance>0&&this.discordance<this.maxDiscordance}}])&&$c(t.prototype,n),r&&$c(t,r),e}();function Yc(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Xc(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Zc=function(){function e(t,n,r,a,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.apiService=t,this.protocolService=n,this.contentType=r,this.customEvent=a,this.limit=o,this.progress={retrievedPayloads:[]}}var t,n,r,a,o;return t=e,(n=[{key:"run",value:(a=i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.apiService.sync([],this.progress.lastSyncToken,this.progress.paginationToken,this.limit||500,!1,this.contentType,this.customEvent);case 2:return t=e.sent,n=t.retrieved_items.map((function(e){return Object(j.f)(e,D.a.RemoteRetrieved)})),e.next=6,this.protocolService.payloadsByDecryptingPayloads(n);case 6:if(r=e.sent,this.progress.retrievedPayloads=this.progress.retrievedPayloads.concat(r),this.progress.lastSyncToken=t.sync_token,this.progress.paginationToken=t.cursor_token,!t.cursor_token){e.next=14;break}return e.abrupt("return",this.run());case 14:return e.abrupt("return",this.progress.retrievedPayloads);case 15:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Yc(o,n,r,i,s,"next",e)}function s(e){Yc(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&Xc(t.prototype,n),r&&Xc(t,r),e}();function eu(e){return(eu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function tu(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return nu(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return nu(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function nu(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ru(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function au(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){ru(o,r,a,i,s,"next",e)}function s(e){ru(o,r,a,i,s,"throw",e)}i(void 0)}))}}function ou(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function iu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function su(e,t){return(su=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function cu(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=lu(e);if(t){var a=lu(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return uu(this,n)}}function uu(e,t){return!t||"object"!==eu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function lu(e){return(lu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var fu=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&su(e,t)}(l,e);var t,n,r,a,o,s,c=cu(l);function l(){return ou(this,l),c.apply(this,arguments)}return t=l,(n=[{key:"resultingCollection",value:(s=au(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.applyCollection.source!==D.a.ConflictUuid){e.next=4;break}return e.abrupt("return",this.collectionsByHandlingUuidConflicts());case 4:if(this.applyCollection.source!==D.a.ConflictData){e.next=8;break}return e.abrupt("return",this.collectionsByHandlingDataConflicts());case 8:throw"Unhandled conflict type ".concat(this.applyCollection.source);case 9:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"collectionsByHandlingDataConflicts",value:(o=au(i.a.mark((function e(){var t,n,r,a,o,s,c,l,f;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=tu(this.applyCollection.all()),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=21;break}if(a=r.value,o=this.findBasePayload(a.uuid)){e.next=10;break}return t.push(a),e.abrupt("continue",19);case 10:if((s=this.findRelatedPayload(a.uuid,D.a.DecryptedTransient))||a.deleted){e.next=13;break}throw"Unable to find decrypted counterpart for data conflict.";case 13:return c=new va(this.baseCollection,o,s||a,D.a.ConflictData),e.next=16,c.resultingCollection();case 16:l=e.sent,f=l.all(),Object(u.j)(t,f);case 19:e.next=4;break;case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(2),n.e(e.t0);case 26:return e.prev=26,n.f(),e.finish(26);case 29:return e.abrupt("return",Jr.WithPayloads(t,D.a.RemoteRetrieved));case 30:case"end":return e.stop()}}),e,this,[[2,23,26,29]])}))),function(){return o.apply(this,arguments)})},{key:"collectionsByHandlingUuidConflicts",value:(a=au(i.a.mark((function e(){var t,n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=tu(this.applyCollection.all()),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=13;break}return a=r.value,o=this.findRelatedPayload(a.uuid,D.a.DecryptedTransient),e.next=9,aa(o,this.baseCollection);case 9:s=e.sent,Object(u.j)(t,s);case 11:e.next=4;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),n.e(e.t0);case 18:return e.prev=18,n.f(),e.finish(18);case 21:return e.abrupt("return",Jr.WithPayloads(t,D.a.RemoteRetrieved));case 22:case"end":return e.stop()}}),e,this,[[2,15,18,21]])}))),function(){return a.apply(this,arguments)})}])&&iu(t.prototype,n),r&&iu(t,r),l}(Ir);function pu(e){return(pu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function yu(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return hu(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return hu(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function hu(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function du(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function vu(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function mu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function bu(e,t){return(bu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function gu(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ku(e);if(t){var a=ku(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return wu(this,n)}}function wu(e,t){return!t||"object"!==pu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ku(e){return(ku=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Su=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&bu(e,t)}(c,e);var t,n,r,a,o,s=gu(c);function c(){return vu(this,c),s.apply(this,arguments)}return t=c,(n=[{key:"resultingCollection",value:(a=i.a.mark((function e(){var t,n,r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=yu(this.applyCollection.all());try{for(n.s();!(r=n.n()).done;)a=r.value,o=this.findBasePayload(a.uuid),s=o?o.deleted:a.deleted,c=Object(j.f)(a,D.a.RemoteSaved,{lastSyncEnd:new Date,deleted:s}),t.push(c)}catch(e){n.e(e)}finally{n.f()}return e.abrupt("return",Jr.WithPayloads(t,D.a.RemoteSaved));case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){du(o,n,r,i,s,"next",e)}function s(e){du(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&mu(t.prototype,n),r&&mu(t,r),c}(Ir);function xu(e){return(xu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ou(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Pu(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Pu(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Pu(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function ju(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Du(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Cu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Iu(e,t){return(Iu=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Eu(e);if(t){var a=Eu(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Ru(this,n)}}function Ru(e,t){return!t||"object"!==xu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Eu(e){return(Eu=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Au=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Iu(e,t)}(c,e);var t,n,r,a,o,s=_u(c);function c(){return Du(this,c),s.apply(this,arguments)}return t=c,(n=[{key:"resultingCollection",value:(a=i.a.mark((function e(){var t,n,r,a,o,s,c,l,f,p,y,h,d,v,m,b,g;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=[],r=Ou(this.applyCollection.all()),e.prev=3,r.s();case 5:if((a=r.n()).done){e.next=24;break}if(o=a.value,s=this.findRelatedPayload(o.uuid,D.a.SavedOrSaving),c=this.findRelatedPayload(o.uuid,D.a.DecryptedTransient)){e.next=14;break}if(o.deleted){e.next=12;break}throw"Cannot find decrypted for non-deleted payload.";case 12:return t.push(o),e.abrupt("continue",22);case 14:if(!s){e.next=17;break}return n.push(c),e.abrupt("continue",22);case 17:if(!(l=this.findBasePayload(o.uuid))||!l.dirty){e.next=21;break}return n.push(c),e.abrupt("continue",22);case 21:t.push(c);case 22:e.next=5;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(3),r.e(e.t0);case 29:return e.prev=29,r.f(),e.finish(29);case 32:f=[],p=0,y=n;case 34:if(!(p<y.length)){e.next=51;break}if(h=y[p],d=this.findRelatedPayload(h.uuid,D.a.DecryptedTransient)){e.next=39;break}return e.abrupt("continue",48);case 39:if(v=this.findBasePayload(h.uuid)){e.next=42;break}return e.abrupt("continue",48);case 42:return m=new va(this.baseCollection,v,d,D.a.ConflictData),e.next=45,m.resultingCollection();case 45:b=e.sent,g=b.all(),Object(u.j)(f,g);case 48:p++,e.next=34;break;case 51:return e.abrupt("return",Jr.WithPayloads(t.concat(f),D.a.RemoteRetrieved));case 52:case"end":return e.stop()}}),e,this,[[3,26,29,32]])})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){ju(o,n,r,i,s,"next",e)}function s(e){ju(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&Cu(t.prototype,n),r&&Cu(t,r),c}(Ir);function Mu(e){return e===D.a.RemoteRetrieved?Au:e===D.a.RemoteSaved?Su:e===D.a.ConflictData||e===D.a.ConflictUuid?fu:void 0}function Tu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Ku=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.collections=t,Object.freeze(this)}var t,n,r;return t=e,(n=[{key:"collectionForSource",value:function(e){return this.collections.find((function(t){return t.source===e}))}}])&&Tu(t.prototype,n),r&&Tu(t,r),e}();function Fu(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Lu(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Fu(o,r,a,i,s,"next",e)}function s(e){Fu(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Vu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Nu,Uu=function(){function e(t,n,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.response=t,this.baseCollection=r,this.relatedCollectionSet=new Ku([Jr.WithPayloads(n,D.a.DecryptedTransient),Jr.WithPayloads(a,D.a.SavedOrSaving)])}var t,n,r,a,o;return t=e,(n=[{key:"collectionsByProcessingResponse",value:(o=Lu(i.a.mark((function e(){var t,n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,this.collectionByProcessingPayloads(this.response.retrievedPayloads,D.a.RemoteRetrieved);case 3:return(n=e.sent).all().length>0&&t.push(n),e.next=7,this.collectionByProcessingPayloads(this.response.savedPayloads,D.a.RemoteSaved);case 7:if((r=e.sent).all().length>0&&t.push(r),!(this.response.uuidConflictPayloads.length>0)){e.next=14;break}return e.next=12,this.collectionByProcessingPayloads(this.response.uuidConflictPayloads,D.a.ConflictUuid);case 12:(a=e.sent).all().length>0&&t.push(a);case 14:if(!(this.response.dataConflictPayloads.length>0)){e.next=19;break}return e.next=17,this.collectionByProcessingPayloads(this.response.dataConflictPayloads,D.a.ConflictData);case 17:(o=e.sent).all().length>0&&t.push(o);case 19:return e.abrupt("return",t);case 20:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"collectionByProcessingPayloads",value:(a=Lu(i.a.mark((function e(t,n){var r,a,o,s,c,u=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=Jr.WithPayloads(t,n),a=Mu(n),o=new a(this.baseCollection,r,this.relatedCollectionSet),e.next=5,o.resultingCollection();case 5:return s=e.sent,c=s.all().map((function(e){var t=u.finalDirtyStateForPayload(e);return Object(j.b)(e,{dirty:t,dirtiedDate:t?new Date:void 0})})),e.abrupt("return",Jr.WithPayloads(c,n));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"finalDirtyStateForPayload",value:function(e){var t=this.baseCollection.find(e.uuid);return t?e.dirtiedDate&&e.dirtiedDate>t.dirtiedDate?e.dirty:t.dirtiedDate>t.lastSyncBegan:e.dirty}}])&&Vu(t.prototype,n),r&&Vu(t,r),e}();function Wu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}!function(e){e.ConflictingData="sync_conflict",e.UuidConflict="uuid_conflict"}(Nu||(Nu={}));var Bu,Hu=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.rawResponse=t,this.savedPayloads=this.filterRawItemArray(t.saved_items).map((function(e){return Object(j.f)(e,D.a.RemoteSaved)})),this.retrievedPayloads=this.filterRawItemArray(t.retrieved_items).map((function(e){return Object(j.f)(e,D.a.RemoteRetrieved)})),this.dataConflictPayloads=this.filterRawItemArray(this.rawDataConflictItems).map((function(e){return Object(j.f)(e,D.a.ConflictData)})),this.uuidConflictPayloads=this.filterRawItemArray(this.rawUuidConflictItems).map((function(e){return Object(j.f)(e,D.a.ConflictUuid)})),this.deletedPayloads=this.allProcessedPayloads.filter((function(e){return e.discardable})),Object(u.g)(this)}var t,n,r;return t=e,(n=[{key:"filterRawItemArray",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.filter((function(e){return!!e.uuid}))}},{key:"error",get:function(){return this.rawResponse.error}},{key:"status",get:function(){return this.rawResponse.status}},{key:"lastSyncToken",get:function(){return this.rawResponse[Nn.LastSyncToken]}},{key:"paginationToken",get:function(){return this.rawResponse[Nn.PaginationToken]}},{key:"integrityHash",get:function(){return this.rawResponse[Nn.IntegrityResult]}},{key:"checkIntegrity",get:function(){return this.integrityHash&&!this.paginationToken}},{key:"numberOfItemsInvolved",get:function(){return this.allProcessedPayloads.length}},{key:"allProcessedPayloads",get:function(){return this.savedPayloads.concat(this.retrievedPayloads).concat(this.dataConflictPayloads).concat(this.uuidConflictPayloads)}},{key:"rawUuidConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return e.type===Nu.UuidConflict})).map((function(e){return e.unsaved_item||e.item}))}},{key:"rawDataConflictItems",get:function(){return this.rawConflictObjects.filter((function(e){return e.type===Nu.ConflictingData})).map((function(e){return e.server_item||e.item}))}},{key:"rawConflictObjects",get:function(){var e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[];return e.concat(t)}},{key:"hasError",get:function(){return!Object(u.p)(this.rawResponse.error)}}])&&Wu(t.prototype,n),r&&Wu(t,r),e}();function zu(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return qu(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return qu(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function qu(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Ju(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Gu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}!function(e){e[e.Response=1]="Response",e[e.StatusChanged=2]="StatusChanged"}(Bu||(Bu={}));var $u=function(){function e(t,n,r,a,o,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.responses=[],this.payloads=t,this.lastSyncToken=r,this.paginationToken=a,this.checkIntegrity=o,this.apiService=i,this.receiver=n,this.pendingPayloads=t}var t,n,r,a,o;return t=e,(n=[{key:"popPayloads",value:function(e){var t=this.pendingPayloads.slice(0,e);return Object(u.G)(this.pendingPayloads,t),t}},{key:"run",value:(a=i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.popPayloads(this.upLimit),e.next=3,this.apiService.sync(t,this.lastSyncToken,this.paginationToken,this.downLimit,this.checkIntegrity,void 0,void 0);case 3:return n=e.sent,r=new Hu(n),this.responses.push(r),this.lastSyncToken=r.lastSyncToken,this.paginationToken=r.paginationToken,e.next=10,this.receiver(Bu.Response,r);case 10:if(this.done){e.next=12;break}return e.abrupt("return",this.run());case 12:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Ju(o,n,r,i,s,"next",e)}function s(e){Ju(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})},{key:"pendingUploadCount",value:function(){return this.pendingPayloads.length}},{key:"totalUploadCount",value:function(){return this.payloads.length}},{key:"payloadsSavedOrSaving",get:function(){return Object(u.c)(this.payloads,this.pendingPayloads)}},{key:"done",get:function(){return 0===this.pendingPayloads.length&&!this.paginationToken}},{key:"upLimit",get:function(){return 150}},{key:"downLimit",get:function(){return 150}},{key:"numberOfItemsInvolved",get:function(){var e,t=0,n=zu(this.responses);try{for(n.s();!(e=n.n()).done;)t+=e.value.numberOfItemsInvolved}catch(e){n.e(e)}finally{n.f()}return t}}])&&Gu(t.prototype,n),r&&Gu(t,r),e}();function Qu(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Yu(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Xu=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.payloads=t,this.receiver=n}var t,n,r,a,o;return t=e,(n=[{key:"run",value:(a=i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.payloads.map((function(e){return Object(j.f)(e,D.a.LocalSaved,{dirty:!1,lastSyncEnd:new Date})})),n=Object(u.a)(t),r=new Hu({saved_items:n}),e.next=5,this.receiver(Bu.Response,r);case 5:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Qu(o,n,r,i,s,"next",e)}function s(e){Qu(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&Yu(t.prototype,n),r&&Yu(t,r),e}();function Zu(e){return(Zu="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function el(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return tl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return tl(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function tl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function nl(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function rl(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function al(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ol(e,t){return(ol=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function il(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=cl(e);if(t){var a=cl(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return sl(this,n)}}function sl(e,t){return!t||"object"!==Zu(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function cl(e){return(cl=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var ul=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ol(e,t)}(c,e);var t,n,r,a,o,s=il(c);function c(){return rl(this,c),s.apply(this,arguments)}return t=c,(n=[{key:"resultingCollection",value:(a=i.a.mark((function e(){var t,n,r,a,o,s;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],n=el(this.applyCollection.all()),e.prev=2,n.s();case 4:if((r=n.n()).done){e.next=19;break}if(a=r.value,t.push(a),o=this.findBasePayload(a.uuid)){e.next=10;break}return e.abrupt("continue",17);case 10:if(!ca(a,o)){e.next=13;break}return e.abrupt("continue",17);case 13:return e.next=15,na(o,this.baseCollection,!0);case 15:s=e.sent,Object(u.j)(t,s);case 17:e.next=4;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(2),n.e(e.t0);case 24:return e.prev=24,n.f(),e.finish(24);case 27:return e.abrupt("return",Jr.WithPayloads(t,D.a.RemoteRetrieved));case 28:case"end":return e.stop()}}),e,this,[[2,21,24,27]])})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){nl(o,n,r,i,s,"next",e)}function s(e){nl(o,n,r,i,s,"throw",e)}i(void 0)}))},function(){return o.apply(this,arguments)})}])&&al(t.prototype,n),r&&al(t,r),c}(Ir);function ll(e){return(ll="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function fl(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function pl(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?fl(Object(n),!0).forEach((function(t){yl(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fl(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function yl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function hl(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return dl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return dl(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function dl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function vl(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ml(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){vl(o,r,a,i,s,"next",e)}function s(e){vl(o,r,a,i,s,"throw",e)}i(void 0)}))}}function bl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function gl(e,t,n){return(gl="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=xl(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function wl(e,t){return(wl=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function kl(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=xl(e);if(t){var a=xl(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Sl(this,n)}}function Sl(e,t){return!t||"object"!==ll(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function xl(e){return(xl=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ol,Pl,jl;!function(e){e[e.ResolveOnNext=1]="ResolveOnNext",e[e.ForceSpawnNew=2]="ForceSpawnNew"}(Ol||(Ol={})),function(e){e[e.Default=1]="Default",e[e.DownloadFirst=2]="DownloadFirst"}(Pl||(Pl={})),function(e){e[e.External=1]="External",e[e.SpawnQueue=2]="SpawnQueue",e[e.ResolveQueue=3]="ResolveQueue",e[e.MoreDirtyItems=4]="MoreDirtyItems",e[e.AfterDownloadFirst=5]="AfterDownloadFirst",e[e.IntegrityCheck=6]="IntegrityCheck",e[e.ResolveOutOfSync=7]="ResolveOutOfSync"}(jl||(jl={}));var Dl=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&wl(e,t)}(V,e);var t,n,r,a,o,c,l,f,p,y,h,v,m,b,g,w,k,S,x,O,C,I,_,R,E,A,M,T,K,F,L=kl(V);function V(e,t,n,r,a,o,i){var s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,V),(s=L.call(this)).resolveQueue=[],s.spawnQueue=[],s.completedOnlineDownloadFirstSync=!1,s.majorChangeThreshold=15,s.maxDiscordance=5,s.locked=!1,s.databaseLoaded=!1,s.localLoadPriorty=[P.a.ItemsKey,P.a.UserPrefs,P.a.Privileges,P.a.Component,P.a.Theme],s.nonEncryptedTypes=[P.a.Mfa,P.a.ServerExtension],s.itemManager=e,s.sessionManager=t,s.protocolService=n,s.modelManager=a,s.storageService=r,s.apiService=o,s.interval=i,s.initializeStatus(),s.initializeState(),s}return t=V,(n=[{key:"onNewDatabaseCreated",value:(F=ml(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLastSyncToken();case 2:if(!e.sent){e.next=5;break}return e.next=5,this.clearSyncPositionTokens();case 5:case"end":return e.stop()}}),e,this)}))),function(){return F.apply(this,arguments)})},{key:"deinit",value:function(){this.sessionManager=void 0,this.itemManager=void 0,this.protocolService=void 0,this.modelManager=void 0,this.storageService=void 0,this.apiService=void 0,this.interval=void 0,this.state.reset(),this.opStatus.reset(),this.state=void 0,this.opStatus=void 0,this.resolveQueue.length=0,this.spawnQueue.length=0,gl(xl(V.prototype),"deinit",this).call(this)}},{key:"initializeStatus",value:function(){var e=this;this.opStatus=new Jc(this.interval,(function(t){e.notifyEvent(t)}))}},{key:"initializeState",value:function(){var e=this;this.state=new Qc((function(t){t===Ua.a.EnterOutOfSync?e.notifyEvent(Ua.a.EnterOutOfSync):t===Ua.a.ExitOutOfSync&&e.notifyEvent(Ua.a.ExitOutOfSync)}),this.maxDiscordance)}},{key:"lockSyncing",value:function(){this.locked=!0}},{key:"unlockSyncing",value:function(){this.locked=!1}},{key:"isOutOfSync",value:function(){return this.state.isOutOfSync()}},{key:"getLastSyncDate",value:function(){return this.state.lastSyncDate}},{key:"getStatus",value:function(){return this.opStatus}},{key:"resetSyncState",value:function(){this.state.reset()}},{key:"isDatabaseLoaded",value:function(){return this.databaseLoaded}},{key:"getDatabasePayloads",value:(K=ml(i.a.mark((function e(){var t=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getAllRawPayloads().catch((function(e){throw t.notifyEvent(Ua.a.DatabaseReadError,e),e})));case 1:case"end":return e.stop()}}),e,this)}))),function(){return K.apply(this,arguments)})},{key:"loadDatabasePayloads",value:(T=ml(i.a.mark((function e(t){var n,r,a,o,s,c,l,f,p,y,h;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.databaseLoaded){e.next=2;break}throw"Attempting to initialize already initialized local database.";case 2:if(0!==t.length){e.next=6;break}return this.databaseLoaded=!0,this.opStatus.setDatabaseLoadStatus(0,0,!0),e.abrupt("return");case 6:return n=t.map((function(e){return Object(j.e)(e)})),r=zc(n,this.localLoadPriorty),a=r.filter((function(e){return e.content_type===P.a.ItemsKey})),Object(u.G)(r,a),e.next=12,this.protocolService.payloadsByDecryptingPayloads(a);case 12:return o=e.sent,e.next=15,this.modelManager.emitPayloads(o,D.a.LocalRetrieved);case 15:s=r.length,c=100,l=Math.ceil(s/c),f=0;case 19:if(!(f<l)){e.next=32;break}return p=f*c,y=r.slice(p,p+c),e.next=24,this.protocolService.payloadsByDecryptingPayloads(y);case 24:return h=e.sent,e.next=27,this.modelManager.emitPayloads(h,D.a.LocalRetrieved);case 27:this.notifyEvent(Ua.a.LocalDataIncrementalLoad),this.opStatus.setDatabaseLoadStatus(p,s,!1);case 29:f++,e.next=19;break;case 32:this.databaseLoaded=!0,this.opStatus.setDatabaseLoadStatus(0,0,!0);case 34:case"end":return e.stop()}}),e,this)}))),function(e){return T.apply(this,arguments)})},{key:"setLastSyncToken",value:(M=ml(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=t,e.abrupt("return",this.storageService.setValue(Vt.LastSyncToken,t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return M.apply(this,arguments)})},{key:"setPaginationToken",value:(A=ml(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken=t,!t){e.next=5;break}return e.abrupt("return",this.storageService.setValue(Vt.PaginationToken,t));case 5:return e.abrupt("return",this.storageService.removeValue(Vt.PaginationToken));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return A.apply(this,arguments)})},{key:"getLastSyncToken",value:(E=ml(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.syncToken){e.next=4;break}return e.next=3,this.storageService.getValue(Vt.LastSyncToken);case 3:this.syncToken=e.sent;case 4:return e.abrupt("return",this.syncToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"getPaginationToken",value:(R=ml(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.cursorToken){e.next=4;break}return e.next=3,this.storageService.getValue(Vt.PaginationToken);case 3:this.cursorToken=e.sent;case 4:return e.abrupt("return",this.cursorToken);case 5:case"end":return e.stop()}}),e,this)}))),function(){return R.apply(this,arguments)})},{key:"clearSyncPositionTokens",value:(_=ml(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.syncToken=void 0,this.cursorToken=void 0,e.next=4,this.storageService.removeValue(Vt.LastSyncToken);case 4:return e.next=6,this.storageService.removeValue(Vt.PaginationToken);case 6:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{key:"itemsNeedingSync",value:(I=ml(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.getDirtyItems(),e.abrupt("return",t);case 2:case"end":return e.stop()}}),e,this)}))),function(){return I.apply(this,arguments)})},{key:"alternateUuidForItem",value:(C=ml(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.itemManager.findItem(t),r=Object(j.e)(n),e.next=4,aa(r,this.modelManager.getMasterCollection());case 4:return a=e.sent,e.next=7,this.modelManager.emitPayloads(a,D.a.LocalChanged);case 7:return e.next=9,this.persistPayloads(a);case 9:return e.abrupt("return",this.itemManager.findItem(a[0].uuid));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return C.apply(this,arguments)})},{key:"markAllItemsAsNeedingSync",value:(O=ml(i.a.mark((function e(t){var n,r,a,o,s,c;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Marking all items as needing sync"),!t){e.next=20;break}n=this.itemManager.items.filter((function(e){return!e.errorDecrypting})).slice(),r=hl(n),e.prev=4,r.s();case 6:if((a=r.n()).done){e.next=12;break}return o=a.value,e.next=10,this.alternateUuidForItem(o.uuid);case 10:e.next=6;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(4),r.e(e.t0);case 17:return e.prev=17,r.f(),e.finish(17);case 20:return s=this.itemManager.items,c=s.map((function(e){return Object(j.e)(e,{dirty:!0,dirtiedDate:new Date})})),e.next=24,this.modelManager.emitPayloads(c,D.a.LocalChanged);case 24:return e.next=26,this.persistPayloads(c);case 26:case"end":return e.stop()}}),e,this,[[4,14,17,20]])}))),function(e){return O.apply(this,arguments)})},{key:"popPayloadsNeedingPreSyncSave",value:(x=ml(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.state.lastPreSyncSave){e.next=3;break}return e.abrupt("return",t);case 3:return r=t.filter((function(e){return!e.dirtiedDate||e.dirtiedDate>n})),this.state.lastPreSyncSave=new Date,e.abrupt("return",r);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return x.apply(this,arguments)})},{key:"queueStrategyResolveOnNext",value:function(){var e=this;return new Promise((function(t,n){e.resolveQueue.push({resolve:t,reject:n})}))}},{key:"queueStrategyForceSpawnNew",value:function(e){var t=this;return new Promise((function(n,r){t.spawnQueue.push({resolve:n,reject:r,options:e})}))}},{key:"popSpawnQueue",value:function(){if(0===this.spawnQueue.length)return null;var e=this.spawnQueue[0];return Object(u.C)(this.spawnQueue,0),this.log("Syncing again from spawn queue"),this.sync(pl({queueStrategy:Ol.ForceSpawnNew,source:jl.SpawnQueue},e.options)).then((function(){e.resolve()})).catch((function(){e.reject()}))}},{key:"payloadsByPreparingForServer",value:(S=ml(i.a.mark((function e(t){var n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.payloadsByEncryptingPayloads(t,(function(e){return n.nonEncryptedTypes.includes(e.content_type)?Jt.a.SyncDecrypted:Jt.a.Sync})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return S.apply(this,arguments)})},{key:"downloadFirstSync",value:(k=ml(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=5,a=0;case 2:if(!(a<r)){e.next=14;break}return e.next=5,this.sync(pl({mode:Pl.DownloadFirst,queueStrategy:Ol.ForceSpawnNew},n)).catch(console.error);case 5:if(!this.completedOnlineDownloadFirstSync){e.next=9;break}return e.abrupt("return");case 9:return e.next=11,Object(u.E)(t);case 11:a++,e.next=2;break;case 14:console.error("Failed downloadFirstSync after ".concat(r," tries"));case 15:case"end":return e.stop()}}),e,this)}))),function(e,t){return k.apply(this,arguments)})},{key:"sync",value:(w=ml(i.a.mark((function e(){var t,n,r,a,o,c,l,f,p,y,h,v,m,b,g,w,k,S,x,O,P,j,C=this,I=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=I.length>0&&void 0!==I[0]?I[0]:{},!this.locked){e.next=4;break}return this.log("Sync Locked"),e.abrupt("return");case 4:return n=function(){return C.syncLock},r=function(){C.syncLock=!0},a=function(){C.syncLock=!1},o=this.opStatus.syncInProgress,c=this.databaseLoaded,(l=!n())&&c&&!o&&r(),t.source||(t.source=jl.External),e.next=14,this.itemsNeedingSync();case 14:return f=e.sent,p=f.filter((function(e){return e.neverSynced&&e.deleted})),Object(u.G)(f,p),y=f.map((function(e){return e.payloadRepresentation()})),e.next=20,this.popPayloadsNeedingPreSyncSave(y);case 20:return h=e.sent,e.next=23,this.persistPayloads(h);case 23:if(v=this.resolveQueue.slice(),m=Object(u.p)(t.queueStrategy)?Ol.ResolveOnNext:t.queueStrategy,!o&&c&&l){e.next=36;break}if(this.log(l?o?"Attempting to sync while existing sync in progress.":"Attempting to sync before local database has loaded.":"Another function call has begun preparing for sync."),m!==Ol.ResolveOnNext){e.next=31;break}return e.abrupt("return",this.queueStrategyResolveOnNext());case 31:if(m!==Ol.ForceSpawnNew){e.next=35;break}return e.abrupt("return",this.queueStrategyForceSpawnNew({mode:t.mode,checkIntegrity:t.checkIntegrity,source:t.source}));case 35:throw"Unhandled timing strategy ".concat(m);case 36:if(this.opStatus.setDidBegin(),this.notifyEvent(Ua.a.SyncWillBegin),Object(u.G)(this.resolveQueue,v),b=new Date,!(f.length>0)){e.next=43;break}return e.next=43,this.itemManager.changeItems(Object(s.b)(f),(function(e){e.lastSyncBegan=b}),d.c.NonDirtying,D.a.PreSyncSave);case 43:if(g=this.sessionManager.online(),i=t.mode,w=g&&!C.completedOnlineDownloadFirstSync?Pl.DownloadFirst:Object(u.p)(i)?Pl.Default:i,k=[],w!==Pl.Default){e.next=58;break}if(!g||this.completedOnlineDownloadFirstSync){e.next=49;break}throw Error("Attempting to default mode sync without having completed initial.");case 49:if(!g){e.next=55;break}return e.next=52,this.payloadsByPreparingForServer(y);case 52:k=e.sent,e.next=56;break;case 55:k=y;case 56:e.next=59;break;case 58:w===Pl.DownloadFirst&&(k=[]);case 59:if(!g){e.next=65;break}return e.next=62,this.syncOnlineOperation(k,t.checkIntegrity,t.source,w);case 62:S=e.sent,e.next=68;break;case 65:return e.next=67,this.syncOfflineOperation(k,t.source,w);case 67:S=e.sent;case 68:return e.next=70,S.run();case 70:if(this.opStatus.setDidEnd(),a(),!this.opStatus.hasError()){e.next=74;break}return e.abrupt("return");case 74:if(this.opStatus.reset(),this.state.lastSyncDate=new Date,S instanceof $u&&S.numberOfItemsInvolved>=this.majorChangeThreshold&&this.notifyEvent(Ua.a.MajorDataChange),!(p.length>0)){e.next=80;break}return e.next=80,this.handleNeverSyncedDeleted(p);case 80:if(w===Pl.DownloadFirst){e.next=83;break}return e.next=83,this.notifyEvent(Ua.a.FullSyncCompleted,{source:t.source});case 83:if(w!==Pl.DownloadFirst){e.next=91;break}return g&&(this.completedOnlineDownloadFirstSync=!0),e.next=87,this.notifyEvent(Ua.a.DownloadFirstSyncCompleted);case 87:return e.next=89,this.sync({source:jl.AfterDownloadFirst,checkIntegrity:!0,awaitAll:t.awaitAll});case 89:e.next=117;break;case 91:if(this.popSpawnQueue()||!(this.resolveQueue.length>0)){e.next=99;break}if(this.log("Syncing again from resolve queue"),x=this.sync({source:jl.ResolveQueue,checkIntegrity:t.checkIntegrity}),!t.awaitAll){e.next=97;break}return e.next=97,x;case 97:e.next=117;break;case 99:return e.next=101,this.itemsNeedingSync();case 101:if(e.t0=e.sent.length,!(e.t0>0)){e.next=107;break}return e.next=105,this.sync({source:jl.MoreDirtyItems,checkIntegrity:t.checkIntegrity,awaitAll:t.awaitAll});case 105:e.next=117;break;case 107:if(!(S instanceof $u&&S.checkIntegrity)){e.next=116;break}if(!this.state.needsSync||!S.done){e.next=114;break}if(this.log("Syncing again from integrity check"),O=this.sync({checkIntegrity:!0,queueStrategy:Ol.ForceSpawnNew,source:jl.IntegrityCheck,awaitAll:t.awaitAll}),!t.awaitAll){e.next=114;break}return e.next=114,O;case 114:e.next=117;break;case 116:this.state.clearIntegrityHashes();case 117:P=hl(v);try{for(P.s();!(j=P.n()).done;)j.value.resolve()}catch(e){P.e(e)}finally{P.f()}case 119:case"end":return e.stop()}var i}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"syncOnlineOperation",value:(g=ml(i.a.mark((function e(t,n,r,a){var o,s=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Syncing online user","source:",r,"integrity check",n,"mode:",a,"payloads:",t),e.t0=$u,e.t1=t,e.t2=function(){var e=ml(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==Bu.Response){e.next=10;break}if(!n.hasError){e.next=6;break}return e.next=4,s.handleErrorServerResponse(n);case 4:e.next=8;break;case 6:return e.next=8,s.handleSuccessServerResponse(o,n);case 8:e.next=13;break;case 10:if(t!==Bu.StatusChanged){e.next=13;break}return e.next=13,s.handleStatusChange(o);case 13:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),e.next=6,this.getLastSyncToken();case 6:return e.t3=e.sent,e.next=9,this.getPaginationToken();case 9:return e.t4=e.sent,e.t5=n,e.t6=this.apiService,o=new e.t0(e.t1,e.t2,e.t3,e.t4,e.t5,e.t6),e.abrupt("return",o);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return g.apply(this,arguments)})},{key:"syncOfflineOperation",value:(b=ml(i.a.mark((function e(t,n,r){var a,o=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.log("Syncing offline user","source:",n,"mode:",r,"payloads:",t),a=new Xu(t,function(){var e=ml(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==Bu.Response){e.next=3;break}return e.next=3,o.handleOfflineResponse(n);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()),e.abrupt("return",a);case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return b.apply(this,arguments)})},{key:"handleStatusChange",value:(m=ml(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.pendingUploadCount(),r=t.totalUploadCount(),a=r-n,this.opStatus.setUploadStatus(a,r);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"handleOfflineResponse",value:(v=ml(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.log("Offline Sync Response",t.rawResponse),!((n=t.savedPayloads).length>0)){e.next=8;break}return e.next=5,this.modelManager.emitPayloads(n,D.a.LocalSaved);case 5:return r=this.modelManager.find(Object(s.b)(n)),e.next=8,this.persistPayloads(r);case 8:if(!((a=t.deletedPayloads).length>0)){e.next=12;break}return e.next=12,this.deletePayloads(a);case 12:return this.opStatus.clearError(),this.opStatus.setDownloadStatus(t.retrievedPayloads.length),e.next=16,this.notifyEvent(Ua.a.SingleSyncCompleted,t);case 16:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"handleErrorServerResponse",value:(h=ml(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.log("Sync Error",t),401===t.status&&this.notifyEvent(Ua.a.InvalidSession),this.opStatus.setError(t.error),this.notifyEvent(Ua.a.SyncError,t.error);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"handleSuccessServerResponse",value:(y=ml(i.a.mark((function e(t,n){var r,a,o,s,c,l,f,p,y,h,d,v,m,b;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._simulate_latency){e.next=3;break}return e.next=3,Object(u.E)(this._simulate_latency.latency);case 3:this.log("Online Sync Response",n.rawResponse),this.setLastSyncToken(n.lastSyncToken),this.setPaginationToken(n.paginationToken),this.opStatus.clearError(),this.opStatus.setDownloadStatus(n.retrievedPayloads.length),r=[],a=hl(n.allProcessedPayloads),e.prev=10,a.s();case 12:if((o=a.n()).done){e.next=22;break}if(!(s=o.value).deleted&&s.fields.includes(ua.a.Content)){e.next=16;break}return e.abrupt("continue",20);case 16:return e.next=18,this.protocolService.payloadByDecryptingPayload(s);case 18:c=e.sent,r.push(c);case 20:e.next=12;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e.catch(10),a.e(e.t0);case 27:return e.prev=27,a.f(),e.finish(27);case 30:return l=this.modelManager.getMasterCollection(),f=new Uu(n,r,l,t.payloadsSavedOrSaving),e.next=34,f.collectionsByProcessingResponse();case 34:p=e.sent,y=hl(p),e.prev=36,y.s();case 38:if((h=y.n()).done){e.next=47;break}return d=h.value,e.next=42,this.modelManager.emitCollection(d);case 42:return v=this.modelManager.find(d.uuids()),e.next=45,this.persistPayloads(v);case 45:e.next=38;break;case 47:e.next=52;break;case 49:e.prev=49,e.t1=e.catch(36),y.e(e.t1);case 52:return e.prev=52,y.f(),e.finish(52);case 55:if(!((m=n.deletedPayloads).length>0)){e.next=59;break}return e.next=59,this.deletePayloads(m);case 59:return e.next=61,this.notifyEvent(Ua.a.SingleSyncCompleted,n);case 61:if(!n.checkIntegrity){e.next=67;break}return e.next=64,this.computeDataIntegrityHash();case 64:return b=e.sent,e.next=67,this.state.setIntegrityHashes(b,n.integrityHash);case 67:case"end":return e.stop()}}),e,this,[[10,24,27,30],[36,49,52,55]])}))),function(e,t){return y.apply(this,arguments)})},{key:"handleNeverSyncedDeleted",value:(p=ml(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.map((function(e){return e.payloadRepresentation({dirty:!1})})),e.next=3,this.modelManager.emitPayloads(n,D.a.LocalChanged);case 3:return e.next=5,this.persistPayloads(n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"persistPayloads",value:(f=ml(i.a.mark((function e(t){var n=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return");case 2:return e.abrupt("return",this.storageService.savePayloads(t).catch((function(e){throw n.notifyEvent(Ua.a.DatabaseWriteError,e),e})));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"deletePayloads",value:(l=ml(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.persistPayloads(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"computeDataIntegrityHash",value:(c=ml(i.a.mark((function e(){var t,n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=this.itemManager.nonDeletedItems.sort((function(e,t){return t.updated_at.getTime()-e.updated_at.getTime()})),n=t.map((function(e){return e.updatedAtTimestamp()})),r=n.join(","),e.abrupt("return",this.protocolService.crypto.sha256(r));case 7:return e.prev=7,e.t0=e.catch(0),console.error("Error computing data integrity hash",e.t0),e.abrupt("return",void 0);case 11:case"end":return e.stop()}}),e,this,[[0,7]])}))),function(){return c.apply(this,arguments)})},{key:"resolveOutOfSync",value:(o=ml(i.a.mark((function e(){var t,n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Zc(this.apiService,this.protocolService,void 0,"resolve-out-of-sync"),e.next=3,t.run();case 3:return n=e.sent,r=new ul(this.modelManager.getMasterCollection(),Jr.WithPayloads(n,D.a.RemoteRetrieved)),e.next=7,r.resultingCollection();case 7:return a=e.sent,e.next=10,this.modelManager.emitCollection(a);case 10:return e.next=12,this.persistPayloads(a.payloads);case 12:return e.abrupt("return",this.sync({checkIntegrity:!0,source:jl.ResolveOutOfSync}));case 13:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"statelessDownloadAllItems",value:(a=ml(i.a.mark((function e(t,n){var r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new Zc(this.apiService,this.protocolService,t,n),e.next=3,r.run();case 3:return a=e.sent,e.abrupt("return",a.map((function(e){return Ut(e)})));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"ut_setDatabaseLoaded",value:function(e){this.databaseLoaded=e}},{key:"ut_clearLastSyncDate",value:function(){this.state.lastSyncDate=void 0}},{key:"ut_beginLatencySimulator",value:function(e){this._simulate_latency={latency:e||1e3,enabled:!0}}},{key:"ut_endLatencySimulator",value:function(){this._simulate_latency=null}}])&&bl(t.prototype,n),r&&bl(t,r),V}(Gt.a);function Cl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Il=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.challenge=t,this.resolve=n,this.validValues=[],this.invalidValues=[],this.artifacts={}}var t,n,r;return t=e,(n=[{key:"complete",value:function(e){var t,n;e||(e=new k(this.challenge,this.validValues,this.artifacts)),null===(t=this.resolve)||void 0===t||t.call(this,e),null===(n=this.onComplete)||void 0===n||n.call(this)}},{key:"cancel",value:function(){var e,t;null===(e=this.resolve)||void 0===e||e.call(this,null),null===(t=this.onCancel)||void 0===t||t.call(this)}},{key:"isFinished",value:function(){return this.validValues.length===this.challenge.types.length}},{key:"setValueStatus",value:function(e,t,n){var r,a,o=t?this.validValues:this.invalidValues,i=o.find((function(t){return t.type===e.type}));i&&Object(u.B)(o,i),o.push(e),Object.assign(this.artifacts,n),this.isFinished()?this.complete():t?null===(r=this.onValidValue)||void 0===r||r.call(this,e):null===(a=this.onInvalidValue)||void 0===a||a.call(this,e)}}])&&Cl(t.prototype,n),r&&Cl(t,r),e}();function _l(e){return(_l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Rl(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return El(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return El(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function El(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function Al(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ml(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){Al(o,r,a,i,s,"next",e)}function s(e){Al(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Tl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Kl(e,t,n){return(Kl="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Nl(e)););return e}(e,t);if(r){var a=Object.getOwnPropertyDescriptor(r,t);return a.get?a.get.call(n):a.value}})(e,t,n||e)}function Fl(e,t){return(Fl=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ll(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Nl(e);if(t){var a=Nl(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return Vl(this,n)}}function Vl(e,t){return!t||"object"!==_l(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Nl(e){return(Nl=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var Ul=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Fl(e,t)}(f,e);var t,n,r,a,o,s,c,u,l=Ll(f);function f(e,t){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,f),(n=l.call(this)).challengeOperations={},n.storageService=e,n.protocolService=t,n}return t=f,(n=[{key:"deinit",value:function(){this.storageService=void 0,this.protocolService=void 0,this.sendChallenge=void 0,Kl(Nl(f.prototype),"deinit",this).call(this)}},{key:"promptForChallengeResponse",value:function(e){var t=this;return new Promise((function(n){t.createOrGetChallengeOperation(e,n)}))}},{key:"promptForChallengeResponseWithCustomValidation",value:function(e){var t=this.createOrGetChallengeOperation(e);return new Promise((function(e){t.customValidator=e}))}},{key:"validateChallengeValue",value:function(e){switch(e.type){case p.LocalPasscode:return this.protocolService.validatePasscode(e.value);case p.AccountPassword:return this.protocolService.validateAccountPassword(e.value);case p.Biometric:return Promise.resolve({valid:!0===e.value})}}},{key:"getLaunchChallenge",value:(u=Ml(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],this.protocolService.hasPasscode()&&t.push(p.LocalPasscode),e.next=5,this.hasBiometricsEnabled();case 5:if(e.sent&&t.push(p.Biometric),!(t.length>0)){e.next=11;break}return e.abrupt("return",new g(t,y.ApplicationUnlock));case 11:return e.abrupt("return",null);case 12:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"isPasscodeLocked",value:function(){return this.protocolService.rootKeyNeedsUnwrapping()}},{key:"hasBiometricsEnabled",value:(c=Ml(i.a.mark((function e(){var t;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.getValue(Vt.BiometricsState,zt.Nonwrapped);case 2:return t=e.sent,e.abrupt("return",Boolean(t));case 4:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"enableBiometrics",value:(s=Ml(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setValue(Vt.BiometricsState,!0,zt.Nonwrapped);case 2:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"disableBiometrics",value:(o=Ml(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setValue(Vt.BiometricsState,!1,zt.Nonwrapped);case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"setChallengeCallbacks",value:function(e,t,n,r,a){var o=this.getChallengeOperation(e);o.onValidValue=t,o.onInvalidValue=n,o.onComplete=r,o.onCancel=a}},{key:"createOrGetChallengeOperation",value:function(e,t){var n=this.getChallengeOperation(e);return n||(n=new Il(e,t),this.challengeOperations[e.id]=n,this.sendChallenge(e)),n.resolve=t,n}},{key:"getChallengeOperation",value:function(e){return this.challengeOperations[e.id]}},{key:"deleteChallengeOperation",value:function(e){delete this.challengeOperations[e.challenge.id]}},{key:"cancelChallenge",value:function(e){var t=this.challengeOperations[e.id];t.cancel(),this.deleteChallengeOperation(t)}},{key:"submitValuesForChallenge",value:(a=Ml(i.a.mark((function e(t,n){var r,a,o,s,c,u,l;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}throw Error("Attempting to submit 0 values for challenge");case 2:if(!(r=this.getChallengeOperation(t)).customValidator){e.next=7;break}r.customValidator(n),e.next=28;break;case 7:a=Rl(n),e.prev=8,a.s();case 10:if((o=a.n()).done){e.next=20;break}return s=o.value,e.next=14,this.validateChallengeValue(s);case 14:c=e.sent,u=c.valid,l=c.artifacts,this.setValidationStatusForChallenge(t,s,u,l);case 18:e.next=10;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(8),a.e(e.t0);case 25:return e.prev=25,a.f(),e.finish(25);case 28:case"end":return e.stop()}}),e,this,[[8,22,25,28]])}))),function(e,t){return a.apply(this,arguments)})},{key:"setValidationStatusForChallenge",value:function(e,t,n,r){var a=this.getChallengeOperation(e);a.setValueStatus(t,n,r),a.isFinished()&&this.deleteChallengeOperation(a)}}])&&Tl(t.prototype,n),r&&Tl(t,r),f}(Gt.a);function Wl(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(e)))return;var n=[],r=!0,a=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done)&&(n.push(i.value),!t||n.length!==t);r=!0);}catch(e){a=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n}(e,t)||Jl(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Bl(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Hl(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Bl(Object(n),!0).forEach((function(t){zl(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Bl(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function zl(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ql(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=Jl(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,o=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw o}}}}function Jl(e,t){if(e){if("string"==typeof e)return Gl(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Gl(e,t):void 0}}function Gl(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function $l(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function Ql(e){return function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){$l(o,r,a,i,s,"next",e)}function s(e){$l(o,r,a,i,s,"throw",e)}i(void 0)}))}}function Yl(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var Xl=function(){function e(t,n,r,a,o,i,s,c){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.eventHandlers=[],this.services=[],this.streamRemovers=[],this.serviceObservers=[],this.managedSubscribers=[],this.createdNewDatabase=!1,this.started=!1,this.launched=!1,this.dealloced=!1,!r)throw Error("Device Interface must be supplied.");if(!t)throw Error("Environment must be supplied when creating an application.");if(!n)throw Error("Platform must be supplied when creating an application.");if(!a)throw Error("Crypto has to be supplied when creating an application.");if(!o)throw Error("AlertService must be supplied when creating an application.");this.environment=t,this.platform=n,this.namespace=i||"",this.deviceInterface=r,this.crypto=a,this.alertService=o,this.swapClasses=s,this.skipClasses=c,this.constructServices()}var t,n,r,o,l,f,v,m,b,w,k,S,x,O,C,I,_,R,E,A,M,T,K,F,L,V,N,U,W,B,H,z,q,J,G,$,Q,Y,X,Z,ee,te,ne,re,ae,oe,ie,se,ce,ue,le,fe,pe,ye,he,de,ve;return t=e,(n=[{key:"prepareForLaunch",value:(ve=Ql(i.a.mark((function e(t){var n,r=this;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.setLaunchCallback(t),e.next=3,this.deviceInterface.openDatabase().catch((function(e){r.notifyEvent(c.a.LocalDatabaseReadError,e)}));case 3:return n=e.sent,this.createdNewDatabase=(null==n?void 0:n.isNewDatabase)||!1,e.next=7,this.migrationService.initialize();case 7:return e.next=9,this.handleStage(a.PreparingForLaunch_0);case 9:return e.next=11,this.storageService.initializeFromDisk();case 11:return e.next=13,this.protocolService.initialize();case 13:return e.next=15,this.handleStage(a.ReadyForLaunch_05);case 15:return this.started=!0,e.next=18,this.notifyEvent(c.a.Started);case 18:case"end":return e.stop()}}),e,this)}))),function(e){return ve.apply(this,arguments)})},{key:"setLaunchCallback",value:function(e){this.challengeService.sendChallenge=e.receiveChallenge}},{key:"launch",value:(de=Ql(i.a.mark((function e(){var t,n,r,o,s,u=this,l=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=l.length>0&&void 0!==l[0]&&l[0],this.launched=!1,e.next=4,this.challengeService.getLaunchChallenge();case 4:if(!(n=e.sent)){e.next=13;break}return e.next=8,this.challengeService.promptForChallengeResponse(n);case 8:if(r=e.sent){e.next=11;break}throw Error("Launch challenge was cancelled.");case 11:return e.next=13,this.handleLaunchChallengeResponse(r);case 13:if(!this.storageService.isStorageWrapped()){e.next=16;break}return e.next=16,this.storageService.decryptStorage();case 16:return e.next=18,this.handleStage(a.StorageDecrypted_09);case 18:return e.next=20,this.apiService.loadHost();case 20:return e.next=22,this.sessionManager.initializeFromDisk();case 22:return this.historyManager.initializeFromDisk(),this.launched=!0,e.next=26,this.notifyEvent(c.a.Launched);case 26:return e.next=28,this.handleStage(a.Launched_10);case 28:return e.next=30,this.syncService.getDatabasePayloads();case 30:return o=e.sent,e.next=33,this.handleStage(a.LoadingDatabase_11);case 33:if(!this.createdNewDatabase){e.next=36;break}return e.next=36,this.syncService.onNewDatabaseCreated();case 36:if(s=this.syncService.loadDatabasePayloads(o).then(Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!u.dealloced){e.next=2;break}throw"Application has been destroyed.";case 2:return e.next=4,u.handleStage(a.LoadedDatabase_12);case 4:return u.beginAutoSyncTimer(),e.abrupt("return",u.syncService.sync({mode:Pl.DownloadFirst}));case 6:case"end":return e.stop()}}),e)})))),!t){e.next=40;break}return e.next=40,s;case 40:case"end":return e.stop()}}),e,this)}))),function(){return de.apply(this,arguments)})},{key:"handleLaunchChallengeResponse",value:(he=Ql(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.challenge.types.includes(p.LocalPasscode)){e.next=9;break}if(n=t.artifacts.wrappingKey){e.next=7;break}return r=t.getValueForType(p.LocalPasscode),e.next=6,this.protocolService.computeWrappingKey(r.value);case 6:n=e.sent;case 7:return e.next=9,this.protocolService.unwrapRootKey(n);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return he.apply(this,arguments)})},{key:"beginAutoSyncTimer",value:function(){var e=this;this.autoSyncInterval=this.deviceInterface.interval((function(){e.syncService.log("Syncing from autosync"),e.sync()}),3e4)}},{key:"handleStage",value:(ye=Ql(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=ql(this.services),e.prev=1,n.s();case 3:if((r=n.n()).done){e.next=9;break}return a=r.value,e.next=7,a.handleApplicationStage(t);case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),n.e(e.t0);case 14:return e.prev=14,n.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))),function(e){return ye.apply(this,arguments)})},{key:"addEventObserver",value:function(e,t){var n=this,r={callback:e,singleEvent:t};return this.eventHandlers.push(r),function(){Object(u.B)(n.eventHandlers,r)}}},{key:"addSingleEventObserver",value:function(e,t){var n=function(){var n=Ql(i.a.mark((function n(r){return i.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r===e&&t(e);case 1:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}();return this.addEventObserver(n,e)}},{key:"notifyEvent",value:(pe=Ql(i.a.mark((function e(t,n){var r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=ql(this.eventHandlers.slice()),e.prev=1,r.s();case 3:if((a=r.n()).done){e.next=15;break}if(!(o=a.value).singleEvent||o.singleEvent!==t){e.next=10;break}return e.next=8,o.callback(t,n||{});case 8:e.next=13;break;case 10:if(o.singleEvent){e.next=13;break}return e.next=13,o.callback(t,n||{});case 13:e.next=3;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(1),r.e(e.t0);case 20:return e.prev=20,r.f(),e.finish(20);case 23:this.migrationService.handleApplicationEvent(t);case 24:case"end":return e.stop()}}),e,this,[[1,17,20,23]])}))),function(e,t){return pe.apply(this,arguments)})},{key:"isDatabaseLoaded",value:function(){return this.syncService.isDatabaseLoaded()}},{key:"savePayload",value:(fe=Ql(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(j.b)(t,{dirty:!0,dirtiedDate:new Date}),e.next=3,this.modelManager.emitPayload(n,D.a.LocalChanged);case 3:return e.next=5,this.syncService.sync();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return fe.apply(this,arguments)})},{key:"findItem",value:function(e){return this.itemManager.findItem(e)}},{key:"allItems",value:function(){return this.itemManager.items}},{key:"findItems",value:function(e){return this.itemManager.itemsMatchingPredicate(e)}},{key:"getAll",value:function(e){return this.itemManager.findItems(e)}},{key:"mergeItem",value:(le=Ql(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.emitItemFromPayload(t.payloadRepresentation(),n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return le.apply(this,arguments)})},{key:"createManagedItem",value:(ue=Ql(i.a.mark((function e(t,n){var r,a,o,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,e.next=4,this.itemManager.createItem(t,n,r,a);case 4:return o=e.sent,e.abrupt("return",o);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return ue.apply(this,arguments)})},{key:"createTemplateItem",value:(ce=Ql(i.a.mark((function e(t,n){var r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.createTemplateItem(t,n);case 2:return r=e.sent,e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return ce.apply(this,arguments)})},{key:"createItemFromPayload",value:function(e){return Ut(e)}},{key:"createPayloadFromObject",value:function(e){return Object(j.e)(e)}},{key:"getLastSyncDate",value:function(){return this.syncService.getLastSyncDate()}},{key:"getSyncStatus",value:function(){return this.syncService.getStatus()}},{key:"setItemNeedsSync",value:(se=Ql(i.a.mark((function e(t){var n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],e.abrupt("return",this.itemManager.setItemDirty(t.uuid,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return se.apply(this,arguments)})},{key:"setItemsNeedsSync",value:(ie=Ql(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.setItemsDirty(Object(s.b)(t)));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return ie.apply(this,arguments)})},{key:"deleteItem",value:(oe=Ql(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.setItemToBeDeleted(t.uuid);case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return oe.apply(this,arguments)})},{key:"deleteItemLocally",value:(ae=Ql(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.itemManager.removeItemLocally(t);case 1:case"end":return e.stop()}}),e,this)}))),function(e){return ae.apply(this,arguments)})},{key:"emptyTrash",value:(re=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.emptyTrash();case 2:return e.abrupt("return",this.sync());case 3:case"end":return e.stop()}}),e,this)}))),function(){return re.apply(this,arguments)})},{key:"getTrashedItems",value:function(){return this.itemManager.trashedItems}},{key:"setDisplayOptions",value:function(e,t,n,r){this.itemManager.setDisplayOptions(e,t,n,r)}},{key:"getDisplayableItems",value:function(e){return this.itemManager.getDisplayableItems(e)}},{key:"insertItem",value:(ne=Ql(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.itemManager.insertItem(t);case 2:return n=e.sent,e.next=5,this.itemManager.changeItems([n.uuid]);case 5:return e.abrupt("return",this.findItem(t.uuid));case 6:case"end":return e.stop()}}),e,this)}))),function(e){return ne.apply(this,arguments)})},{key:"saveItem",value:(te=Ql(i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.itemManager.findItem(t)){e.next=3;break}throw Error("Attempting to save non-inserted item");case 3:if(n.dirty){e.next=6;break}return e.next=6,this.itemManager.changeItem(t);case 6:return e.next=8,this.syncService.sync();case 8:case"end":return e.stop()}}),e,this)}))),function(e){return te.apply(this,arguments)})},{key:"changeAndSaveItem",value:(ee=Ql(i.a.mark((function e(t,n){var r,a,o,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,o=s.length>4?s[4]:void 0,Object(u.s)(t)){e.next=5;break}throw Error("Must use uuid to change item");case 5:return e.next=7,this.itemManager.changeItems([t],n,r?d.c.UserInteraction:void 0,a);case 7:return e.next=9,this.syncService.sync(o);case 9:return e.abrupt("return",this.findItem(t));case 10:case"end":return e.stop()}}),e,this)}))),function(e,t){return ee.apply(this,arguments)})},{key:"changeAndSaveItems",value:(Z=Ql(i.a.mark((function e(t,n){var r,a,o,s=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=s.length>2&&void 0!==s[2]&&s[2],a=s.length>3?s[3]:void 0,o=s.length>4?s[4]:void 0,e.next=5,this.itemManager.changeItems(t,n,r?d.c.UserInteraction:void 0,a);case 5:return e.next=7,this.syncService.sync(o);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return Z.apply(this,arguments)})},{key:"changeItem",value:(X=Ql(i.a.mark((function e(t,n){var r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.length>2&&void 0!==a[2]&&a[2],Object(u.s)(t)){e.next=3;break}throw Error("Must use uuid to change item");case 3:return e.next=5,this.itemManager.changeItems([t],n,r?d.c.UserInteraction:void 0);case 5:return e.abrupt("return",this.findItem(t));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return X.apply(this,arguments)})},{key:"changeItems",value:(Y=Ql(i.a.mark((function e(t,n){var r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]&&a[2],e.abrupt("return",this.itemManager.changeItems(t,n,r?d.c.UserInteraction:void 0));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return Y.apply(this,arguments)})},{key:"getItems",value:function(e){return this.itemManager.getItems(e)}},{key:"notesMatchingSmartTag",value:function(e){return this.itemManager.notesMatchingSmartTag(e)}},{key:"referencesForItem",value:function(e,t){var n=this.itemManager.referencesForItem(e.uuid);return t&&(n=n.filter((function(e){return(null==e?void 0:e.content_type)===t}))),n}},{key:"referencingForItem",value:function(e,t){var n=this.itemManager.itemsReferencingItem(e.uuid);return t&&(n=n.filter((function(e){return(null==e?void 0:e.content_type)===t}))),n}},{key:"findTagByTitle",value:function(e){return this.itemManager.findTagByTitle(e)}},{key:"findOrCreateTag",value:(Q=Ql(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.itemManager.findOrCreateTagByTitle(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return Q.apply(this,arguments)})},{key:"getSmartTags",value:function(){return this.itemManager.getSmartTags()}},{key:"getNoteCount",value:function(){return this.itemManager.noteCount}},{key:"streamItems",value:function(e,t){var n=this,r=this.itemManager.addObserver(e,(function(e,n,r,a){var o=e.concat(n).concat(r);t(o,a)})),a=this.itemManager.getItems(e);return a.length>0&&t(a),this.streamRemovers.push(r),function(){r(),Object(u.B)(n.streamRemovers,r)}}},{key:"setHost",value:($=Ql(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.setHost(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return $.apply(this,arguments)})},{key:"getHost",value:(G=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.apiService.getHost());case 1:case"end":return e.stop()}}),e,this)}))),function(){return G.apply(this,arguments)})},{key:"getUser",value:function(){if(!this.launched)throw"Attempting to access user before application unlocked";return this.sessionManager.getUser()}},{key:"getProtocolEncryptionDisplayName",value:function(){return this.protocolService.getDefaultOperatorEncryptionDisplayName()}},{key:"getUserVersion",value:(J=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.getUserVersion());case 1:case"end":return e.stop()}}),e,this)}))),function(){return J.apply(this,arguments)})},{key:"protocolUpgradeAvailable",value:(q=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.protocolService.upgradeAvailable());case 1:case"end":return e.stop()}}),e,this)}))),function(){return q.apply(this,arguments)})},{key:"isEncryptionAvailable",value:(z=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!Object(u.p)(this.getUser())||this.hasPasscode());case 1:case"end":return e.stop()}}),e,this)}))),function(){return z.apply(this,arguments)})},{key:"upgradeProtocolVersion",value:(H=Ql(i.a.mark((function e(){var t,n,r,a,o,s,c,u,l,f,h;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.hasPasscode(),n=!this.noAccount(),r=[],t&&r.push(p.LocalPasscode),n&&r.push(p.AccountPassword),a=new g(r,y.ProtocolUpgrade),e.next=8,this.challengeService.promptForChallengeResponse(a);case 8:if(o=e.sent){e.next=11;break}return e.abrupt("return",{canceled:!0});case 11:if(s=this.alertService.blockingDialog("Your account's encryption version is being upgraded. Do not close the application until this process completes."),e.prev=12,t&&(u=o.getValueForType(p.LocalPasscode),c=u.value),!n){e.next=22;break}return l=o.getValueForType(p.AccountPassword),f=l.value,e.next=19,this.changePassword(f,f,c,{validatePasswordStrength:!1});case 19:if(!(null==(h=e.sent)?void 0:h.error)){e.next=22;break}return e.abrupt("return",{error:h.error});case 22:if(!c){e.next=25;break}return e.next=25,this.changePasscode(c);case 25:return e.abrupt("return",{success:!0});case 28:return e.prev=28,e.t0=e.catch(12),e.abrupt("return",{error:e.t0});case 31:return e.prev=31,s(),e.finish(31);case 34:case"end":return e.stop()}}),e,this,[[12,28,31,34]])}))),function(){return H.apply(this,arguments)})},{key:"noAccount",value:function(){return!this.hasAccount()}},{key:"hasAccount",value:function(){return this.protocolService.hasAccount()}},{key:"importData",value:(B=Ql(i.a.mark((function e(t,n){var r,a,o,s,c,u,l=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=l.length>2&&void 0!==l[2]&&l[2],e.next=3,this.protocolService.payloadsByDecryptingBackupFile(t,n);case 3:return a=e.sent,o=a.filter((function(e){return!e.errorDecrypting})).map((function(e){return e.content_type===P.a.Component&&e.safeContent.active?Object(j.b)(e,{content:Hl(Hl({},e.safeContent),{},{active:!1})}):e})),e.next=7,this.modelManager.importPayloads(o);case 7:if(s=e.sent,c=this.sync(),!r){e.next=12;break}return e.next=12,c;case 12:return u=this.getAll(s),e.abrupt("return",{affectedItems:u,errorCount:a.length-o.length});case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return B.apply(this,arguments)})},{key:"createBackupFile",value:(W=Ql(i.a.mark((function e(t,n){var r,a=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>2&&void 0!==a[2]&&a[2],e.abrupt("return",this.protocolService.createBackupFile(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return W.apply(this,arguments)})},{key:"isEphemeralSession",value:function(){return this.storageService.isEphemeralSession()}},{key:"lockSyncing",value:function(){this.syncService.lockSyncing()}},{key:"unlockSyncing",value:function(){this.syncService.unlockSyncing()}},{key:"sync",value:(U=Ql(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.sync(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return U.apply(this,arguments)})},{key:"isOutOfSync",value:(N=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.isOutOfSync());case 1:case"end":return e.stop()}}),e,this)}))),function(){return N.apply(this,arguments)})},{key:"resolveOutOfSync",value:(V=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.syncService.resolveOutOfSync());case 1:case"end":return e.stop()}}),e,this)}))),function(){return V.apply(this,arguments)})},{key:"setValue",value:(L=Ql(i.a.mark((function e(t,n,r){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.setValue(t,n,r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return L.apply(this,arguments)})},{key:"getValue",value:(F=Ql(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.getValue(t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return F.apply(this,arguments)})},{key:"removeValue",value:(K=Ql(i.a.mark((function e(t,n){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.removeValue(t,n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return K.apply(this,arguments)})},{key:"clearDatabase",value:(T=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.storageService.clearAllPayloads());case 1:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"rewriteItemsKeys",value:(M=Ql(i.a.mark((function e(){var t,n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.itemManager.itemsKeys(),n=t.map((function(e){return e.payloadRepresentation()})),e.next=4,this.storageService.deletePayloads(n);case 4:return e.next=6,this.syncService.persistPayloads(n);case 6:case"end":return e.stop()}}),e,this)}))),function(){return M.apply(this,arguments)})},{key:"prepareForDeinit",value:(A=Ql(i.a.mark((function e(){var t,n,r=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.length>0&&void 0!==r[0]?r[0]:0,n=Promise.all(this.services.map((function(e){return e.blockDeinit()}))),0!==t){e.next=7;break}return e.next=5,n;case 5:e.next=9;break;case 7:return e.next=9,Promise.race([n,Object(u.E)(t)]);case 9:case"end":return e.stop()}}),e,this)}))),function(){return A.apply(this,arguments)})},{key:"promptForCustomChallenge",value:function(e){var t;return null===(t=this.challengeService)||void 0===t?void 0:t.promptForChallengeResponse(e)}},{key:"setChallengeCallbacks",value:function(e){var t=e.challenge,n=e.onValidValue,r=e.onInvalidValue,a=e.onComplete,o=e.onCancel;return this.challengeService.setChallengeCallbacks(t,n,r,a,o)}},{key:"submitValuesForChallenge",value:function(e,t){return this.challengeService.submitValuesForChallenge(e,t)}},{key:"cancelChallenge",value:function(e){this.challengeService.cancelChallenge(e)}},{key:"deinit",value:function(){clearInterval(this.autoSyncInterval);var e,t=ql(this.serviceObservers);try{for(t.s();!(e=t.n()).done;)(0,e.value)()}catch(e){t.e(e)}finally{t.f()}var n,r=ql(this.managedSubscribers);try{for(r.s();!(n=r.n()).done;)(0,n.value)()}catch(e){r.e(e)}finally{r.f()}var a,o=ql(this.services);try{for(o.s();!(a=o.n()).done;)a.value.deinit()}catch(e){o.e(e)}finally{o.f()}this.deviceInterface.deinit(),this.deviceInterface=void 0,this.crypto=void 0,this.createdNewDatabase=!1,this.services.length=0,this.serviceObservers.length=0,this.managedSubscribers.length=0,this.streamRemovers.length=0,this.clearServices(),this.dealloced=!0,this.started=!1}},{key:"getWrappingKeyIfNecessary",value:(E=Ql(i.a.mark((function e(t){var n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPasscode()){e.next=2;break}return e.abrupt("return",{});case 2:if(t){e.next=11;break}return n=new g([p.LocalPasscode],y.ResaveRootKey),e.next=6,this.challengeService.promptForChallengeResponse(n);case 6:if(r=e.sent){e.next=9;break}return e.abrupt("return",{canceled:!0});case 9:a=r.getValueForType(p.LocalPasscode),t=a.value;case 11:return e.next=13,this.protocolService.computeWrappingKey(t);case 13:return o=e.sent,e.abrupt("return",{wrappingKey:o});case 15:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"register",value:(R=Ql(i.a.mark((function e(t,n){var r,a,o,s,u,l=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=l.length>2&&void 0!==l[2]&&l[2],a=!(l.length>3&&void 0!==l[3])||l[3],e.next=4,this.getWrappingKeyIfNecessary();case 4:if(o=e.sent,s=o.wrappingKey,!o.canceled){e.next=9;break}return e.abrupt("return");case 9:return this.lockSyncing(),e.next=12,this.sessionManager.register(t,n);case 12:if((u=e.sent).response.error){e.next=35;break}return e.next=16,this.protocolService.setNewRootKey(u.rootKey,u.keyParams,s);case 16:return this.syncService.resetSyncState(),e.next=19,this.storageService.setPersistencePolicy(r?Bt.Ephemeral:Bt.Default);case 19:if(!a){e.next=24;break}return e.next=22,this.syncService.markAllItemsAsNeedingSync(!0);case 22:e.next=27;break;case 24:return this.itemManager.removeAllItemsFromMemory(),e.next=27,this.clearDatabase();case 27:return e.next=29,this.notifyEvent(c.a.SignedIn);case 29:return this.unlockSyncing(),e.next=32,this.syncService.downloadFirstSync(300);case 32:this.protocolService.decryptErroredItems(),e.next=36;break;case 35:this.unlockSyncing();case 36:return e.abrupt("return",u.response);case 37:case"end":return e.stop()}}),e,this)}))),function(e,t){return R.apply(this,arguments)})},{key:"signIn",value:(_=Ql(i.a.mark((function e(t,n){var r,a,o,s,u,l,f,p,y,h,d=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=d.length>2&&void 0!==d[2]&&d[2],a=d.length>3&&void 0!==d[3]&&d[3],o=d.length>4?d[4]:void 0,s=d.length>5?d[5]:void 0,u=!(d.length>6&&void 0!==d[6])||d[6],l=d.length>7&&void 0!==d[7]&&d[7],e.next=8,this.getWrappingKeyIfNecessary();case 8:if(f=e.sent,p=f.wrappingKey,!f.canceled){e.next=13;break}return e.abrupt("return");case 13:return this.lockSyncing(),e.next=16,this.sessionManager.signIn(t,n,r,o,s);case 16:if((y=e.sent).response.error){e.next=45;break}return e.next=20,this.protocolService.setNewRootKey(y.rootKey,y.keyParams,p);case 20:return this.syncService.resetSyncState(),e.next=23,this.storageService.setPersistencePolicy(a?Bt.Ephemeral:Bt.Default);case 23:if(!u){e.next=28;break}return e.next=26,this.syncService.markAllItemsAsNeedingSync(!0);case 26:e.next=31;break;case 28:return this.itemManager.removeAllItemsFromMemory(),e.next=31,this.clearDatabase();case 31:return e.next=33,this.notifyEvent(c.a.SignedIn);case 33:if(this.unlockSyncing(),h=this.syncService.downloadFirstSync(1e3,{checkIntegrity:!0,awaitAll:l}),!l){e.next=42;break}return e.next=38,h;case 38:return e.next=40,this.protocolService.decryptErroredItems();case 40:e.next=43;break;case 42:this.protocolService.decryptErroredItems();case 43:e.next=46;break;case 45:this.unlockSyncing();case 46:return e.abrupt("return",y.response);case 47:case"end":return e.stop()}}),e,this)}))),function(e,t){return _.apply(this,arguments)})},{key:"changePassword",value:(I=Ql(i.a.mark((function e(t,n,r){var a,o,s,c,u,l,f,p,y,h,d,v,m,b=arguments;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=b.length>3&&void 0!==b[3]?b[3]:{},void 0!==(o=a.validatePasswordStrength)&&!o){e.next=4;break}if(!(n.length<8)){e.next=4;break}return e.abrupt("return",{error:Error(bn(8))});case 4:return e.next=6,this.getWrappingKeyIfNecessary(r);case 6:if(s=e.sent,c=s.wrappingKey,!s.canceled){e.next=11;break}return e.abrupt("return",{});case 11:return e.next=13,this.protocolService.changePassword(this.getUser().email,t,n,c);case 13:if(u=e.sent,l=Wl(u,2),f=l[0],p=l[1],!f){e.next=19;break}return e.abrupt("return",{error:f});case 19:return y=p.currentServerPassword,h=p.newRootKey,d=p.newKeyParams,v=p.rollback,e.next=22,this.syncService.sync({awaitAll:!0});case 22:if(this.protocolService.getDefaultItemsKey().updated_at.getTime()>0){e.next=29;break}return e.next=26,v();case 26:return e.next=28,this.syncService.sync({awaitAll:!0});case 28:return e.abrupt("return",{error:Error("Could not connect to server.")});case 29:return this.lockSyncing(),e.next=32,this.sessionManager.changePassword(y,h.serverPassword,d);case 32:if(!(m=e.sent).error){e.next=38;break}return e.next=36,v();case 36:return e.next=38,this.syncService.sync({awaitAll:!0});case 38:return this.unlockSyncing(),e.abrupt("return",m);case 40:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return I.apply(this,arguments)})},{key:"signOut",value:(C=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionManager.signOut();case 2:return e.next=4,this.protocolService.clearLocalKeyState();case 4:return e.next=6,this.storageService.clearAllData();case 6:return e.next=8,this.notifyEvent(c.a.SignedOut);case 8:return e.next=10,this.prepareForDeinit();case 10:this.deinit();case 11:case"end":return e.stop()}}),e,this)}))),function(){return C.apply(this,arguments)})},{key:"validateAccountPassword",value:(O=Ql(i.a.mark((function e(t){var n,r;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.validateAccountPassword(t);case 2:return n=e.sent,r=n.valid,e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return O.apply(this,arguments)})},{key:"isStarted",value:function(){return this.started}},{key:"isLaunched",value:function(){return this.launched}},{key:"hasBiometrics",value:(x=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeService.hasBiometricsEnabled());case 1:case"end":return e.stop()}}),e,this)}))),function(){return x.apply(this,arguments)})},{key:"enableBiometrics",value:(S=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeService.enableBiometrics());case 1:case"end":return e.stop()}}),e,this)}))),function(){return S.apply(this,arguments)})},{key:"disableBiometrics",value:(k=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.challengeService.disableBiometrics());case 1:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"hasPasscode",value:function(){return this.protocolService.hasPasscode()}},{key:"isLocked",value:(w=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.started){e.next=2;break}return e.abrupt("return",!0);case 2:return e.abrupt("return",this.challengeService.isPasscodeLocked());case 3:case"end":return e.stop()}}),e,this)}))),function(){return w.apply(this,arguments)})},{key:"lock",value:(b=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,this.prepareForDeinit(500);case 3:return e.abrupt("return",this.deinit());case 4:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"setPasscode",value:(m=Ql(i.a.mark((function e(t){var n,r,a,o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.generateUuid();case 2:return n=e.sent,e.next=5,this.protocolService.createRootKey(n,t);case 5:return r=e.sent,a=r.key,o=r.keyParams,e.next=10,this.protocolService.setNewRootKeyWrapper(a,o);case 10:return e.next=12,this.rewriteItemsKeys();case 12:return e.next=14,this.syncService.sync();case 14:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"removePasscode",value:(v=Ql(i.a.mark((function e(){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.protocolService.removeRootKeyWrapper();case 2:return e.next=4,this.rewriteItemsKeys();case 4:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"changePasscode",value:(f=Ql(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.removePasscode();case 2:return e.abrupt("return",this.setPasscode(t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"getStorageEncryptionPolicy",value:function(){return this.storageService.getStorageEncryptionPolicy()}},{key:"setStorageEncryptionPolicy",value:(l=Ql(i.a.mark((function e(t){return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.storageService.setEncryptionPolicy(t);case 2:return e.abrupt("return",this.protocolService.repersistAllItems());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"generateUuid",value:function(){return h.GenerateUuid()}},{key:"changeDeviceInterface",value:(o=Ql(i.a.mark((function e(t){var n,r,a;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.deviceInterface=t,n=ql(this.services);try{for(n.s();!(r=n.n()).done;)(a=r.value).deviceInterface&&(a.deviceInterface=t)}catch(e){n.e(e)}finally{n.f()}case 3:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"constructServices",value:function(){this.createModelManager(),this.createItemManager(),this.createStorageManager(),this.createProtocolService();var e={payloadByEncryptingPayload:this.protocolService.payloadByEncryptingPayload.bind(this.protocolService),payloadByDecryptingPayload:this.protocolService.payloadByDecryptingPayload.bind(this.protocolService)};this.storageService.encryptionDelegate=e,this.createChallengeService(),this.createMigrationService(),this.createHttpManager(),this.createApiService(),this.createSessionManager(),this.createSyncManager(),this.createSingletonManager(),this.createComponentManager(),this.createPrivilegesService(),this.createHistoryManager(),this.createActionsManager()}},{key:"clearServices",value:function(){this.migrationService=void 0,this.alertService=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.sessionManager=void 0,this.syncService=void 0,this.challengeService=void 0,this.singletonManager=void 0,this.componentManager=void 0,this.privilegesService=void 0,this.actionsManager=void 0,this.historyManager=void 0,this.itemManager=void 0,this.services=[]}},{key:"createMigrationService",value:function(){this.migrationService=new ui({protocolService:this.protocolService,deviceInterface:this.deviceInterface,storageService:this.storageService,challengeService:this.challengeService,itemManager:this.itemManager,environment:this.environment,namespace:this.namespace}),this.services.push(this.migrationService)}},{key:"createApiService",value:function(){this.apiService=new nr(this.httpService,this.storageService),this.services.push(this.apiService)}},{key:"createItemManager",value:function(){this.itemManager=new Hc(this.modelManager),this.services.push(this.itemManager)}},{key:"createComponentManager",value:function(){if(!this.shouldSkipClass(jr)){var e=this.getClass(jr);this.componentManager=new e(this.itemManager,this.syncService,this.alertService,this.environment,this.platform,this.deviceInterface.timeout),this.services.push(this.componentManager)}}},{key:"createHttpManager",value:function(){this.httpService=new Un,this.services.push(this.httpService)}},{key:"createModelManager",value:function(){this.modelManager=new Na,this.services.push(this.modelManager)}},{key:"createSingletonManager",value:function(){this.singletonManager=new Za(this.itemManager,this.syncService),this.services.push(this.singletonManager)}},{key:"createStorageManager",value:function(){this.storageService=new un(this.deviceInterface,this.namespace),this.services.push(this.storageService)}},{key:"createProtocolService",value:function(){var e=this;this.protocolService=new Ds(this.itemManager,this.modelManager,this.deviceInterface,this.storageService,this.crypto),this.protocolService.onKeyStatusChange(Ql(i.a.mark((function t(){return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.notifyEvent(c.a.KeyStatusChanged);case 2:case"end":return t.stop()}}),t)})))),this.services.push(this.protocolService)}},{key:"createSessionManager",value:function(){this.sessionManager=new _n(this.storageService,this.apiService,this.alertService,this.protocolService),this.services.push(this.sessionManager)}},{key:"createSyncManager",value:function(){var e=this;this.syncService=new Dl(this.itemManager,this.sessionManager,this.protocolService,this.storageService,this.modelManager,this.apiService,this.deviceInterface.interval);var t=function(){var t=Ql(i.a.mark((function t(n){var r;return i.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r=Object(c.c)(n))){t.next=4;break}return t.next=4,e.notifyEvent(r);case 4:return t.next=6,e.protocolService.onSyncEvent(n);case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),n=this.syncService.addEventObserver(t);this.serviceObservers.push(n),this.services.push(this.syncService)}},{key:"createChallengeService",value:function(){this.challengeService=new Ul(this.storageService,this.protocolService),this.services.push(this.challengeService)}},{key:"createPrivilegesService",value:function(){this.privilegesService=new kc(this.itemManager,this.syncService,this.singletonManager,this.protocolService,this.storageService,this.sessionManager),this.services.push(this.privilegesService)}},{key:"createHistoryManager",value:function(){this.historyManager=new oc(this.itemManager,this.storageService,[P.a.Note],this.deviceInterface.timeout),this.services.push(this.historyManager)}},{key:"createActionsManager",value:function(){this.actionsManager=new fo(this.itemManager,this.alertService,this.deviceInterface,this.httpService,this.modelManager,this.protocolService,this.syncService),this.services.push(this.actionsManager)}},{key:"shouldSkipClass",value:function(e){return this.skipClasses&&this.skipClasses.includes(e)}},{key:"getClass",value:function(e){var t=this.swapClasses&&this.swapClasses.find((function(t){return t.swap===e}));return t?t.with:e}}])&&Yl(t.prototype,n),r&&Yl(t,r),e}();function Zl(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function ef(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var tf=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.namespace=t,this.timeout=n||setTimeout.bind(Object(u.m)()),this.interval=r||setInterval.bind(Object(u.m)())}var t,n,r,a,o;return t=e,(n=[{key:"deinit",value:function(){this.timeout=null,this.interval=null}},{key:"getJsonParsedStorageValue",value:(a=i.a.mark((function e(t){var n;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getRawStorageValue(t);case 2:return n=e.sent,e.abrupt("return",n?JSON.parse(n):n);case 4:case"end":return e.stop()}}),e,this)})),o=function(){var e=this,t=arguments;return new Promise((function(n,r){var o=a.apply(e,t);function i(e){Zl(o,n,r,i,s,"next",e)}function s(e){Zl(o,n,r,i,s,"throw",e)}i(void 0)}))},function(e){return o.apply(this,arguments)})},{key:"keychainStorageKey",get:function(){return this.namespace?"".concat(this.namespace,"-").concat("keychain"):"keychain"}}])&&ef(t.prototype,n),r&&ef(t,r),e}();function nf(e,t,n,r,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,a)}function rf(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var af=function(){function e(t,n,r){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.item=n.findItem(t),r&&r(this.item),this.removeObserver=n.streamItems(this.item.content_type,function(){var e,n=(e=i.a.mark((function e(n){var o;return i.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(o=n.find((function(e){return e.uuid===t})))&&(a.item=o,r&&r(a.item));case 2:case"end":return e.stop()}}),e)})),function(){var t=this,n=arguments;return new Promise((function(r,a){var o=e.apply(t,n);function i(e){nf(o,r,a,i,s,"next",e)}function s(e){nf(o,r,a,i,s,"throw",e)}i(void 0)}))});return function(e){return n.apply(this,arguments)}}())}var t,n,r;return t=e,(n=[{key:"deinit",value:function(){this.removeObserver(),this.removeObserver=void 0}}])&&rf(t.prototype,n),r&&rf(t,r),e}(),of=n(78),sf=n(28)}])}));